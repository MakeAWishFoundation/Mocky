import Foundation
import PathKit

public enum Assets {

    public enum AllTypes {
        public static let swifttemplate: AssetFile = Files.allTypes
    }
    
    public enum MockConfiguration {
        public static let swifttemplate: AssetFile = Files.mock
    }

    public enum swifttemplate {
        public static let allTypes: AssetFile = Files.allTypes
        public static let mock: AssetFile = Files.mock
    }
}

public protocol AssetFile {

    var name: String { get }
    var data: Data { get }

    func write(to path: Path) throws
}

private struct File: AssetFile {

    let name: String
    let contents: String
    var data: Data { return Data(base64Encoded: contents) ?? Data() }

    func write(to path: Path) throws {
        try path.write(data)
    }
}

private enum Files {
    static let allTypes = File(
        name: "AllTypes.swifttemplate",
        contents: "dHlwZXM6CjwlXyB2YXIgYWxsID0gdHlwZXMuYWxsCiAgICBhbGwgKz0gdHlwZXMucHJvdG9jb2xzLm1hcCB7ICQwIH0gLSU+CjwlXyBmb3IgdHlwZSBpbiBhbGwgeyAtJT48JV8gLSU+CiAgPCVfIGxldCBhdXRvTW9ja2FibGU6IEJvb2wgPSB0eXBlLmluaGVyaXRlZFR5cGVzLmNvbnRhaW5zKCJBdXRvTW9ja2FibGUiKSB8fCB0eXBlLmFubm90YXRpb25zWyJBdXRvTW9ja2FibGUiXSAhPSBuaWwgLSU+CiAgPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgogICAgLSA8JT0gdHlwZS5uYW1lICU+CiAgPCVfIH0gLSU+CjwlXyB9IC0lPg=="
    )
    static let mock = File(
        name: "Mock.swifttemplate",
        contents: "PCVfCmZ1bmMgc3dpZnRMaW50UnVsZXMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBzdHJpbmdBcnJheShmcm9tQXJndW1lbnRzOiBhcmd1bWVudHMsIGZvcktleTogImV4Y2x1ZGVkU3dpZnRMaW50UnVsZXMiKS5tYXAgeyBydWxlIGluCiAgICAgICAgcmV0dXJuICIvL3N3aWZ0bGludDpkaXNhYmxlIFwocnVsZSkiCiAgICB9Cn0KCmZ1bmMgcHJvamVjdEltcG9ydHMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBpbXBvcnRzKGFyZ3VtZW50cykgKyB0ZXN0YWJsZUltcG9ydHMoYXJndW1lbnRzKQp9CgpmdW5jIGltcG9ydHMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBzdHJpbmdBcnJheShmcm9tQXJndW1lbnRzOiBhcmd1bWVudHMsIGZvcktleTogImltcG9ydCIpCiAgICAgICAgLm1hcCB7IHJldHVybiAiaW1wb3J0IFwoJDApIiB9Cn0KCmZ1bmMgdGVzdGFibGVJbXBvcnRzKF8gYXJndW1lbnRzOiBbU3RyaW5nOiBBbnldKSAtPiBbU3RyaW5nXSB7CiAgICByZXR1cm4gc3RyaW5nQXJyYXkoZnJvbUFyZ3VtZW50czogYXJndW1lbnRzLCBmb3JLZXk6ICJ0ZXN0YWJsZSIpCiAgICAgICAgLm1hcCB7IHJldHVybiAiQHRlc3RhYmxlIGltcG9ydCBcKCQwKSIgfQp9CgovLy8gW0ludGVybmFsXSBHZXQgdmFsdWUgZnJvbSBkaWN0aW9uYXJ5Ci8vLyAtIFBhcmFtZXRlcnM6Ci8vLyAgIC0gZnJvbUFyZ3VtZW50czogZGljdGlvbmFyeQovLy8gICAtIGZvcktleTogZGljdGlvbmFyeSBrZXkKLy8vIC0gUmV0dXJuczogYXJyYXkgb2Ygc3RyaW5ncywgaWYga2V5IG5vdCBmb3VuZCwgcmV0dXJucyBlbXB0eSBhcnJheS4KLy8vIC0gTm90ZTogSWYgc291cmNlcnkgYXJndW1lbnRzIGNvbnRhaW50cyBvbmx5IG9uZSBlbGVtZW50LCB0aGVuIHNpbmdsZSB2YWx1ZSBpcyBzdG9yZWQsIG90aGVyd2lzZSBhcnJheSBvZiBlbGVtZW50cy4gVGhpcyBtZXRob2QgYWx3YXlzIGdldHMgYXJyYXkgb2YgZWxlbWVudHMuCmZ1bmMgc3RyaW5nQXJyYXkoZnJvbUFyZ3VtZW50cyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0sIGZvcktleSBrZXk6IFN0cmluZykgLT4gW1N0cmluZ10gewoKICAgIGlmIGxldCBhcmd1bWVudCA9IGFyZ3VtZW50c1trZXldIGFzPyBTdHJpbmcgewogICAgICAgIHJldHVybiBbYXJndW1lbnRdCiAgICB9IGVsc2UgaWYgbGV0IG1hbnlBcmd1bWVudHMgPSBhcmd1bWVudHNba2V5XSBhcz8gW1N0cmluZ10gewogICAgICAgIHJldHVybiBtYW55QXJndW1lbnRzCiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbXQogICAgfQp9Cl8lPgo8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU3dpZnRMaW50IC0lPjwlXyAtJT4KPCVfIGZvciBydWxlIGluIHN3aWZ0TGludFJ1bGVzKGFyZ3VtZW50KSB7IC0lPgogICAgPCVfICU+PCU9IHJ1bGUgJT4KPCVfIH0gLSU+CjwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTd2lmdExpbnQgKGFnZ3JlZ2F0ZWQgYXJndW1lbnQpIC0lPjwlXyAtJT4KPCVfIGlmIGxldCBzd2lmdHlNb2NreUFyZ3MgPSBhcmd1bWVudFsic3dpZnR5TW9ja3kiXSBhcz8gW1N0cmluZzogQW55XSwgbGV0IHJ1bGVzID0gc3dpZnR5TW9ja3lBcmdzWyJleGNsdWRlZFN3aWZ0TGludFJ1bGVzIl0gYXM/IFtTdHJpbmddIHsgLSU+CiAgICA8JV8gZm9yIHJ1bGUgaW4gcnVsZXMgeyAtJT4KICAgIDwlXyAlPi8vc3dpZnRsaW50OmRpc2FibGUgPCU9IHJ1bGUgJT4KICAgIDwlXyB9IC0lPgo8JV8gfSAtJT4KCiNpZiBNb2NreUN1c3RvbQppbXBvcnQgU3dpZnR5TW9ja3kKPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IElNUE9SVFMgSW5BUFAgLSU+PCVfIC0lPgogICAgPCVfIGZvciBwcm9qZWN0SW1wb3J0IGluIHByb2plY3RJbXBvcnRzKGFyZ3VtZW50KSB7IC0lPgogICAgICAgIDwlXyAlPjwlPSBwcm9qZWN0SW1wb3J0ICU+CiAgICA8JV8gfSAtJT4KICAgIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09IElNUE9SVFMgSW5BUFAgKGFnZ3JlZ2F0ZWQgYXJndW1lbnQpIC0lPjwlXyAtJT4KICAgIDwlXyBpZiBsZXQgc3dpZnR5TW9ja3lBcmdzID0gYXJndW1lbnRbInN3aWZ0eU1vY2t5Il0gYXM/IFtTdHJpbmc6IEFueV0geyAtJT4KICAgICAgICA8JV8gZm9yIHByb2plY3RJbXBvcnQgaW4gaW1wb3J0cyhzd2lmdHlNb2NreUFyZ3MpIHsgLSU+CiAgICAgICAgICAgIDwlXyAlPjwlPSBwcm9qZWN0SW1wb3J0ICU+CiAgICAgICAgPCVfIH0gLSU+CiAgICA8JV8gfSAtJT4KCiAgICBwdWJsaWMgZmluYWwgY2xhc3MgTW9ja3lBc3NlcnRpb24gewogICAgICAgIHB1YmxpYyBzdGF0aWMgdmFyIGhhbmRsZXI6ICgoQm9vbCwgU3RyaW5nLCBTdGF0aWNTdHJpbmcsIFVJbnQpIC0+IFZvaWQpPwogICAgfQoKICAgIGZ1bmMgTW9ja3lBc3NlcnQoXyBleHByZXNzaW9uOiBAYXV0b2Nsb3N1cmUgKCkgLT4gQm9vbCwgXyBtZXNzYWdlOiBAYXV0b2Nsb3N1cmUgKCkgLT4gU3RyaW5nID0gIlZlcmlmaWNhdGlvbiBmYWlsZWQiLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgZ3VhcmQgbGV0IGhhbmRsZXIgPSBNb2NreUFzc2VydGlvbi5oYW5kbGVyIGVsc2UgewogICAgICAgICAgICBhc3NlcnQoZXhwcmVzc2lvbiwgbWVzc2FnZSwgZmlsZTogZmlsZSwgbGluZTogbGluZSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBoYW5kbGVyKGV4cHJlc3Npb24oKSwgbWVzc2FnZSgpLCBmaWxlLCBsaW5lKQogICAgfQojZWxzZQojaWYgY2FuSW1wb3J0KFhDVGVzdCkKaW1wb3J0IFhDVGVzdAojZW5kaWYKaW1wb3J0IFN3aWZ0eU1vY2t5CjwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBJTVBPUlRTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgcHJvamVjdEltcG9ydCBpbiBwcm9qZWN0SW1wb3J0cyhhcmd1bWVudCkgeyAtJT4KICAgICAgICA8JV8gJT48JT0gcHJvamVjdEltcG9ydCAlPgogICAgPCVfIH0gLSU+CiAgICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PSBJTVBPUlRTIEluQVBQIChhZ2dyZWdhdGVkIGFyZ3VtZW50KSAtJT48JV8gLSU+CiAgICA8JV8gaWYgbGV0IHN3aWZ0eU1vY2t5QXJncyA9IGFyZ3VtZW50WyJzd2lmdHlNb2NreSJdIGFzPyBbU3RyaW5nOiBBbnldIHsgLSU+CiAgICAgICAgPCVfIGZvciBwcm9qZWN0SW1wb3J0IGluIHByb2plY3RJbXBvcnRzKHN3aWZ0eU1vY2t5QXJncykgeyAtJT4KICAgICAgICAgICAgPCVfICU+PCU9IHByb2plY3RJbXBvcnQgJT4KICAgICAgICA8JV8gfSAtJT4KICAgIDwlXyB9IC0lPgoKICAgIGZ1bmMgTW9ja3lBc3NlcnQoXyBleHByZXNzaW9uOiBAYXV0b2Nsb3N1cmUgKCkgLT4gQm9vbCwgXyBtZXNzYWdlOiBAYXV0b2Nsb3N1cmUgKCkgLT4gU3RyaW5nID0gIlZlcmlmaWNhdGlvbiBmYWlsZWQiLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgI2lmIGNhbkltcG9ydChYQ1Rlc3QpCiAgICAgICAgWENUQXNzZXJ0KGV4cHJlc3Npb24oKSwgbWVzc2FnZSgpLCBmaWxlOiBmaWxlLCBsaW5lOiBsaW5lKQogICAgICAgICNlbHNlIAogICAgICAgIGFzc2VydChleHByZXNzaW9uKCksICJcKG1lc3NhZ2UoKSksIGZpbGU6IFwoZmlsZSksIGxpbmU6IFwobGluZSkiKQogICAgICAgICNlbmRpZgogICAgfQojZW5kaWYKPCVfCmNsYXNzIEN1cnJlbnQgewogICAgc3RhdGljIHZhciBzZWxmVHlwZTogU3RyaW5nID0gIlNlbGYiCn0KLy8gQ29sbGlzaW9uIG1hbmFnZW1lbnQKZnVuYyBhcmVUaGVyZUNvbGxpc2lvbnMoYmV0d2VlbiBtZXRob2RzOiBbTWV0aG9kV3JhcHBlcl0pIC0+IEJvb2wgewogICAgbGV0IGdpdmVuU2V0ID0gU2V0PFN0cmluZz4obWV0aG9kcy5tYXAoeyAkMC5naXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlLCBhbm5vdGF0ZWQ6IGZhbHNlKSB9KSkKICAgIGd1YXJkIGdpdmVuU2V0LmNvdW50ID09IG1ldGhvZHMuY291bnQgZWxzZSB7IHJldHVybiB0cnVlIH0gLy8gdGhlcmUgd291bGQgYmUgY29uZmxpY3RzIGluIEdpdmVuCiAgICBsZXQgdmVyaWZ5U2V0ID0gU2V0PFN0cmluZz4obWV0aG9kcy5tYXAoeyAkMC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlLCBhbm5vdGF0ZWQ6IGZhbHNlKSB9KSkKICAgIGd1YXJkIHZlcmlmeVNldC5jb3VudCA9PSBtZXRob2RzLmNvdW50IGVsc2UgeyByZXR1cm4gdHJ1ZSB9IC8vIHRoZXJlIHdvdWxkIGJlIGNvbmZsaWN0cyBpbiBWZXJpZnkKICAgIHJldHVybiBmYWxzZQp9CgovLyBoZXJscGVycwpmdW5jIHVuaXF1ZXMobWV0aG9kczogW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdKSAtPiBbU291cmNlcnlSdW50aW1lLk1ldGhvZF0gewogICAgZnVuYyByZXR1cm5UeXBlU3RyaXBwZWQoXyBtZXRob2Q6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVSYXcgPSAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUpIgogICAgICAgIHZhciBzdHJpcHBlZDogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSByZXR1cm5UeXBlUmF3LnJhbmdlKG9mOiAid2hlcmUiKSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSYXcgfQogICAgICAgICAgICB2YXIgc3RyaXBwZWQgPSByZXR1cm5UeXBlUmF3CiAgICAgICAgICAgIHN0cmlwcGVkLnJlbW92ZVN1YnJhbmdlKChyYW5nZS5sb3dlckJvdW5kKS4uLikKICAgICAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICAgICAgfSgpCiAgICAgICAgc3RyaXBwZWQgPSBzdHJpcHBlZC50cmltbWluZ0NoYXJhY3RlcnMoaW46IENoYXJhY3RlclNldChjaGFyYWN0ZXJzSW46ICIgIikpCiAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICB9CgogICAgZnVuYyBhcmVTYW1lUGFyYW1zKF8gcDE6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIsIF8gcDI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIpIC0+IEJvb2wgewogICAgICAgIGd1YXJkIHAxLmFyZ3VtZW50TGFiZWwgPT0gcDIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5uYW1lID09IHAyLm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEuYXJndW1lbnRMYWJlbCA9PSBwMi5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIHAxLnR5cGVOYW1lLm5hbWUgPT0gcDIudHlwZU5hbWUubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5hY3R1YWxUeXBlTmFtZT8ubmFtZSA9PSBwMi5hY3R1YWxUeXBlTmFtZT8ubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGZ1bmMgYXJlU2FtZU1ldGhvZHMoXyBtMTogU291cmNlcnlSdW50aW1lLk1ldGhvZCwgXyBtMjogU291cmNlcnlSdW50aW1lLk1ldGhvZCkgLT4gQm9vbCB7CiAgICAgICAgZ3VhcmQgbTEubmFtZSAhPSBtMi5uYW1lIGVsc2UgeyByZXR1cm4gbTEucmV0dXJuVHlwZU5hbWUgPT0gbTIucmV0dXJuVHlwZU5hbWUgfQogICAgICAgIGd1YXJkIG0xLnNlbGVjdG9yTmFtZSA9PSBtMi5zZWxlY3Rvck5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgbTEucGFyYW1ldGVycy5jb3VudCA9PSBtMi5wYXJhbWV0ZXJzLmNvdW50IGVsc2UgeyByZXR1cm4gZmFsc2UgfQoKICAgICAgICBsZXQgcDEgPSBtMS5wYXJhbWV0ZXJzCiAgICAgICAgbGV0IHAyID0gbTIucGFyYW1ldGVycwoKICAgICAgICBmb3IgaSBpbiAwLi48cDEuY291bnQgewogICAgICAgICAgICBpZiAhYXJlU2FtZVBhcmFtcyhwMVtpXSxwMltpXSkgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG0xLnJldHVyblR5cGVOYW1lID09IG0yLnJldHVyblR5cGVOYW1lCiAgICB9CgogICAgcmV0dXJuIG1ldGhvZHMucmVkdWNlKFtdLCB7IChyZXN1bHQsIGVsZW1lbnQpIC0+IFtTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kXSBpbgogICAgICAgIGd1YXJkICFyZXN1bHQuY29udGFpbnMod2hlcmU6IHsgYXJlU2FtZU1ldGhvZHMoJDAsZWxlbWVudCkgfSkgZWxzZSB7IHJldHVybiByZXN1bHQgfQogICAgICAgIHJldHVybiByZXN1bHQgKyBbZWxlbWVudF0KICAgIH0pCn0KCmZ1bmMgdW5pcXVlc1dpdGhvdXRHZW5lcmljQ29uc3RyYWludHMobWV0aG9kczogW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdKSAtPiBbU291cmNlcnlSdW50aW1lLk1ldGhvZF0gewogICAgZnVuYyByZXR1cm5UeXBlU3RyaXBwZWQoXyBtZXRob2Q6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVSYXcgPSAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUpIgogICAgICAgIHZhciBzdHJpcHBlZDogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSByZXR1cm5UeXBlUmF3LnJhbmdlKG9mOiAid2hlcmUiKSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSYXcgfQogICAgICAgICAgICB2YXIgc3RyaXBwZWQgPSByZXR1cm5UeXBlUmF3CiAgICAgICAgICAgIHN0cmlwcGVkLnJlbW92ZVN1YnJhbmdlKChyYW5nZS5sb3dlckJvdW5kKS4uLikKICAgICAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICAgICAgfSgpCiAgICAgICAgc3RyaXBwZWQgPSBzdHJpcHBlZC50cmltbWluZ0NoYXJhY3RlcnMoaW46IENoYXJhY3RlclNldChjaGFyYWN0ZXJzSW46ICIgIikpCiAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICB9CgogICAgZnVuYyBhcmVTYW1lUGFyYW1zKF8gcDE6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIsIF8gcDI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIpIC0+IEJvb2wgewogICAgICAgIGd1YXJkIHAxLmFyZ3VtZW50TGFiZWwgPT0gcDIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5uYW1lID09IHAyLm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEuYXJndW1lbnRMYWJlbCA9PSBwMi5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIHAxLnR5cGVOYW1lLm5hbWUgPT0gcDIudHlwZU5hbWUubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5hY3R1YWxUeXBlTmFtZT8ubmFtZSA9PSBwMi5hY3R1YWxUeXBlTmFtZT8ubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGZ1bmMgYXJlU2FtZU1ldGhvZHMoXyBtMTogU291cmNlcnlSdW50aW1lLk1ldGhvZCwgXyBtMjogU291cmNlcnlSdW50aW1lLk1ldGhvZCkgLT4gQm9vbCB7CiAgICAgICAgZ3VhcmQgbTEubmFtZSAhPSBtMi5uYW1lIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVN0cmlwcGVkKG0xKSA9PSByZXR1cm5UeXBlU3RyaXBwZWQobTIpIH0KICAgICAgICBndWFyZCBtMS5zZWxlY3Rvck5hbWUgPT0gbTIuc2VsZWN0b3JOYW1lIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIG0xLnBhcmFtZXRlcnMuY291bnQgPT0gbTIucGFyYW1ldGVycy5jb3VudCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KCiAgICAgICAgbGV0IHAxID0gbTEucGFyYW1ldGVycwogICAgICAgIGxldCBwMiA9IG0yLnBhcmFtZXRlcnMKCiAgICAgICAgZm9yIGkgaW4gMC4uPHAxLmNvdW50IHsKICAgICAgICAgICAgaWYgIWFyZVNhbWVQYXJhbXMocDFbaV0scDJbaV0pIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXR1cm5UeXBlU3RyaXBwZWQobTEpID09IHJldHVyblR5cGVTdHJpcHBlZChtMikKICAgIH0KCiAgICByZXR1cm4gbWV0aG9kcy5yZWR1Y2UoW10sIHsgKHJlc3VsdCwgZWxlbWVudCkgLT4gW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdIGluCiAgICAgICAgZ3VhcmQgIXJlc3VsdC5jb250YWlucyh3aGVyZTogeyBhcmVTYW1lTWV0aG9kcygkMCxlbGVtZW50KSB9KSBlbHNlIHsgcmV0dXJuIHJlc3VsdCB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCArIFtlbGVtZW50XQogICAgfSkKfQoKZnVuYyB1bmlxdWVzKHZhcmlhYmxlczogW1NvdXJjZXJ5UnVudGltZS5WYXJpYWJsZV0pIC0+IFtTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGVdIHsKICAgIHJldHVybiB2YXJpYWJsZXMucmVkdWNlKFtdLCB7IChyZXN1bHQsIGVsZW1lbnQpIC0+IFtTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGVdIGluCiAgICAgICAgZ3VhcmQgIXJlc3VsdC5jb250YWlucyh3aGVyZTogeyAkMC5uYW1lID09IGVsZW1lbnQubmFtZSB9KSBlbHNlIHsgcmV0dXJuIHJlc3VsdCB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCArIFtlbGVtZW50XQogICAgfSkKfQoKZnVuYyB3cmFwTWV0aG9kKF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSAtPiBNZXRob2RXcmFwcGVyIHsKICAgIHJldHVybiBNZXRob2RXcmFwcGVyKG1ldGhvZCkKfQoKZnVuYyB3cmFwU3Vic2NyaXB0KF8gd3JhcHBlZDogU291cmNlcnlSdW50aW1lLlN1YnNjcmlwdCkgLT4gU3Vic2NyaXB0V3JhcHBlciB7CiAgICByZXR1cm4gU3Vic2NyaXB0V3JhcHBlcih3cmFwcGVkKQp9CgpmdW5jIGp1c3RXcmFwKF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSkgLT4gVmFyaWFibGVXcmFwcGVyIHsgcmV0dXJuIHdyYXBQcm9wZXJ0eSh2YXJpYWJsZSkgfQpmdW5jIHdyYXBQcm9wZXJ0eShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUsIF8gc2NvcGU6IFN0cmluZyA9ICIiKSAtPiBWYXJpYWJsZVdyYXBwZXIgewogICAgcmV0dXJuIFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6IHNjb3BlKQp9CgpmdW5jIHN0dWJQcm9wZXJ0eShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUsIF8gc2NvcGU6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogc2NvcGUpCiAgICByZXR1cm4gIlwod3JhcHBlci5wcm90b3R5cGUpXG5cdFwod3JhcHBlci5wcml2YXRlUHJvdG90eXBlKSIKfQoKZnVuYyBwcm9wZXJ0eVR5cGVzKF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSkgLT4gU3RyaW5nIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogInNjb3BlIikKICAgIHJldHVybiAiXCh3cmFwcGVyLnByb3BlcnR5R2V0KCkpIiArICh3cmFwcGVyLnJlYWRvbmx5ID8gIiIgOiAiXG5cdFx0XCh3cmFwcGVyLnByb3BlcnR5U2V0KCkpIikKfQoKZnVuYyBwcm9wZXJ0eU1ldGhvZFR5cGVzKF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSkgLT4gU3RyaW5nIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogIiIpCiAgICByZXR1cm4gIlwod3JhcHBlci5wcm9wZXJ0eUNhc2VHZXQoKSkiICsgKHdyYXBwZXIucmVhZG9ubHkgPyAiIiA6ICJcblx0XHRcKHdyYXBwZXIucHJvcGVydHlDYXNlU2V0KCkpIikKfQoKZnVuYyBwcm9wZXJ0eU1ldGhvZFR5cGVzQ29tcGFyZShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICIiKQogICAgcmV0dXJuICJcKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0Q29tcGFyZSgpKSIgKyAod3JhcHBlci5yZWFkb25seSA/ICIiIDogIlxuXHRcdFx0XCh3cmFwcGVyLnByb3BlcnR5Q2FzZVNldENvbXBhcmUoKSkiKQp9CgpmdW5jIHByb3BlcnR5TWV0aG9kVHlwZXNJbnRWYWx1ZShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICIiKQogICAgcmV0dXJuICJcKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0SW50VmFsdWUoKSkiICsgKHdyYXBwZXIucmVhZG9ubHkgPyAiIiA6ICJcblx0XHRcdFwod3JhcHBlci5wcm9wZXJ0eUNhc2VTZXRJbnRWYWx1ZSgpKSIpCn0KCmZ1bmMgcHJvcGVydHlSZWdpc3RlcihfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogIiIpCiAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0TmFtZSx3cmFwcGVyLnByb3BlcnR5Q2FzZUdldE5hbWUsd3JhcHBlci5wcm9wZXJ0eUNhc2VHZXROYW1lKQogICAgZ3VhcmQgIXdyYXBwZXIucmVhZG9ubHkgZWxzZSB7IHJldHVybiB9CiAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyKHdyYXBwZXIucHJvcGVydHlDYXNlU2V0TmFtZSx3cmFwcGVyLnByb3BlcnR5Q2FzZVNldE5hbWUsd3JhcHBlci5wcm9wZXJ0eUNhc2VHZXROYW1lKQp9CmNsYXNzIEhlbHBlcnMgewogICAgc3RhdGljIGZ1bmMgc3BsaXQoXyBzdHJpbmc6IFN0cmluZywgYnlGaXJzdE9jY3VyZW5jZU9mIHdvcmQ6IFN0cmluZykgLT4gKFN0cmluZywgU3RyaW5nKSB7CiAgICAgICAgZ3VhcmQgbGV0IHdvcmRSYW5nZSA9IHN0cmluZy5yYW5nZShvZjogd29yZCkgZWxzZSB7IHJldHVybiAoc3RyaW5nLCAiIikgfQogICAgICAgIGxldCBzZWxmUmFuZ2UgPSBzdHJpbmcucmFuZ2Uob2Y6IHN0cmluZykhCiAgICAgICAgbGV0IGJlZm9yZSA9IFN0cmluZyhzdHJpbmdbc2VsZlJhbmdlLmxvd2VyQm91bmQuLjx3b3JkUmFuZ2UubG93ZXJCb3VuZF0pCiAgICAgICAgbGV0IGFmdGVyID0gU3RyaW5nKHN0cmluZ1t3b3JkUmFuZ2UudXBwZXJCb3VuZC4uPHNlbGZSYW5nZS51cHBlckJvdW5kXSkKICAgICAgICByZXR1cm4gKGJlZm9yZSwgYWZ0ZXIpCiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0QXNzb2NpYXRlZFR5cGVzKGZyb20gYW5ub3RhdGVkOiBTb3VyY2VyeVJ1bnRpbWUuQW5ub3RhdGVkKSAtPiBbU3RyaW5nXT8gewogICAgICAgIGlmIGxldCB0eXBlcyA9IGFubm90YXRlZC5hbm5vdGF0aW9uc1siYXNzb2NpYXRlZHR5cGUiXSBhcz8gW1N0cmluZ10gewogICAgICAgICAgICByZXR1cm4gdHlwZXMucmV2ZXJzZWQoKQogICAgICAgIH0gZWxzZSBpZiBsZXQgdHlwZSA9IGFubm90YXRlZC5hbm5vdGF0aW9uc1siYXNzb2NpYXRlZHR5cGUiXSBhcz8gU3RyaW5nIHsKICAgICAgICAgICAgcmV0dXJuIFt0eXBlXQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuaWwKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0R2VuZXJpY3NMaXN0KF8gYXNzb2NpYXRlZFR5cGVzOiBbU3RyaW5nXT8pIC0+IFtTdHJpbmddIHsKICAgICAgICByZXR1cm4gYXNzb2NpYXRlZFR5cGVzPy5mbGF0TWFwIHsKICAgICAgICAgICAgc3BsaXQoJDAsIGJ5Rmlyc3RPY2N1cmVuY2VPZjogIiB3aGVyZSAiKS4wLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiICIsIHdpdGg6ICIiKS5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIjoiKS5tYXAoU3RyaW5nLmluaXQpLmZpcnN0CiAgICAgICAgICAgIH0ubWFwIHsgIlwoJDApIiB9ID8/IFtdCiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0R2VuZXJpY1R5cGVzTW9kaWZpZXIoXyBhc3NvY2lhdGVkVHlwZXM6IFtTdHJpbmddPykgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgYWxsID0gZXh0cmFjdEdlbmVyaWNzTGlzdChhc3NvY2lhdGVkVHlwZXMpCiAgICAgICAgZ3VhcmQgIWFsbC5pc0VtcHR5IGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIHJldHVybiAiPFwoYWxsLmpvaW5lZChzZXBhcmF0b3I6ICIsIikpPiIKICAgIH0KICAgIHN0YXRpYyBmdW5jIGV4dHJhY3RHZW5lcmljVHlwZXNDb25zdHJhaW50cyhfIGFzc29jaWF0ZWRUeXBlczogW1N0cmluZ10/KSAtPiBTdHJpbmcgewogICAgICAgIGd1YXJkIGxldCBhbGwgPSBhc3NvY2lhdGVkVHlwZXMgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgbGV0IGNvbnN0cmFpbnRzID0gYWxsLmZsYXRNYXAgeyB0IC0+IFN0cmluZz8gaW4KICAgICAgICAgICAgbGV0IHNwbGl0dGVkID0gc3BsaXQodCwgYnlGaXJzdE9jY3VyZW5jZU9mOiAiIHdoZXJlICIpCiAgICAgICAgICAgIGxldCBjb25zdHJhaW50ID0gc3BsaXR0ZWQuMC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiAiLCB3aXRoOiAiIikuY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICI6IikubWFwKFN0cmluZy5pbml0KQogICAgICAgICAgICBndWFyZCBjb25zdHJhaW50LmNvdW50ID09IDIgZWxzZSB7IHJldHVybiBuaWwgfQogICAgICAgICAgICBsZXQgYWRvcHRzID0gY29uc3RyYWludFsxXS5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIiwiKS5tYXAoU3RyaW5nLmluaXQpCiAgICAgICAgICAgIHZhciBtYXBwZWQgPSBhZG9wdHMubWFwIHsgIlwoY29uc3RyYWludFswXSk6IFwoJDApIiB9CiAgICAgICAgICAgIGlmICFzcGxpdHRlZC4xLmlzRW1wdHkgewogICAgICAgICAgICAgICAgbWFwcGVkLmFwcGVuZChzcGxpdHRlZC4xKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXBwZWQuam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICAgICAgfQogICAgICAgICAgICAuam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICBndWFyZCAhY29uc3RyYWludHMuaXNFbXB0eSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIiB3aGVyZSBcKGNvbnN0cmFpbnRzKSIKICAgIH0KfQpjbGFzcyBQYXJhbWV0ZXJXcmFwcGVyIHsKICAgIGxldCBwYXJhbWV0ZXI6IE1ldGhvZFBhcmFtZXRlcgoKICAgIHZhciB3cmFwcGVkRm9yQ2FsbDogU3RyaW5nIHsKICAgICAgICBsZXQgdHlwZVN0cmluZyA9ICJcKHR5cGUuYWN0dWFsVHlwZU5hbWUgPz8gdHlwZSkiCiAgICAgICAgbGV0IGlzRXNjYXBpbmcgPSB0eXBlU3RyaW5nLmNvbnRhaW5zKCJAZXNjYXBpbmciKQogICAgICAgIGxldCBpc09wdGlvbmFsID0gKHR5cGUuYWN0dWFsVHlwZU5hbWUgPz8gdHlwZSkuaXNPcHRpb25hbAogICAgICAgIGlmIHBhcmFtZXRlci5pc0Nsb3N1cmUgJiYgIWlzRXNjYXBpbmcgJiYgIWlzT3B0aW9uYWwgewogICAgICAgICAgICByZXR1cm4gIlwobmVzdGVkVHlwZSkuYW55IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXChuZXN0ZWRUeXBlKS52YWx1ZShcKGVzY2FwZWROYW1lKSkiCiAgICAgICAgfQogICAgfQogICAgdmFyIHdyYXBwZWRUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiUGFyYW1ldGVyPFwoVHlwZVdyYXBwZXIodHlwZSkuc3RyaXBwZWQpPiIKICAgIH0KICAgIHZhciBuZXN0ZWRUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChUeXBlV3JhcHBlcih0eXBlKS5uZXN0ZWRQYXJhbWV0ZXIpIgogICAgfQogICAgdmFyIGp1c3RUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChUeXBlV3JhcHBlcih0eXBlKS5yZXBsYWNpbmdTZWxmKCkpIgogICAgfQogICAgdmFyIGp1c3RQZXJmb3JtVHlwZTogU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwoVHlwZVdyYXBwZXIodHlwZSkucmVwbGFjaW5nU2VsZigpKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIhIiwgd2l0aDogIj8iKQogICAgfQogICAgdmFyIGdlbmVyaWNUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiUGFyYW1ldGVyPEdlbmVyaWNBdHRyaWJ1dGU+IgogICAgfQogICAgdmFyIHR5cGU6IFNvdXJjZXJ5UnVudGltZS5UeXBlTmFtZSB7CiAgICAgICAgcmV0dXJuIHBhcmFtZXRlci50eXBlTmFtZQogICAgfQogICAgdmFyIG5hbWU6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHBhcmFtZXRlci5uYW1lCiAgICB9CiAgICB2YXIgZXNjYXBlZE5hbWU6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJgXChwYXJhbWV0ZXIubmFtZSlgIgogICAgfQogICAgdmFyIGNvbXBhcmF0b3I6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJndWFyZCBQYXJhbWV0ZXIuY29tcGFyZShsaHM6IGxoc1wocGFyYW1ldGVyLm5hbWUuY2FwaXRhbGl6ZWQpLCByaHM6IHJoc1wocGFyYW1ldGVyLm5hbWUuY2FwaXRhbGl6ZWQpLCB3aXRoOiBtYXRjaGVyKSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0iCiAgICB9CgogICAgaW5pdChfIHBhcmFtZXRlcjogU291cmNlcnlSdW50aW1lLk1ldGhvZFBhcmFtZXRlcikgewogICAgICAgIHNlbGYucGFyYW1ldGVyID0gcGFyYW1ldGVyCiAgICB9CgogICAgZnVuYyBpc0dlbmVyaWMoXyB0eXBlczogW1N0cmluZ10pIC0+IEJvb2wgewogICAgICAgIHJldHVybiBUeXBlV3JhcHBlcih0eXBlKS5pc0dlbmVyaWModHlwZXMpCiAgICB9CgogICAgZnVuYyB3cmFwcGVkRm9yUHJveHkoXyBnZW5lcmljczogW1N0cmluZ10pIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIGlzR2VuZXJpYyhnZW5lcmljcykgPyAiXChlc2NhcGVkTmFtZSkud3JhcEFzR2VuZXJpYygpIiA6ICJcKGVzY2FwZWROYW1lKSIKICAgIH0KICAgIGZ1bmMgd3JhcHBlZEZvckNhbGxzKF8gZ2VuZXJpY3M6IFtTdHJpbmddKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiBpc0dlbmVyaWMoZ2VuZXJpY3MpID8gIlwod3JhcHBlZEZvckNhbGwpLndyYXBBc0dlbmVyaWMoKSIgOiAiXCh3cmFwcGVkRm9yQ2FsbCkiCiAgICB9CgogICAgZnVuYyBhc01ldGhvZEFyZ3VtZW50KCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwocGFyYW1ldGVyLmFyZ3VtZW50TGFiZWwgPz8gIl8iKSBcKHBhcmFtZXRlci5uYW1lKTogXChwYXJhbWV0ZXIudHlwZU5hbWUpIgogICAgfQogICAgZnVuYyBsYWJlbEFuZE5hbWUoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBsYWJlbCA9IHBhcmFtZXRlci5hcmd1bWVudExhYmVsID8/ICJfIgogICAgICAgIHJldHVybiBsYWJlbCAhPSAiXChwYXJhbWV0ZXIubmFtZSkiID8gIlwobGFiZWwpIFwocGFyYW1ldGVyLm5hbWUpIiA6IGxhYmVsCiAgICB9CiAgICBmdW5jIHNhbml0aXplZEZvckVudW1DYXNlTmFtZSgpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbGV0IGxhYmVsID0gcGFyYW1ldGVyLmFyZ3VtZW50TGFiZWwgewogICAgICAgICAgICByZXR1cm4gIlwobGFiZWwpX1wocGFyYW1ldGVyLm5hbWUpIi5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwocGFyYW1ldGVyLm5hbWUpIi5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikKICAgICAgICB9CiAgICB9Cn0KY2xhc3MgVHlwZVdyYXBwZXIgewogICAgbGV0IHR5cGU6IFNvdXJjZXJ5UnVudGltZS5UeXBlTmFtZQoKICAgIHZhciB1bndyYXBwZWQ6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHR5cGUudW53cmFwcGVkVHlwZU5hbWUKICAgIH0KICAgIHZhciB1bndyYXBwZWRSZXBsYWNpbmdTZWxmOiBTdHJpbmcgewogICAgICAgIHJldHVybiByZXBsYWNpbmdTZWxmKHVud3JhcDogdHJ1ZSkKICAgIH0KICAgIHZhciBzdHJpcHBlZDogU3RyaW5nIHsKICAgICAgICBpZiB0eXBlLmlzSW1wbGljaXRseVVud3JhcHBlZE9wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuaXNDbG9zdXJlID8gIihcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpKT8iIDogIlwodW53cmFwcGVkUmVwbGFjaW5nU2VsZik/IgogICAgICAgIH0gZWxzZSBpZiB0eXBlLmlzT3B0aW9uYWwgewogICAgICAgICAgICByZXR1cm4gdHlwZS5pc0Nsb3N1cmUgPyAiKFwodW53cmFwcGVkUmVwbGFjaW5nU2VsZikpPyIgOiAiXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKT8iCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVud3JhcHBlZFJlcGxhY2luZ1NlbGYKICAgICAgICB9CiAgICB9CiAgICB2YXIgbmVzdGVkUGFyYW1ldGVyOiBTdHJpbmcgewogICAgICAgIGlmIHR5cGUuaXNJbXBsaWNpdGx5VW53cmFwcGVkT3B0aW9uYWwgewogICAgICAgICAgICByZXR1cm4gIlBhcmFtZXRlcjwiICsgKHR5cGUuaXNDbG9zdXJlID8gIihcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpKT8iIDogIlwodW53cmFwcGVkUmVwbGFjaW5nU2VsZik/IikgKyAiPiIKICAgICAgICB9IGVsc2UgaWYgdHlwZS5pc09wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuICJQYXJhbWV0ZXI8IiArICh0eXBlLmlzQ2xvc3VyZSA/ICIoXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKSk/IiA6ICJcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpPyIpICsgIj4iCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJQYXJhbWV0ZXI8XCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKT4iCiAgICAgICAgfQogICAgfQogICAgdmFyIGlzU2VsZlR5cGU6IEJvb2wgewogICAgICAgIHJldHVybiB1bndyYXBwZWQgPT0gIlNlbGYiCiAgICB9CiAgICBmdW5jIGlzU2VsZlR5cGVSZWN1cnNpdmUoKSAtPiBCb29sIHsKICAgICAgICBpZiBsZXQgdHVwbGUgPSB0eXBlLnR1cGxlIHsKICAgICAgICAgICAgZm9yIGVsZW1lbnQgaW4gdHVwbGUuZWxlbWVudHMgewogICAgICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKGVsZW1lbnQudHlwZU5hbWUpLmlzU2VsZlR5cGVSZWN1cnNpdmUoKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIGxldCBhcnJheSA9IHR5cGUuYXJyYXkgewogICAgICAgICAgICByZXR1cm4gVHlwZVdyYXBwZXIoYXJyYXkuZWxlbWVudFR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkKICAgICAgICB9IGVsc2UgaWYgbGV0IGRpY3Rpb25hcnkgPSB0eXBlLmRpY3Rpb25hcnkgewogICAgICAgICAgICBndWFyZCAhVHlwZVdyYXBwZXIoZGljdGlvbmFyeS52YWx1ZVR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKGRpY3Rpb25hcnkua2V5VHlwZU5hbWUpLmlzU2VsZlR5cGVSZWN1cnNpdmUoKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIH0gZWxzZSBpZiBsZXQgY2xvc3VyZSA9IHR5cGUuY2xvc3VyZSB7CiAgICAgICAgICAgIGd1YXJkICFUeXBlV3JhcHBlcihjbG9zdXJlLmFjdHVhbFJldHVyblR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgICAgZm9yIHBhcmFtZXRlciBpbiBjbG9zdXJlLnBhcmFtZXRlcnMgewogICAgICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKHBhcmFtZXRlci50eXBlTmFtZSkuaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpIGVsc2UgeyByZXR1cm4gdHJ1ZSB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1NlbGZUeXBlCiAgICB9CgogICAgaW5pdChfIHR5cGU6IFNvdXJjZXJ5UnVudGltZS5UeXBlTmFtZSkgewogICAgICAgIHNlbGYudHlwZSA9IHR5cGUKICAgIH0KCiAgICBmdW5jIGlzR2VuZXJpYyhfIHR5cGVzOiBbU3RyaW5nXSkgLT4gQm9vbCB7CiAgICAgICAgZ3VhcmQgIXR5cGUuaXNWb2lkIGVsc2UgeyByZXR1cm4gZmFsc2UgfQoKICAgICAgICByZXR1cm4gaXNHZW5lcmljKG5hbWU6IHVud3JhcHBlZCwgZ2VuZXJpY3M6IHR5cGVzKQogICAgfQoKICAgIHByaXZhdGUgZnVuYyBpc0dlbmVyaWMobmFtZTogU3RyaW5nLCBnZW5lcmljczogW1N0cmluZ10pIC0+IEJvb2wgewogICAgICAgIGxldCBuYW1lID0gIihcKG5hbWUucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpKSkiCiAgICAgICAgbGV0IG1vZGlmaWVycyA9ICJbXFw/XFwhXSoiCiAgICAgICAgcmV0dXJuIGdlbmVyaWNzLmNvbnRhaW5zKHdoZXJlOiB7IGdlbmVyaWMgaW4KICAgICAgICAgICAgbGV0IHdyYXBwZWQgPSAiKFtcXChdXChnZW5lcmljKVwobW9kaWZpZXJzKVtcXClcXC5dKSIKICAgICAgICAgICAgbGV0IGNvbnN0cmFpbnQgPSAiKFs8LF1cKGdlbmVyaWMpXChtb2RpZmllcnMpWz4sXFwuXSkiCiAgICAgICAgICAgIGxldCBhcnJheXMgPSAiKFtcXFs6XVwoZ2VuZXJpYylcKG1vZGlmaWVycylbXFxdLFxcLjpdKSIKICAgICAgICAgICAgbGV0IHR1cGxlcyA9ICIoW1xcKCxdXChnZW5lcmljKVwobW9kaWZpZXJzKVssXFwuXFwpXSkiCiAgICAgICAgICAgIGxldCBjbG9zdXJlcyA9ICIoKFxcLVxcPilcKGdlbmVyaWMpXChtb2RpZmllcnMpWyxcXC5cXCldKSIKICAgICAgICAgICAgbGV0IHBhdHRlcm4gPSAiXCh3cmFwcGVkKXxcKGNvbnN0cmFpbnQpfFwoYXJyYXlzKXxcKHR1cGxlcyl8XChjbG9zdXJlcykiCiAgICAgICAgICAgIGd1YXJkIGxldCByZWdleCA9IHRyeT8gTlNSZWd1bGFyRXhwcmVzc2lvbihwYXR0ZXJuOiBwYXR0ZXJuKSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICAgICAgcmV0dXJuIHJlZ2V4LmZpcnN0TWF0Y2goaW46IG5hbWUsIG9wdGlvbnM6IFtdLCByYW5nZTogTlNSYW5nZShsb2NhdGlvbjogMCwgbGVuZ3RoOiAobmFtZSBhcyBOU1N0cmluZykubGVuZ3RoKSkgIT0gbmlsCiAgICAgICAgfSkKICAgIH0KCiAgICBmdW5jIHJlcGxhY2luZ1NlbGYodW53cmFwOiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpIGVsc2UgewogICAgICAgICAgICByZXR1cm4gdW53cmFwID8gc2VsZi51bndyYXBwZWQgOiAiXCh0eXBlKSIKICAgICAgICB9CgogICAgICAgIGlmIGlzU2VsZlR5cGUgewogICAgICAgICAgICBsZXQgb3B0aW9uYWxpdHk6IFN0cmluZyA9IHsKICAgICAgICAgICAgICAgIGlmIHR5cGUuaXNJbXBsaWNpdGx5VW53cmFwcGVkT3B0aW9uYWwgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiISIKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiB0eXBlLmlzT3B0aW9uYWwgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiPyIKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0oKQogICAgICAgICAgICByZXR1cm4gdW53cmFwID8gQ3VycmVudC5zZWxmVHlwZSA6IEN1cnJlbnQuc2VsZlR5cGUgKyBvcHRpb25hbGl0eQogICAgICAgIH0gZWxzZSBpZiBsZXQgdHVwbGUgPSB0eXBlLnR1cGxlIHsKICAgICAgICAgICAgbGV0IGlubmVyID0gdHVwbGUuZWxlbWVudHMubWFwKHsgVHlwZVdyYXBwZXIoJDAudHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKSB9KS5qb2luZWQoc2VwYXJhdG9yOiAiLCIpCiAgICAgICAgICAgIGxldCB2YWx1ZSA9ICIoXChpbm5lcikpIgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB9IGVsc2UgaWYgbGV0IGFycmF5ID0gdHlwZS5hcnJheSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9ICJbXChUeXBlV3JhcHBlcihhcnJheS5lbGVtZW50VHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKSldIgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB9IGVsc2UgaWYgbGV0IGRpY3Rpb25hcnkgPSB0eXBlLmRpY3Rpb25hcnkgewogICAgICAgICAgICBsZXQgdmFsdWUgPSAiWyIgKwogICAgICAgICAgICAgICAgIlwoVHlwZVdyYXBwZXIoZGljdGlvbmFyeS52YWx1ZVR5cGVOYW1lKS5yZXBsYWNpbmdTZWxmKCkpIgogICAgICAgICAgICAgICAgKyAiOiIgKwogICAgICAgICAgICAgICAgIlwoVHlwZVdyYXBwZXIoZGljdGlvbmFyeS5rZXlUeXBlTmFtZSkucmVwbGFjaW5nU2VsZigpKSIKICAgICAgICAgICAgICAgICsgIl0iCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIH0gZWxzZSBpZiBsZXQgY2xvc3VyZSA9IHR5cGUuY2xvc3VyZSB7CiAgICAgICAgICAgIGxldCByZXR1cm5UeXBlID0gVHlwZVdyYXBwZXIoY2xvc3VyZS5hY3R1YWxSZXR1cm5UeXBlTmFtZSkucmVwbGFjaW5nU2VsZigpCiAgICAgICAgICAgIGxldCBpbm5lciA9IGNsb3N1cmUucGFyYW1ldGVycy5tYXAoeyBUeXBlV3JhcHBlcigkMC50eXBlTmFtZSkucmVwbGFjaW5nU2VsZigpIH0pLmpvaW5lZChzZXBhcmF0b3I6ICIsIikKICAgICAgICAgICAgbGV0IHRocm93aW5nID0gY2xvc3VyZS50aHJvd3MgPyAidGhyb3dzICIgOiAiIgogICAgICAgICAgICBsZXQgdmFsdWUgPSAiKFwoaW5uZXIpKSBcKHRocm93aW5nKS0+IFwocmV0dXJuVHlwZSkiCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHVud3JhcCA/IHNlbGYudW53cmFwcGVkIDogIlwodHlwZSkiCiAgICB9Cn0KY2xhc3MgTWV0aG9kV3JhcHBlciB7CiAgICBwcml2YXRlIGZ1bmMgZGVwcmVjYXRlZE1lc3NhZ2UoXyBwcmVmZXJyZWQ6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiQGF2YWlsYWJsZSgqLCBkZXByZWNhdGVkLCBtZXNzYWdlOiBcIlRoaXMgY29uc3RydWN0b3IgaXMgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB2My4xXChwcmVmZXJyZWQpXCIpXG5cdFx0IgogICAgfQogICAgcHJpdmF0ZSB2YXIgbm9TdHViRGVmaW5lZE1lc3NhZ2U6IFN0cmluZyB7IHJldHVybiAiU3R1YiByZXR1cm4gdmFsdWUgbm90IHNwZWNpZmllZCBmb3IgXChtZXRob2QubmFtZSkuIFVzZSBnaXZlbiIgfQoKICAgIHByaXZhdGUgc3RhdGljIHZhciByZWdpc3RlcmVkOiBbU3RyaW5nOiBJbnRdID0gWzpdCiAgICBwcml2YXRlIHN0YXRpYyB2YXIgc3VmZml4ZXM6IFtTdHJpbmc6IEludF0gPSBbOl0KICAgIHByaXZhdGUgc3RhdGljIHZhciBzdWZmaXhlc1dpdGhvdXRSZXR1cm5UeXBlOiBbU3RyaW5nOiBJbnRdID0gWzpdCgogICAgbGV0IG1ldGhvZDogU291cmNlcnlSdW50aW1lLk1ldGhvZAogICAgdmFyIGFjY2Vzc01vZGlmaWVyOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNTdGF0aWMgZWxzZSB7IHJldHVybiAicHVibGljIHN0YXRpYyIgfQogICAgICAgIGd1YXJkICFyZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmIGVsc2UgeyByZXR1cm4gInB1YmxpYyIgfQogICAgICAgIHJldHVybiAib3BlbiIKICAgIH0KCiAgICBwcml2YXRlIHZhciByZWdpc3RyYXRpb25OYW1lOiBTdHJpbmcgewogICAgICAgIHZhciByYXdOYW1lID0gKG1ldGhvZC5pc1N0YXRpYyA/ICJzbSpcKG1ldGhvZC5zZWxlY3Rvck5hbWUpIiA6ICJtKlwobWV0aG9kLnNlbGVjdG9yTmFtZSkiKQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIl8iLCB3aXRoOiAiIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoIiwgd2l0aDogIl9fIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIpIiwgd2l0aDogIiIpCgogICAgICAgIHZhciBwYXJhbWV0ZXJzTmFtZXMgPSBtZXRob2QucGFyYW1ldGVycy5tYXAgeyAiXCgkMC5uYW1lKSIgfQoKICAgICAgICB3aGlsZSBsZXQgcmFuZ2UgPSByYXdOYW1lLnJhbmdlKG9mOiAiOiIpLCBsZXQgbmFtZSA9IHBhcmFtZXRlcnNOYW1lcy5maXJzdCB7CiAgICAgICAgICAgIHBhcmFtZXRlcnNOYW1lcy5yZW1vdmVGaXJzdCgpCiAgICAgICAgICAgIHJhd05hbWUucmVwbGFjZVN1YnJhbmdlKHJhbmdlLCB3aXRoOiAiX1wobmFtZSkiKQogICAgICAgIH0KCiAgICAgICAgbGV0IHRyaW1TZXQgPSBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiXyIpCgogICAgICAgIHJldHVybiAgcmF3TmFtZQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIjoiLCB3aXRoOiAiIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJtKiIsIHdpdGg6ICJtXyIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiX19fIiwgd2l0aDogIl9fIikudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiB0cmltU2V0KQogICAgfQogICAgcHJpdmF0ZSB2YXIgdW5pcXVlTmFtZTogU3RyaW5nIHsKICAgICAgICB2YXIgcmF3TmFtZSA9IChtZXRob2QuaXNTdGF0aWMgPyAic21fXChtZXRob2Quc2VsZWN0b3JOYW1lKSIgOiAibV9cKG1ldGhvZC5zZWxlY3Rvck5hbWUpIikKICAgICAgICB2YXIgcGFyYW1ldGVyc05hbWVzID0gbWV0aG9kLnBhcmFtZXRlcnMubWFwIHsgIlwoJDAubmFtZSlfb2ZfXCgkMC50eXBlTmFtZS5uYW1lKSIgfQoKICAgICAgICB3aGlsZSBsZXQgcmFuZ2UgPSByYXdOYW1lLnJhbmdlKG9mOiAiOiIpLCBsZXQgbmFtZSA9IHBhcmFtZXRlcnNOYW1lcy5maXJzdCB7CiAgICAgICAgICAgIHBhcmFtZXRlcnNOYW1lcy5yZW1vdmVGaXJzdCgpCiAgICAgICAgICAgIHJhd05hbWUucmVwbGFjZVN1YnJhbmdlKHJhbmdlLCB3aXRoOiAiX1wobmFtZSkiKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhd05hbWUudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiXyIpKQogICAgfQogICAgcHJpdmF0ZSB2YXIgdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlOiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwobWV0aG9kLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgcmV0dXJuVHlwZVN0cmlwcGVkOiBTdHJpbmcgPSB7CiAgICAgICAgICAgIGd1YXJkIGxldCByYW5nZSA9IHJldHVyblR5cGVSYXcucmFuZ2Uob2Y6ICJ3aGVyZSIpIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVJhdyB9CiAgICAgICAgICAgIHZhciBzdHJpcHBlZCA9IHJldHVyblR5cGVSYXcKICAgICAgICAgICAgc3RyaXBwZWQucmVtb3ZlU3VicmFuZ2UoKHJhbmdlLmxvd2VyQm91bmQpLi4uKQogICAgICAgICAgICByZXR1cm4gc3RyaXBwZWQKICAgICAgICB9KCkKICAgICAgICByZXR1cm5UeXBlU3RyaXBwZWQgPSByZXR1cm5UeXBlU3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIHJldHVybiAiXCh1bmlxdWVOYW1lKS0+XChyZXR1cm5UeXBlU3RyaXBwZWQpIgogICAgfQogICAgcHJpdmF0ZSB2YXIgbmFtZVN1ZmZpeDogU3RyaW5nIHsKICAgICAgICBndWFyZCBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbcmVnaXN0cmF0aW9uTmFtZV0gZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgY291bnQgPiAxIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIGxldCBpbmRleCA9IE1ldGhvZFdyYXBwZXIuc3VmZml4ZXNbdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlXSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIl9cKGluZGV4KSIKICAgIH0KCiAgICB2YXIgcHJvdG90eXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChyZWdpc3RyYXRpb25OYW1lKVwobmFtZVN1ZmZpeCkiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiYCIsIHdpdGg6ICIiKQogICAgfQogICAgdmFyIHBhcmFtZXRlcnM6IFtQYXJhbWV0ZXJXcmFwcGVyXSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5wYXJhbWV0ZXJzLm1hcCB7IFBhcmFtZXRlcldyYXBwZXIoJDApIH0KICAgIH0KICAgIHZhciBmdW5jdGlvblByb3RvdHlwZTogU3RyaW5nIHsKICAgICAgICBsZXQgdGhyb3dpbmc6IFN0cmluZyA9IHsKICAgICAgICAgICAgaWYgbWV0aG9kLnRocm93cyB7CiAgICAgICAgICAgICAgICByZXR1cm4gInRocm93cyAiCiAgICAgICAgICAgIH0gZWxzZSBpZiBtZXRob2QucmV0aHJvd3MgewogICAgICAgICAgICAgICAgcmV0dXJuICJyZXRocm93cyAiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgfQogICAgICAgIH0oKQoKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXI6IFN0cmluZyA9ICJcKGFjY2Vzc01vZGlmaWVyKSAiCiAgICAgICAgaWYgbWV0aG9kLmlzSW5pdGlhbGl6ZXIgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyByZXF1aXJlZCBcKG1ldGhvZC5uYW1lKSBcKHRocm93aW5nKSIKICAgICAgICB9IGVsc2UgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCB7CiAgICAgICAgICAgIGxldCB3aGVyZVBhcnRJZk5lZWRlZDogU3RyaW5nID0gewogICAgICAgICAgICAgICAgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUuaGFzUHJlZml4KCJWb2lkIikgewogICAgICAgICAgICAgICAgICAgIGxldCByYW5nZSA9IG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lLnJhbmdlKG9mOiAiVm9pZCIpIQogICAgICAgICAgICAgICAgICAgIHJldHVybiAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUubmFtZVtyYW5nZS51cHBlckJvdW5kLi4uXSkiCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhbWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUuaXNFbXB0eSA/ICJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lKSAiIDogIiIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSgpCiAgICAgICAgICAgIHJldHVybiAiXChzdGF0aWNNb2RpZmllcilmdW5jIFwobWV0aG9kLnNob3J0TmFtZSlcKHBhcmFtZXRlcnNGb3JTdHViU2lnbmF0dXJlKCkpIFwodGhyb3dpbmcpXCh3aGVyZVBhcnRJZk5lZWRlZCkiCiAgICAgICAgfSBlbHNlIGlmIHJldHVybnNHZW5lcmljQ29uc3RyYWluZWRUb1NlbGYgewogICAgICAgICAgICByZXR1cm4gIlwoc3RhdGljTW9kaWZpZXIpZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpXChwYXJhbWV0ZXJzRm9yU3R1YlNpZ25hdHVyZSgpKSBcKHRocm93aW5nKS0+IFwocmV0dXJuVHlwZVJlcGxhY2luZ1NlbGYpICIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwoc3RhdGljTW9kaWZpZXIpZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpXChwYXJhbWV0ZXJzRm9yU3R1YlNpZ25hdHVyZSgpKSBcKHRocm93aW5nKS0+IFwobWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUpICIKICAgICAgICB9CiAgICB9CiAgICB2YXIgaW52b2NhdGlvbjogU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiYWRkSW52b2NhdGlvbiguXChwcm90b3R5cGUpKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gImFkZEludm9jYXRpb24oLlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkpKSkiCiAgICAgICAgfQogICAgfQogICAgdmFyIGdpdmVuVmFsdWU6IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIG1ldGhvZC50aHJvd3MgfHwgIW1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgIGxldCBtZXRob2RUeXBlID0gbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSA/ICIuXChwcm90b3R5cGUpIiA6ICIuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoKSkpIgogICAgICAgIGxldCByZXR1cm5UeXBlOiBTdHJpbmcgPSByZXR1cm5zU2VsZiA/ICJfX1NlbGZfXyIgOiAiXChUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkKSIKCiAgICAgICAgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCB7CiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgXG5cdFx0ZG8gewogICAgICAgICAgICBcdFx0ICAgIF8gPSB0cnkgbWV0aG9kUmV0dXJuVmFsdWUoXChtZXRob2RUeXBlKSkuY2FzdGVkKCkgYXMgVm9pZAogICAgICAgICAgICBcdFx0fVwoIiAiKQogICAgICAgICAgICAiIiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzT3B0aW9uYWwgPyAiID0gbmlsIiA6ICIiCiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgXG5cdFx0dmFyIF9fdmFsdWU6IFwocmV0dXJuVHlwZSlcKGRlZmF1bHRWYWx1ZSkKICAgICAgICAgICAgXHRcdGRvIHsKICAgICAgICAgICAgXHRcdCAgICBfX3ZhbHVlID0gdHJ5IG1ldGhvZFJldHVyblZhbHVlKFwobWV0aG9kVHlwZSkpLmNhc3RlZCgpCiAgICAgICAgICAgIFx0XHR9XCgiICIpCiAgICAgICAgICAgICIiIgogICAgICAgIH0KICAgIH0KICAgIHZhciB0aHJvd1ZhbHVlOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNJbml0aWFsaXplciBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICBndWFyZCBtZXRob2QudGhyb3dzIHx8ICFtZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCBzYWZlRmFpbHVyZSA9IG1ldGhvZC5pc1N0YXRpYyA/ICIiIDogIlx0XHRcdG9uRmF0YWxGYWlsdXJlKFwiXChub1N0dWJEZWZpbmVkTWVzc2FnZSlcIilcbiIKICAgICAgICAvLyBGb3IgVm9pZCBhbmQgUmV0dXJuaW5nIG9wdGlvbmFscyAtIHdlIGFsbG93IG5vdCBzdHViYmVkIGNhc2UgdG8gaGFwcGVuLCBhcyB3ZSBhcmUgc3RpbGwgYWJsZSB0byByZXR1cm4KICAgICAgICBsZXQgbm9TdHViSGFuZGxpbmcgPSBtZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkIHx8IG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc09wdGlvbmFsID8gIlx0XHRcdC8vIGRvIG5vdGhpbmciIDogIlwoc2FmZUZhaWx1cmUpXHRcdFx0RmFpbHVyZShcIlwobm9TdHViRGVmaW5lZE1lc3NhZ2UpXCIpIgogICAgICAgIGd1YXJkIG1ldGhvZC50aHJvd3MgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICBcKG5vU3R1YkhhbmRsaW5nKQogICAgICAgICAgICBcdFx0fQogICAgICAgICAgICAiIiIKICAgICAgICB9CgogICAgICAgIHJldHVybiAiIiIKICAgICAgICBjYXRjaCBNb2NrRXJyb3Iubm90U3R1YmVkIHsKICAgICAgICBcKG5vU3R1YkhhbmRsaW5nKQogICAgICAgIFx0XHR9IGNhdGNoIHsKICAgICAgICBcdFx0ICAgIHRocm93IGVycm9yCiAgICAgICAgXHRcdH0KICAgICAgICAiIiIKICAgIH0KICAgIHZhciByZXR1cm5WYWx1ZTogU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgIHJldHVybiAiXG5cdFx0cmV0dXJuIF9fdmFsdWUiCiAgICB9CiAgICB2YXIgZXF1YWxDYXNlOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNJbml0aWFsaXplciBlbHNlIHsgcmV0dXJuICIiIH0KCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiY2FzZSAoLlwocHJvdG90eXBlKSwgLlwocHJvdG90eXBlKSk6IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBsaHNQYXJhbXMgPSBtZXRob2QucGFyYW1ldGVycy5tYXAgeyAibGV0IGxoc1woJDAubmFtZS5jYXBpdGFsaXplZCkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICAgICAgbGV0IHJoc1BhcmFtcyA9IG1ldGhvZC5wYXJhbWV0ZXJzLm1hcCB7ICJsZXQgcmhzXCgkMC5uYW1lLmNhcGl0YWxpemVkKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgICAgICByZXR1cm4gImNhc2UgKC5cKHByb3RvdHlwZSkoXChsaHNQYXJhbXMpKSwgLlwocHJvdG90eXBlKShcKHJoc1BhcmFtcykpKToiCiAgICAgICAgfQogICAgfQogICAgdmFyIGludFZhbHVlQ2FzZTogU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJjYXNlIC5cKHByb3RvdHlwZSk6IHJldHVybiAwIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBwYXJhbXMgPSBtZXRob2QucGFyYW1ldGVycy5lbnVtZXJhdGVkKCkubWFwIHsgb2Zmc2V0LCBfIGluCiAgICAgICAgICAgICAgICByZXR1cm4gInBcKG9mZnNldCkiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGRlZmluaXRpb25zID0gcGFyYW1zLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgICAgIGxldCBwYXJhbXNTdW0gPSBwYXJhbXMubWFwKHsgIlwoJDApLmludFZhbHVlIiB9KS5qb2luZWQoc2VwYXJhdG9yOiAiICsgIikKICAgICAgICAgICAgcmV0dXJuICJjYXNlIGxldCAuXChwcm90b3R5cGUpKFwoZGVmaW5pdGlvbnMpKTogcmV0dXJuIFwocGFyYW1zU3VtKSIKICAgICAgICB9CiAgICB9CgogICAgdmFyIHJldHVybnNTZWxmOiBCb29sIHsKICAgICAgICBndWFyZCAhcmV0dXJuc0dlbmVyaWNDb25zdHJhaW5lZFRvU2VsZiBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIHJldHVybiAhbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLmlzU2VsZlR5cGUKICAgIH0KICAgIHZhciByZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmOiBCb29sIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZSA9ICJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpCiAgICAgICAgLy8gR2VuZXJpY3MsICBsaWtlIE15Y2xhc3M8U2VsZiwgUT4KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiPFNlbGY+IikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiPFNlbGYsIikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiLFNlbGY+IikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiLFNlbGYsIikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAvLyBHZW5lcmljcyBMaXRlcmFscyBsaWtlIFtTZWxmOiBJbnRdIGV0YwogICAgICAgIGd1YXJkICFyZXR1cm5UeXBlLmNvbnRhaW5zKCJbU2VsZl0iKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIGd1YXJkICFyZXR1cm5UeXBlLmNvbnRhaW5zKCI6U2VsZl0iKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIGd1YXJkICFyZXR1cm5UeXBlLmNvbnRhaW5zKCJbU2VsZjoiKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgdmFyIHJldHVyblR5cGVSZXBsYWNpbmdTZWxmOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUubmFtZSkgIgogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICI8U2VsZj4iLCB3aXRoOiAiPFwocmVwbGFjZVNlbGYpPiIpCiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIjxTZWxmICIsIHdpdGg6ICI8XChyZXBsYWNlU2VsZikgIikKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGYsIiwgd2l0aDogIjxcKHJlcGxhY2VTZWxmKSwiKQogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZj4iLCB3aXRoOiAiIFwocmVwbGFjZVNlbGYpPiIpCiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIixTZWxmPiIsIHdpdGg6ICIsXChyZXBsYWNlU2VsZik+IikKICAgICAgICAgICAgLy8gbGl0ZXJhbHMKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGZdIiwgd2l0aDogIltcKHJlcGxhY2VTZWxmKV0iKQogICAgICAgICAgICAvLyByaWdodAogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJbU2VsZiAiLCB3aXRoOiAiW1wocmVwbGFjZVNlbGYpICIpCiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIltTZWxmLCIsIHdpdGg6ICJbXChyZXBsYWNlU2VsZiksIikKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGY6Iiwgd2l0aDogIltcKHJlcGxhY2VTZWxmKToiKQogICAgICAgICAgICAvLyBsZWZ0CiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiBTZWxmXSIsIHdpdGg6ICIgXChyZXBsYWNlU2VsZildIikKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiLFNlbGZdIiwgd2l0aDogIixcKHJlcGxhY2VTZWxmKV0iKQogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICI6U2VsZl0iLCB3aXRoOiAiOlwocmVwbGFjZVNlbGYpXSIpCiAgICAgICAgICAgIC8vIHVua25vd24KICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiIFNlbGYgIiwgd2l0aDogIiBcKHJlcGxhY2VTZWxmKSAiKQogICAgfQoKCiAgICB2YXIgcmVwbGFjZVNlbGY6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIEN1cnJlbnQuc2VsZlR5cGUKICAgIH0KCiAgICBpbml0KF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSB7CiAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2QKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGZ1bmMgY2xlYXIoKSAtPiBTdHJpbmcgewogICAgICAgIE1ldGhvZFdyYXBwZXIucmVnaXN0ZXJlZCA9IFs6XQogICAgICAgIE1ldGhvZFdyYXBwZXIuc3VmZml4ZXMgPSBbOl0KICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGUgPSBbOl0KICAgICAgICByZXR1cm4gIiIKICAgIH0KCiAgICBmdW5jIHJlZ2lzdGVyKCkgewogICAgICAgIE1ldGhvZFdyYXBwZXIucmVnaXN0ZXIocmVnaXN0cmF0aW9uTmFtZSx1bmlxdWVOYW1lLHVuaXF1ZU5hbWVXaXRoUmV0dXJuVHlwZSkKICAgIH0KCiAgICBzdGF0aWMgZnVuYyByZWdpc3RlcihfIG5hbWU6IFN0cmluZywgXyB1bmlxdWVOYW1lOiBTdHJpbmcsIF8gdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlOiBTdHJpbmcpIHsKICAgICAgICBpZiBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gPSBjb3VudCArIDEKICAgICAgICAgICAgTWV0aG9kV3JhcHBlci5zdWZmaXhlc1t1bmlxdWVOYW1lV2l0aFJldHVyblR5cGVdID0gY291bnQgKyAxCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgTWV0aG9kV3JhcHBlci5yZWdpc3RlcmVkW25hbWVdID0gMQogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzW3VuaXF1ZU5hbWVXaXRoUmV0dXJuVHlwZV0gPSAxCiAgICAgICAgfQoKICAgICAgICBpZiBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPSBjb3VudCArIDEKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPSAxCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgcmV0dXJuVHlwZU1hdHRlcnMoKSAtPiBCb29sIHsKICAgICAgICBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPz8gMAogICAgICAgIHJldHVybiBjb3VudCA+IDEKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRJbk1ldGhvZFR5cGUoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gIW1ldGhvZC5pc0luaXRpYWxpemVyCiAgICB9CgogICAgZnVuYyByZXR1cm5pbmdQYXJhbWV0ZXIoXyBtdWx0aXBsZTogQm9vbCwgXyBmcm9udDogQm9vbCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCByZXR1cm5UeXBlTWF0dGVycygpIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCByZXR1cm5pbmc6IFN0cmluZyA9ICJyZXR1cm5pbmc6IFwocmV0dXJuVHlwZVN0cmlwcGVkKG1ldGhvZCwgdHlwZTogdHJ1ZSkpIgogICAgICAgIGd1YXJkIG11bHRpcGxlIGVsc2UgeyByZXR1cm4gcmV0dXJuaW5nIH0KCiAgICAgICAgcmV0dXJuIGZyb250ID8gIiwgXChyZXR1cm5pbmcpIiA6ICJcKHJldHVybmluZyksICIKICAgIH0KCiAgICAvLyBTdHViCiAgICBmdW5jIHN0dWJCb2R5KCkgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QuaXNJbml0aWFsaXplciB8fCAhcmV0dXJuc1NlbGYgewogICAgICAgICAgICByZXR1cm4gaW52b2NhdGlvbiArIHBlcmZvcm1DYWxsKCkgKyBnaXZlblZhbHVlICsgdGhyb3dWYWx1ZSArIHJldHVyblZhbHVlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHdyYXBwZWRTdHViUHJlZml4KCkKICAgICAgICAgICAgICAgICsgIlx0XHQiICsgaW52b2NhdGlvbgogICAgICAgICAgICAgICAgKyBwZXJmb3JtQ2FsbCgpCiAgICAgICAgICAgICAgICArIGdpdmVuVmFsdWUKICAgICAgICAgICAgICAgICsgdGhyb3dWYWx1ZQogICAgICAgICAgICAgICAgKyByZXR1cm5WYWx1ZQogICAgICAgICAgICAgICAgKyB3cmFwcGVkU3R1YlBvc3RmaXgoKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHdyYXBwZWRTdHViUHJlZml4KCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIsIHJldHVybnNTZWxmIGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICB9CgogICAgICAgIGxldCB0aHJvd2luZzogU3RyaW5nID0gewogICAgICAgICAgICBpZiBtZXRob2QudGhyb3dzIHsKICAgICAgICAgICAgICAgIHJldHVybiAidGhyb3dzICIKICAgICAgICAgICAgfSBlbHNlIGlmIG1ldGhvZC5yZXRocm93cyB7CiAgICAgICAgICAgICAgICByZXR1cm4gInJldGhyb3dzICIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICB9CiAgICAgICAgfSgpCgogICAgICAgIHJldHVybiAiZnVuYyBfd3JhcHBlZDxfX1NlbGZfXz4oKSBcKHRocm93aW5nKS0+IF9fU2VsZl9fIHtcbiIKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRTdHViUG9zdGZpeCgpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyLCByZXR1cm5zU2VsZiBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgfQoKICAgICAgICBsZXQgdGhyb3dpbmc6IFN0cmluZyA9IChtZXRob2QudGhyb3dzIHx8IG1ldGhvZC5yZXRocm93cykgPyAidHJ5ICI6ICIiCgogICAgICAgIHJldHVybiAiXG5cdFx0fSIKICAgICAgICAgICAgKyAiXG5cdFx0cmV0dXJuIFwodGhyb3dpbmcpX3dyYXBwZWQoKSIKICAgIH0KCiAgICAvLyBNZXRob2QgVHlwZQogICAgZnVuYyBtZXRob2RUeXBlRGVjbGFyYXRpb25XaXRoUGFyYW1ldGVycygpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgZWxzZSB7IHJldHVybiAiXChwcm90b3R5cGUpIiB9CiAgICAgICAgcmV0dXJuICJcKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kVHlwZURlY2xhcmF0aW9uKCkpKSIKICAgIH0KCiAgICAvLyBHaXZlbgogICAgZnVuYyBjb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5jb250YWlucyh3aGVyZTogeyAkMC5wYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCA9PSBuaWwgfSkKICAgIH0KCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogU3RyaW5nID0gIiIsIGRlcHJlY2F0ZWQ6IEJvb2wgPSBmYWxzZSwgYW5ub3RhdGVkOiBCb29sID0gdHJ1ZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgYW5ub3RhdGlvbiA9IGFubm90YXRlZCAmJiBkZXByZWNhdGVkID8gZGVwcmVjYXRlZE1lc3NhZ2UoZGVwcmVjYXRlZFBhcmFtZXRlcnNNZXNzYWdlKCkpIDogIiIKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZzogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCAhcmV0dXJuc0dlbmVyaWNDb25zdHJhaW5lZFRvU2VsZiBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSZXBsYWNpbmdTZWxmIH0KICAgICAgICAgICAgZ3VhcmQgIXJldHVybnNTZWxmIGVsc2UgeyByZXR1cm4gcmVwbGFjZVNlbGYgfQogICAgICAgICAgICByZXR1cm4gVHlwZVdyYXBwZXIobWV0aG9kLnJldHVyblR5cGVOYW1lKS5zdHJpcHBlZAogICAgICAgIH0oKQoKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKSh3aWxsUmV0dXJuOiBcKHJldHVyblR5cGVTdHJpbmcpLi4uKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXChhbm5vdGF0aW9uKXB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKGRlcHJlY2F0ZWQ6IGRlcHJlY2F0ZWQpKSwgd2lsbFJldHVybjogXChyZXR1cm5UeXBlU3RyaW5nKS4uLikgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yTmFtZVRocm93cyhwcmVmaXg6IFN0cmluZyA9ICIiLCBkZXByZWNhdGVkOiBCb29sID0gZmFsc2UsIGFubm90YXRlZDogQm9vbCA9IHRydWUpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGFubm90YXRpb24gPSBhbm5vdGF0ZWQgJiYgZGVwcmVjYXRlZCA/IGRlcHJlY2F0ZWRNZXNzYWdlKGRlcHJlY2F0ZWRQYXJhbWV0ZXJzTWVzc2FnZSgpKSA6ICIiCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkod2lsbFRocm93OiBFcnJvci4uLikgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwoYW5ub3RhdGlvbilwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZShkZXByZWNhdGVkOiBkZXByZWNhdGVkKSksIHdpbGxUaHJvdzogRXJyb3IuLi4pIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3RvcihwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClHaXZlbihtZXRob2Q6IC5cKHByb3RvdHlwZSksIHByb2R1Y3RzOiB3aWxsUmV0dXJuLm1hcCh7IFN0dWJQcm9kdWN0LnJldHVybigkMCBhcyBBbnkpIH0pKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClHaXZlbihtZXRob2Q6IC5cKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkpKSwgcHJvZHVjdHM6IHdpbGxSZXR1cm4ubWFwKHsgU3R1YlByb2R1Y3QucmV0dXJuKCQwIGFzIEFueSkgfSkpIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3JUaHJvd3MocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpR2l2ZW4obWV0aG9kOiAuXChwcm90b3R5cGUpLCBwcm9kdWN0czogd2lsbFRocm93Lm1hcCh7IFN0dWJQcm9kdWN0LnRocm93KCQwKSB9KSkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpR2l2ZW4obWV0aG9kOiAuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0ZvclByb3h5SW5pdCgpKSksIHByb2R1Y3RzOiB3aWxsVGhyb3cubWFwKHsgU3R1YlByb2R1Y3QudGhyb3coJDApIH0pKSIKICAgICAgICB9CiAgICB9CgogICAgLy8gR2l2ZW4gd2lsbFByb2R1Y2UKICAgIGZ1bmMgZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JOYW1lKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmcgPSByZXR1cm5zU2VsZiA/IHJlcGxhY2VTZWxmIDogVHlwZVdyYXBwZXIobWV0aG9kLnJldHVyblR5cGVOYW1lKS5zdHJpcHBlZAogICAgICAgIGxldCBwcm9kdWNlQ2xvc3VyZSA9ICIoU3R1YmJlcjxcKHJldHVyblR5cGVTdHJpbmcpPikgLT4gVm9pZCIKCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkod2lsbFByb2R1Y2U6IFwocHJvZHVjZUNsb3N1cmUpKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoKSksIHdpbGxQcm9kdWNlOiBcKHByb2R1Y2VDbG9zdXJlKSkgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBnaXZlblByb2R1Y2VDb25zdHJ1Y3Rvck5hbWVUaHJvd3MocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkCiAgICAgICAgbGV0IHByb2R1Y2VDbG9zdXJlID0gIihTdHViYmVyVGhyb3dzPFwocmV0dXJuVHlwZVN0cmluZyk+KSAtPiBWb2lkIgoKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKSh3aWxsUHJvZHVjZTogXChwcm9kdWNlQ2xvc3VyZSkpIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZSgpKSwgd2lsbFByb2R1Y2U6IFwocHJvZHVjZUNsb3N1cmUpKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIGdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmcgPSByZXR1cm5zU2VsZiA/IHJlcGxhY2VTZWxmIDogVHlwZVdyYXBwZXIobWV0aG9kLnJldHVyblR5cGVOYW1lKS5zdHJpcHBlZAogICAgICAgIHJldHVybiAiIiIKICAgICAgICBsZXQgd2lsbFJldHVybjogW1wocmV0dXJuVHlwZVN0cmluZyldID0gW10KICAgICAgICBcdFx0XHRsZXQgZ2l2ZW46IFwocHJlZml4KUdpdmVuID0geyBcKGdpdmVuQ29uc3RydWN0b3IocHJlZml4OiBwcmVmaXgpKSB9KCkKICAgICAgICBcdFx0XHRsZXQgc3R1YmJlciA9IGdpdmVuLnN0dWIoZm9yOiAoXChyZXR1cm5UeXBlU3RyaW5nKSkuc2VsZikKICAgICAgICBcdFx0XHR3aWxsUHJvZHVjZShzdHViYmVyKQogICAgICAgIFx0XHRcdHJldHVybiBnaXZlbgogICAgICAgICIiIgogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JUaHJvd3MocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkCiAgICAgICAgcmV0dXJuICIiIgogICAgICAgIGxldCB3aWxsVGhyb3c6IFtFcnJvcl0gPSBbXQogICAgICAgIFx0XHRcdGxldCBnaXZlbjogXChwcmVmaXgpR2l2ZW4gPSB7IFwoZ2l2ZW5Db25zdHJ1Y3RvclRocm93cyhwcmVmaXg6IHByZWZpeCkpIH0oKQogICAgICAgIFx0XHRcdGxldCBzdHViYmVyID0gZ2l2ZW4uc3R1YlRocm93cyhmb3I6IChcKHJldHVyblR5cGVTdHJpbmcpKS5zZWxmKQogICAgICAgIFx0XHRcdHdpbGxQcm9kdWNlKHN0dWJiZXIpCiAgICAgICAgXHRcdFx0cmV0dXJuIGdpdmVuCiAgICAgICAgIiIiCiAgICB9CgogICAgLy8gVmVyaWZ5CiAgICBmdW5jIHZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogU3RyaW5nID0gIiIsIGRlcHJlY2F0ZWQ6IEJvb2wgPSBmYWxzZSwgYW5ub3RhdGVkOiBCb29sID0gdHJ1ZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgKGFubm90YXRpb24sIG1ldGhvZE5hbWUsIGdlbmVyaWNDb25zdHJhaW5zKSA9IG1ldGhvZEluZm8oZGVwcmVjYXRlZCwgYW5ub3RhdGVkKQoKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2ROYW1lKShcKHJldHVybmluZ1BhcmFtZXRlcihmYWxzZSx0cnVlKSkpIC0+IFwocHJlZml4KVZlcmlmeVwoZ2VuZXJpY0NvbnN0cmFpbnMpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXChhbm5vdGF0aW9uKXB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZE5hbWUpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKGRlcHJlY2F0ZWQ6IGRlcHJlY2F0ZWQpKVwocmV0dXJuaW5nUGFyYW1ldGVyKHRydWUsdHJ1ZSkpKSAtPiBcKHByZWZpeClWZXJpZnlcKGdlbmVyaWNDb25zdHJhaW5zKSIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyB2ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KVZlcmlmeShtZXRob2Q6IC5cKHByb3RvdHlwZSkpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KVZlcmlmeShtZXRob2Q6IC5cKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkpKSkiCiAgICAgICAgfQogICAgfQoKICAgIC8vIFBlcmZvcm0KICAgIGZ1bmMgcGVyZm9ybVByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogU3RyaW5nID0gIiIsIGRlcHJlY2F0ZWQ6IEJvb2wgPSBmYWxzZSwgYW5ub3RhdGVkOiBCb29sID0gdHJ1ZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgKGFubm90YXRpb24sIG1ldGhvZE5hbWUsIGdlbmVyaWNDb25zdHJhaW5zKSA9IG1ldGhvZEluZm8oZGVwcmVjYXRlZCwgYW5ub3RhdGVkKQoKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2ROYW1lKShcKHJldHVybmluZ1BhcmFtZXRlcih0cnVlLGZhbHNlKSlwZXJmb3JtOiBAZXNjYXBpbmcgXChwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpKSkgLT4gXChwcmVmaXgpUGVyZm9ybVwoZ2VuZXJpY0NvbnN0cmFpbnMpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXChhbm5vdGF0aW9uKXB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZE5hbWUpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKGRlcHJlY2F0ZWQ6IGRlcHJlY2F0ZWQpKSwgXChyZXR1cm5pbmdQYXJhbWV0ZXIodHJ1ZSxmYWxzZSkpcGVyZm9ybTogQGVzY2FwaW5nIFwocGVyZm9ybVByb3h5Q2xvc3VyZVR5cGUoKSkpIC0+IFwocHJlZml4KVBlcmZvcm1cKGdlbmVyaWNDb25zdHJhaW5zKSIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBwZXJmb3JtUHJveHlDb25zdHJ1Y3RvcihwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClQZXJmb3JtKG1ldGhvZDogLlwocHJvdG90eXBlKSwgcGVyZm9ybXM6IHBlcmZvcm0pIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KVBlcmZvcm0obWV0aG9kOiAuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0ZvclByb3h5SW5pdCgpKSksIHBlcmZvcm1zOiBwZXJmb3JtKSIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiKCkgLT4gVm9pZCIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgcGFyYW1ldGVycyA9IHNlbGYucGFyYW1ldGVycwogICAgICAgICAgICAgICAgLm1hcCB7ICJcKCQwLmp1c3RQZXJmb3JtVHlwZSkiIH0KICAgICAgICAgICAgICAgIC5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgICAgICByZXR1cm4gIihcKHBhcmFtZXRlcnMpKSAtPiBWb2lkIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHBlcmZvcm1Qcm94eUNsb3N1cmVDYWxsKCkgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwZXJmb3JtPygpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBwYXJhbWV0ZXJzID0gbWV0aG9kLnBhcmFtZXRlcnMKICAgICAgICAgICAgICAgIC5tYXAgeyBwIGluCiAgICAgICAgICAgICAgICAgICAgbGV0IHdyYXBwZWQgPSBQYXJhbWV0ZXJXcmFwcGVyKHApCiAgICAgICAgICAgICAgICAgICAgbGV0IGlzQXV0b2xvc3VyZSA9IHdyYXBwZWQuanVzdFR5cGUuaGFzUHJlZml4KCJAYXV0b2Nsb3N1cmUiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiAiXChwLmlub3V0ID8gIiYiIDogIiIpYFwocC5uYW1lKWBcKGlzQXV0b2xvc3VyZSA/ICIoKSIgOiAiIikiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAuam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICAgICAgcmV0dXJuICJwZXJmb3JtPyhcKHBhcmFtZXRlcnMpKSIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBwZXJmb3JtQ2FsbCgpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCB0eXBlID0gcGVyZm9ybVByb3h5Q2xvc3VyZVR5cGUoKQogICAgICAgIHZhciBwcm94eSA9IG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgPyAiXChwcm90b3R5cGUpIiA6ICJcKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kQ2FsbCgpKSkiCgogICAgICAgIGxldCBjYXN0ID0gImxldCBwZXJmb3JtID0gbWV0aG9kUGVyZm9ybVZhbHVlKC5cKHByb3h5KSkgYXM/IFwodHlwZSkiCiAgICAgICAgbGV0IGNhbGwgPSBwZXJmb3JtUHJveHlDbG9zdXJlQ2FsbCgpCgogICAgICAgIHJldHVybiAiXG5cdFx0XChjYXN0KVxuXHRcdFwoY2FsbCkiCiAgICB9CgogICAgLy8gSGVscGVycwogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgZ2VuZXJpY3MgPSBnZXRHZW5lcmljc1dpdGhvdXRDb25zdHJhaW50cygpCiAgICAgICAgcmV0dXJuIHBhcmFtZXRlcnMubWFwIHsgJDAud3JhcHBlZEZvckNhbGxzKGdlbmVyaWNzKSB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JNZXRob2RUeXBlRGVjbGFyYXRpb24oKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzV2l0aG91dENvbnN0cmFpbnRzKCkKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5tYXAgeyBwYXJhbSBpbgogICAgICAgICAgICByZXR1cm4gcGFyYW0uaXNHZW5lcmljKGdlbmVyaWNzKSA/IHBhcmFtLmdlbmVyaWNUeXBlIDogcGFyYW0ubmVzdGVkVHlwZQogICAgICAgICAgICB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZShkZXByZWNhdGVkOiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHBhcmFtZXRlcnMubWFwIHsgcCBpbgogICAgICAgICAgICBndWFyZCBkZXByZWNhdGVkIGVsc2UgeyByZXR1cm4gIlwocC5sYWJlbEFuZE5hbWUoKSk6IFwocC5uZXN0ZWRUeXBlKSIgfQogICAgICAgICAgICBndWFyZCBsZXQgYXJndW1lbnRMYWJlbCA9IHAucGFyYW1ldGVyLmFyZ3VtZW50TGFiZWwgZWxzZSB7IHJldHVybiAiXChwLnBhcmFtZXRlci5uYW1lKTogXChwLm5lc3RlZFR5cGUpIiB9CiAgICAgICAgICAgIGd1YXJkIGFyZ3VtZW50TGFiZWwgIT0gcC5uYW1lIGVsc2UgeyByZXR1cm4gIlwocC5wYXJhbWV0ZXIubmFtZSk6IFwocC5uZXN0ZWRUeXBlKSIgfQogICAgICAgICAgICByZXR1cm4gIlwoYXJndW1lbnRMYWJlbCkgXChwLnBhcmFtZXRlci5uYW1lKTogXChwLm5lc3RlZFR5cGUpIgogICAgICAgICAgICB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIGRlcHJlY2F0ZWRQYXJhbWV0ZXJzTWVzc2FnZSgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IG5ld1BhcmFtcyA9IHBhcmFtZXRlcnMubWFwIHsgcCBpbiByZXR1cm4gIlwocC5wYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCA/PyAiXyIpIiB9CiAgICAgICAgbGV0IG9sZFBhcmFtcyA9IHBhcmFtZXRlcnMubWFwIHsgcCAtPiBTdHJpbmcgaW4KICAgICAgICAgICAgZ3VhcmQgbGV0IGFyZ3VtZW50TGFiZWwgPSBwLnBhcmFtZXRlci5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gIlwocC5wYXJhbWV0ZXIubmFtZSkiIH0KICAgICAgICAgICAgZ3VhcmQgYXJndW1lbnRMYWJlbCAhPSBwLm5hbWUgZWxzZSB7IHJldHVybiAiXChwLnBhcmFtZXRlci5uYW1lKSIgfQogICAgICAgICAgICByZXR1cm4gIlwoYXJndW1lbnRMYWJlbCkiCiAgICAgICAgfQoKICAgICAgICB2YXIgbWVzc2FnZXM6IFtTdHJpbmddID0gW10KICAgICAgICBmb3IgaSBpbiAwLi48bmV3UGFyYW1zLmNvdW50IHsKICAgICAgICAgICAgaWYgbmV3UGFyYW1zW2ldICE9IG9sZFBhcmFtc1tpXSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlcy5hcHBlbmQoIiByZW1vdmUgYFwob2xkUGFyYW1zW2ldKWAgbGFiZWwiKQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIiBQb3NzaWJsZSBmaXg6ICIgKyBtZXNzYWdlcy5qb2luZWQoc2VwYXJhdG9yOiAiLCIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JTdHViU2lnbmF0dXJlKCkgLT4gU3RyaW5nIHsKICAgICAgICBmdW5jIHJlcGxhY2luZyhmaXJzdDogU3RyaW5nLCBpbiBmdWxsOiBTdHJpbmcsIHdpdGggb3RoZXI6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICAgICAgZ3VhcmQgbGV0IHJhbmdlID0gZnVsbC5yYW5nZShvZjogZmlyc3QpIGVsc2UgeyByZXR1cm4gZnVsbCB9CiAgICAgICAgICAgIHJldHVybiBmdWxsLnJlcGxhY2luZ0NoYXJhY3RlcnMoaW46IHJhbmdlLCB3aXRoOiBvdGhlcikKICAgICAgICB9CiAgICAgICAgbGV0IHByZWZpeCA9IG1ldGhvZC5zaG9ydE5hbWUKICAgICAgICBsZXQgZnVsbCA9IG1ldGhvZC5uYW1lCiAgICAgICAgbGV0IHJhbmdlID0gZnVsbC5yYW5nZShvZjogcHJlZml4KSEKICAgICAgICB2YXIgdW5yZWZpbmVkID0gIlwoZnVsbFtyYW5nZS51cHBlckJvdW5kLi4uXSkiCiAgICAgICAgcGFyYW1ldGVycy5tYXAgeyBwIC0+IChTdHJpbmcsU3RyaW5nKSBpbgogICAgICAgICAgICByZXR1cm4gKCJcKHAudHlwZSkiLCJcKHAuanVzdFR5cGUpIikKICAgICAgICAgICAgfS5mb3JFYWNoIHsKICAgICAgICAgICAgICAgIHVucmVmaW5lZCA9IHJlcGxhY2luZyhmaXJzdDogJDAsIGluOiB1bnJlZmluZWQsIHdpdGg6ICQxKQogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5yZWZpbmVkCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JQcm94eUluaXQoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzV2l0aG91dENvbnN0cmFpbnRzKCkKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5tYXAgeyAiXCgkMC53cmFwcGVkRm9yUHJveHkoZ2VuZXJpY3MpKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgfQoKICAgIHByaXZhdGUgZnVuYyBpc0dlbmVyaWMoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gbWV0aG9kLnNob3J0TmFtZS5jb250YWlucygiPCIpICYmIG1ldGhvZC5zaG9ydE5hbWUuY29udGFpbnMoIj4iKQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGxpc3Qgb2YgZ2VuZXJpY3MgdXNlZCBpbiBtZXRob2Qgc2lnbmF0dXJlLCB3aXRob3V0IHRoZWlyIGNvbnN0cmFpbnRzIChsaWtlIFtULFUsVl0pCiAgICAvLy8KICAgIC8vLyAtIFJldHVybnM6IEFycmF5IG9mIHN0cmluZ3MsIHdoZXJlIGVhY2ggc3RyaW5ncyByZXByZXNlbnQgZ2VuZXJpYyBuYW1lCiAgICBwcml2YXRlIGZ1bmMgZ2V0R2VuZXJpY3NXaXRob3V0Q29uc3RyYWludHMoKSAtPiBbU3RyaW5nXSB7CiAgICAgICAgbGV0IG5hbWUgPSBtZXRob2Quc2hvcnROYW1lCiAgICAgICAgZ3VhcmQgbGV0IHN0YXJ0ID0gbmFtZS5pbmRleChvZjogIjwiKSwgbGV0IGVuZCA9IG5hbWUuaW5kZXgob2Y6ICI+IikgZWxzZSB7IHJldHVybiBbXSB9CgogICAgICAgIHZhciBnZW5QYXJ0ID0gbmFtZVtzdGFydC4uLmVuZF0KICAgICAgICBnZW5QYXJ0LnJlbW92ZUZpcnN0KCkKICAgICAgICBnZW5QYXJ0LnJlbW92ZUxhc3QoKQoKICAgICAgICBsZXQgcGFydHMgPSBnZW5QYXJ0LnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiICIsIHdpdGg6ICIiKS5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIiwiKS5tYXAoU3RyaW5nLmluaXQpCiAgICAgICAgcmV0dXJuIHBhcnRzLm1hcCB7IHN0cmlwR2VuUGFydChwYXJ0OiAkMCkgfQogICAgfQoKICAgIC8vLyBSZXR1cm5zIGxpc3Qgb2YgZ2VuZXJpYyBjb25zdHJhaW50ZXMgZnJvbSBtZXRob2Qgc2lnbmF0dXJlLiBEb2VzIG9ubHkgY29udGFpbiBzdHVmZiBiZXR3ZWVuICc8JyBhbmQgJz4nCiAgICAvLy8KICAgIC8vLyAtIFJldHVybnM6IEFycmF5IG9mIHN0cmluZ3MsIGxpa2UgWyJUOiBDb2RhYmxlIiwgIlU6IFdoYXRldmVyIl0KICAgIHByaXZhdGUgZnVuYyBnZXRHZW5lcmljc0NvbnN0cmFpbnRzKF8gZ2VuZXJpY3M6IFtTdHJpbmddKSAtPiBbU3RyaW5nXSB7CiAgICAgICAgbGV0IG5hbWUgPSBtZXRob2Quc2hvcnROYW1lCiAgICAgICAgZ3VhcmQgbGV0IHN0YXJ0ID0gbmFtZS5pbmRleChvZjogIjwiKSwgbGV0IGVuZCA9IG5hbWUuaW5kZXgob2Y6ICI+IikgZWxzZSB7IHJldHVybiBbXSB9CgogICAgICAgIHZhciBnZW5QYXJ0ID0gbmFtZVtzdGFydC4uLmVuZF0KICAgICAgICBnZW5QYXJ0LnJlbW92ZUZpcnN0KCkKICAgICAgICBnZW5QYXJ0LnJlbW92ZUxhc3QoKQoKICAgICAgICBsZXQgcGFydHMgPSBnZW5QYXJ0LnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiICIsIHdpdGg6ICIiKS5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIiwiKS5tYXAoU3RyaW5nLmluaXQpCiAgICAgICAgcmV0dXJuIHBhcnRzLmZpbHRlciB7CiAgICAgICAgICAgIGxldCBjb21wb25lbnRzID0gJDAuY29tcG9uZW50cyhzZXBhcmF0ZWRCeTogIjoiKQogICAgICAgICAgICByZXR1cm4gY29tcG9uZW50cy5jb3VudCA9PSAyICYmIGdlbmVyaWNzLmNvbnRhaW5zKGNvbXBvbmVudHNbMF0pCiAgICAgICAgfQogICAgfQoKICAgIHByaXZhdGUgZnVuYyBnZXRHZW5lcmljc0Ftb25nUGFyYW1ldGVycygpIC0+IFtTdHJpbmddIHsKICAgICAgICByZXR1cm4gZ2V0R2VuZXJpY3NXaXRob3V0Q29uc3RyYWludHMoKS5maWx0ZXIgewogICAgICAgICAgICBmb3IgcGFyYW0gaW4gc2VsZi5wYXJhbWV0ZXJzIHsKICAgICAgICAgICAgICAgIGlmIHBhcmFtLmlzR2VuZXJpYyhbJDBdKSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2UKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHdyYXBHZW5lcmljcyhfIGdlbmVyaWNzOiBbU3RyaW5nXSkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCAhZ2VuZXJpY3MuaXNFbXB0eSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIjxcKGdlbmVyaWNzLmpvaW5lZChzZXBhcmF0b3I6IiwiKSk+IgogICAgfQoKICAgIHByaXZhdGUgZnVuYyBzdHJpcEdlblBhcnQocGFydDogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiBwYXJ0LmNoYXJhY3RlcnMuc3BsaXQoc2VwYXJhdG9yOiAiOiIpLm1hcChTdHJpbmcuaW5pdCkuZmlyc3QhCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHJldHVyblR5cGVTdHJpcHBlZChfIG1ldGhvZDogU291cmNlcnlSdW50aW1lLk1ldGhvZCwgdHlwZTogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwobWV0aG9kLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgc3RyaXBwZWQ6IFN0cmluZyA9IHsKICAgICAgICAgICAgZ3VhcmQgbGV0IHJhbmdlID0gcmV0dXJuVHlwZVJhdy5yYW5nZShvZjogIndoZXJlIikgZWxzZSB7IHJldHVybiByZXR1cm5UeXBlUmF3IH0KICAgICAgICAgICAgdmFyIHN0cmlwcGVkID0gcmV0dXJuVHlwZVJhdwogICAgICAgICAgICBzdHJpcHBlZC5yZW1vdmVTdWJyYW5nZSgocmFuZ2UubG93ZXJCb3VuZCkuLi4pCiAgICAgICAgICAgIHJldHVybiBzdHJpcHBlZAogICAgICAgIH0oKQogICAgICAgIHN0cmlwcGVkID0gc3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIGd1YXJkIHR5cGUgZWxzZSB7IHJldHVybiBzdHJpcHBlZCB9CiAgICAgICAgcmV0dXJuICIoXChzdHJpcHBlZCkpLlR5cGUiCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIG1ldGhvZEluZm8oXyBkZXByZWNhdGVkOiBCb29sLCBfIGFubm90YXRlZDogQm9vbCkKICAgICAgICAtPiAoYW5ub3RhdGlvbjogU3RyaW5nLCBtZXRob2ROYW1lOiBTdHJpbmcsIGdlbmVyaWNDb25zdHJhaW5zOiBTdHJpbmcpIHsKICAgICAgICAgICAgbGV0IGdlbmVyaWNzID0gZ2V0R2VuZXJpY3NBbW9uZ1BhcmFtZXRlcnMoKQogICAgICAgICAgICBsZXQgYW5ub3RhdGlvbiA9IGFubm90YXRlZCAmJiBkZXByZWNhdGVkID8gZGVwcmVjYXRlZE1lc3NhZ2UoZGVwcmVjYXRlZFBhcmFtZXRlcnNNZXNzYWdlKCkpIDogIiIKICAgICAgICAgICAgbGV0IG1ldGhvZE5hbWUgPSByZXR1cm5UeXBlTWF0dGVycygpID8gbWV0aG9kLnNob3J0TmFtZSA6ICJcKG1ldGhvZC5jYWxsTmFtZSlcKHdyYXBHZW5lcmljcyhnZW5lcmljcykpIgogICAgICAgICAgICBsZXQgZ2VuZXJpY0NvbnN0cmFpbnM6IFN0cmluZyA9IHsKICAgICAgICAgICAgICAgIGxldCBjb25zdHJhaW50cyA9IGdldEdlbmVyaWNzQ29uc3RyYWludHMoZ2VuZXJpY3MpCiAgICAgICAgICAgICAgICBndWFyZCAhY29uc3RyYWludHMuaXNFbXB0eSBlbHNlIHsgcmV0dXJuICIiIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gIiB3aGVyZSBcKGNvbnN0cmFpbnRzLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpKSIKICAgICAgICAgICAgfSgpCiAgICAgICAgICAgIHJldHVybiAoYW5ub3RhdGlvbiwgbWV0aG9kTmFtZSwgZ2VuZXJpY0NvbnN0cmFpbnMpCiAgICB9Cn0KY2xhc3MgU3Vic2NyaXB0V3JhcHBlciB7CiAgICBsZXQgd3JhcHBlZDogU291cmNlcnlSdW50aW1lLlN1YnNjcmlwdAogICAgdmFyIHJlYWRvbmx5OiBCb29sIHsgcmV0dXJuICF3cmFwcGVkLmlzTXV0YWJsZSB9CiAgICB2YXIgd3JhcHBlZFBhcmFtZXRlcnM6IFtQYXJhbWV0ZXJXcmFwcGVyXSB7IHJldHVybiB3cmFwcGVkLnBhcmFtZXRlcnMubWFwIHsgUGFyYW1ldGVyV3JhcHBlcigkMCkgfSB9CiAgICB2YXIgY2FzZXNDb3VudDogSW50IHsgcmV0dXJuIHJlYWRvbmx5ID8gMSA6IDIgfQogICAgdmFyIG5lc3RlZFR5cGU6IFN0cmluZyB7IHJldHVybiAiXChUeXBlV3JhcHBlcih3cmFwcGVkLnJldHVyblR5cGVOYW1lKS5uZXN0ZWRQYXJhbWV0ZXIpIiB9CiAgICBsZXQgYXNzb2NpYXRlZFR5cGVzOiBbU3RyaW5nXT8KICAgIGxldCBnZW5lcmljVHlwZXNMaXN0OiBbU3RyaW5nXQogICAgbGV0IGdlbmVyaWNUeXBlc01vZGlmaWVyOiBTdHJpbmc/CgogICAgcHJpdmF0ZSBsZXQgbm9TdHViRGVmaW5lZE1lc3NhZ2UgPSAiU3R1YiByZXR1cm4gdmFsdWUgbm90IHNwZWNpZmllZCBmb3Igc3Vic2NyaXB0LiBVc2UgZ2l2ZW4gZmlyc3QuIgoKICAgIHByaXZhdGUgc3RhdGljIHZhciByZWdpc3RlcmVkOiBbU3RyaW5nOiBJbnRdID0gWzpdCiAgICBwcml2YXRlIHN0YXRpYyB2YXIgbmFtZXNXaXRob3V0UmV0dXJuVHlwZTogW1N0cmluZzogSW50XSA9IFs6XQogICAgcHJpdmF0ZSBzdGF0aWMgdmFyIHN1ZmZpeGVzOiBbU3RyaW5nOiBJbnRdID0gWzpdCiAgICBwdWJsaWMgc3RhdGljIGZ1bmMgY2xlYXIoKSAtPiBTdHJpbmcgewogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXJlZCA9IFs6XQogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIuc3VmZml4ZXMgPSBbOl0KICAgICAgICByZXR1cm4gIiIKICAgIH0KICAgIHN0YXRpYyBmdW5jIHJlZ2lzdGVyKF8gbmFtZTogU3RyaW5nLCBfIHVuaXF1ZU5hbWU6IFN0cmluZykgewogICAgICAgIGxldCBjb3VudCA9IFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXJlZFtuYW1lXSA/PyAwCiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcmVkW25hbWVdID0gY291bnQgKyAxCiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5zdWZmaXhlc1t1bmlxdWVOYW1lXSA9IGNvdW50ICsgMQogICAgfQogICAgc3RhdGljIGZ1bmMgcmVnaXN0ZXIoc2hvcnQgbmFtZTogU3RyaW5nKSB7CiAgICAgICAgbGV0IGNvdW50ID0gU3Vic2NyaXB0V3JhcHBlci5uYW1lc1dpdGhvdXRSZXR1cm5UeXBlW25hbWVdID8/IDAKICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLm5hbWVzV2l0aG91dFJldHVyblR5cGVbbmFtZV0gPSBjb3VudCArIDEKICAgIH0KCiAgICBmdW5jIHJlZ2lzdGVyKCkgewogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXIocmVnaXN0cmF0aW9uTmFtZSgiZ2V0IiksdW5pcXVlTmFtZSkKICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyKHNob3J0OiBzaG9ydE5hbWUpCiAgICAgICAgZ3VhcmQgIXJlYWRvbmx5IGVsc2UgeyByZXR1cm4gfQogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXIocmVnaXN0cmF0aW9uTmFtZSgic2V0IiksdW5pcXVlTmFtZSkKICAgIH0KCiAgICBpbml0KF8gd3JhcHBlZDogU291cmNlcnlSdW50aW1lLlN1YnNjcmlwdCkgewogICAgICAgIHNlbGYud3JhcHBlZCA9IHdyYXBwZWQKICAgICAgICBhc3NvY2lhdGVkVHlwZXMgPSBIZWxwZXJzLmV4dHJhY3RBc3NvY2lhdGVkVHlwZXMoZnJvbTogd3JhcHBlZCkKICAgICAgICBnZW5lcmljVHlwZXNMaXN0ID0gSGVscGVycy5leHRyYWN0R2VuZXJpY3NMaXN0KGFzc29jaWF0ZWRUeXBlcykKICAgICAgICBpZiBsZXQgdHlwZXMgPSBhc3NvY2lhdGVkVHlwZXMgewogICAgICAgICAgICBnZW5lcmljVHlwZXNNb2RpZmllciA9ICI8XCh0eXBlcy5qb2luZWQoc2VwYXJhdG9yOiAiLCIpKT4iCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZ2VuZXJpY1R5cGVzTW9kaWZpZXIgPSBuaWwKICAgICAgICB9CiAgICB9CgogICAgZnVuYyByZWdpc3RyYXRpb25OYW1lKF8gYWNjZXNzb3I6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gInN1YnNjcmlwdF9cKGFjY2Vzc29yKV9cKHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCh7ICQwLnNhbml0aXplZEZvckVudW1DYXNlTmFtZSgpIH0pLmpvaW5lZChzZXBhcmF0b3I6ICJfIikpIgogICAgfQogICAgdmFyIHNob3J0TmFtZTogU3RyaW5nIHsgcmV0dXJuICJwdWJsaWMgc3Vic2NyaXB0XChnZW5lcmljVHlwZXNNb2RpZmllciA/PyAiICIpKFwod3JhcHBlZFBhcmFtZXRlcnMubWFwKHsgJDAuYXNNZXRob2RBcmd1bWVudCgpIH0pLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpKSkiIH0KICAgIHZhciB1bmlxdWVOYW1lOiBTdHJpbmcgeyByZXR1cm4gIlwoc2hvcnROYW1lKSAtPiBcKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpIiB9CgogICAgcHJpdmF0ZSBmdW5jIG5hbWVTdWZmaXgoXyBhY2Nlc3NvcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIGd1YXJkIGxldCBjb3VudCA9IFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXJlZFtyZWdpc3RyYXRpb25OYW1lKGFjY2Vzc29yKV0gZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgY291bnQgPiAxIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIGxldCBpbmRleCA9IFN1YnNjcmlwdFdyYXBwZXIuc3VmZml4ZXNbdW5pcXVlTmFtZV0gZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgcmV0dXJuICJfXChpbmRleCkiCiAgICB9CgogICAgLy8gY2FsbAogICAgZnVuYyBzdWJzY3JpcHRDYWxsKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgZ2V0ID0gIlxuXHRcdGdldCB7XChnZXR0ZXIoKSlcblx0XHR9IgogICAgICAgIGxldCBzZXQgPSByZWFkb25seSA/ICIiIDogIlxuXHRcdHNldCB7XChzZXR0ZXIoKSlcblx0XHR9IgogICAgICAgIHJldHVybiAiXCh1bmlxdWVOYW1lKSB7XChnZXQpXChzZXQpXG5cdH0iCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgZ2V0dGVyKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgbWV0aG9kID0gIi5cKHN1YnNjcmlwdENhc2VQcmVmaXgoImdldCIpKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkpKSIKICAgICAgICBsZXQgbm9TdHViRGVmaW5lZCA9IHdyYXBwZWQucmV0dXJuVHlwZU5hbWUuaXNPcHRpb25hbCA/ICJyZXR1cm4gbmlsIiA6ICJvbkZhdGFsRmFpbHVyZShcIlwobm9TdHViRGVmaW5lZE1lc3NhZ2UpXCIpOyBGYWlsdXJlKFwibm9TdHViRGVmaW5lZE1lc3NhZ2VcIikiCiAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICJcblx0XHRcdGFkZEludm9jYXRpb24oXChtZXRob2QpKSIgKwogICAgICAgICAgICAgICAgIlxuXHRcdFx0ZG8geyIgKwogICAgICAgICAgICAgICAgIlxuXHRcdFx0XHRyZXR1cm4gdHJ5IG1ldGhvZFJldHVyblZhbHVlKFwobWV0aG9kKSkuY2FzdGVkKCkiICsKICAgICAgICAgICAgICAgICJcblx0XHRcdH0gY2F0Y2ggeyIgKwogICAgICAgICAgICAgICAgIlxuXHRcdFx0XHRcKG5vU3R1YkRlZmluZWQpIiArCiAgICAgICAgIlxuXHRcdFx0fSIKICAgIH0KICAgIHByaXZhdGUgZnVuYyBzZXR0ZXIoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBtZXRob2QgPSAiLlwoc3Vic2NyaXB0Q2FzZVByZWZpeCgic2V0IikpKFwocGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoc2V0OiB0cnVlKSkpIgogICAgICAgIHJldHVybiAiXG5cdFx0XHRhZGRJbnZvY2F0aW9uKFwobWV0aG9kKSkiCiAgICB9CgogICAgLy8gbWV0aG9kIHR5cGUKICAgIGZ1bmMgc3Vic2NyaXB0Q2FzZVByZWZpeChfIGFjY2Vzc29yOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJcKHJlZ2lzdHJhdGlvbk5hbWUoYWNjZXNzb3IpKVwobmFtZVN1ZmZpeChhY2Nlc3NvcikpIgogICAgfQogICAgZnVuYyBzdWJzY3JpcHRDYXNlTmFtZShfIGFjY2Vzc29yOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJcKHN1YnNjcmlwdENhc2VQcmVmaXgoYWNjZXNzb3IpKShcKHBhcmFtZXRlcnNGb3JNZXRob2RUeXBlRGVjbGFyYXRpb24oc2V0OiBhY2Nlc3NvciA9PSAic2V0IikpKSIKICAgIH0KICAgIGZ1bmMgc3Vic2NyaXB0Q2FzZXMoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiByZWFkb25seSA/ICJjYXNlIFwoc3Vic2NyaXB0Q2FzZU5hbWUoImdldCIpKSIgOiAiY2FzZSBcKHN1YnNjcmlwdENhc2VOYW1lKCJnZXQiKSlcblx0XHRjYXNlIFwoc3Vic2NyaXB0Q2FzZU5hbWUoInNldCIpKSIKICAgIH0KICAgIGZ1bmMgZXF1YWxDYXNlKF8gYWNjZXNzb3I6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICB2YXIgbGhzUGFyYW1zID0gd3JhcHBlZC5wYXJhbWV0ZXJzLm1hcCB7ICJsaHNcKCQwLm5hbWUuY2FwaXRhbGl6ZWQpIiB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgdmFyIHJoc1BhcmFtcyA9IHdyYXBwZWQucGFyYW1ldGVycy5tYXAgeyAicmhzXCgkMC5uYW1lLmNhcGl0YWxpemVkKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgIHZhciBjb21wYXJhdG9ycyA9IHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCB7ICJcdFx0XHRcdFwoJDAuY29tcGFyYXRvcikiIH0uam9pbmVkKHNlcGFyYXRvcjogIlxuIikKICAgICAgICBpZiBhY2Nlc3NvciA9PSAic2V0IiB7CiAgICAgICAgICAgIGxoc1BhcmFtcyArPSAiLCBsaHNEaWRTZXQiCiAgICAgICAgICAgIHJoc1BhcmFtcyArPSAiLCByaHNEaWRTZXQiCiAgICAgICAgICAgIGNvbXBhcmF0b3JzICs9ICJcblx0XHRcdFx0cmV0dXJuIFBhcmFtZXRlci5jb21wYXJlKGxoczogbGhzRGlkU2V0LCByaHM6IHJoc0RpZFNldCwgd2l0aDogbWF0Y2hlcikiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29tcGFyYXRvcnMgKz0gIlxuXHRcdFx0XHRyZXR1cm4gdHJ1ZSIKICAgICAgICB9CiAgICAgICAgcmV0dXJuICJjYXNlIChsZXQgLlwoc3Vic2NyaXB0Q2FzZVByZWZpeChhY2Nlc3NvcikpKFwobGhzUGFyYW1zKSksIGxldCAuXChzdWJzY3JpcHRDYXNlUHJlZml4KGFjY2Vzc29yKSkoXChyaHNQYXJhbXMpKSk6XG4iICsgY29tcGFyYXRvcnMKICAgIH0KICAgIGZ1bmMgZXF1YWxDYXNlcygpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHJlYWRvbmx5ID8gZXF1YWxDYXNlKCJnZXQiKSA6ICJcKGVxdWFsQ2FzZSgiZ2V0IikpXG5cdFx0XHRcKGVxdWFsQ2FzZSgic2V0IikpIgogICAgfQogICAgZnVuYyBpbnRWYWx1ZUNhc2UoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiByZWFkb25seSA/IGludFZhbHVlQ2FzZSgiZ2V0IikgOiAiXChpbnRWYWx1ZUNhc2UoImdldCIpKVxuXHRcdFx0XChpbnRWYWx1ZUNhc2UoInNldCIpKSIKICAgIH0KICAgIGZ1bmMgaW50VmFsdWVDYXNlKF8gYWNjZXNzb3I6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcGFyYW1zID0gd3JhcHBlZFBhcmFtZXRlcnMuZW51bWVyYXRlZCgpLm1hcCB7IG9mZnNldCwgXyBpbgogICAgICAgICAgICByZXR1cm4gInBcKG9mZnNldCkiCiAgICAgICAgfQogICAgICAgIGxldCBkZWZpbml0aW9ucyA9IHBhcmFtcy5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKSArIChhY2Nlc3NvciA9PSAic2V0IiA/ICIsIF8iIDogIiIpCiAgICAgICAgbGV0IHBhcmFtc1N1bSA9IHBhcmFtcy5tYXAoeyAiXCgkMCkuaW50VmFsdWUiIH0pLmpvaW5lZChzZXBhcmF0b3I6ICIgKyAiKQogICAgICAgIHJldHVybiAiY2FzZSBsZXQgLlwoc3Vic2NyaXB0Q2FzZVByZWZpeChhY2Nlc3NvcikpKFwoZGVmaW5pdGlvbnMpKTogcmV0dXJuIFwocGFyYW1zU3VtKSIKICAgIH0KCiAgICAvLyBHaXZlbgogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yTmFtZSgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVTdHJpbmcgPSByZXR1cm5zU2VsZiA/IHJlcGxhY2VTZWxmIDogVHlwZVdyYXBwZXIod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkuc3RyaXBwZWQKICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBgc3Vic2NyaXB0YFwoZ2VuZXJpY1R5cGVzTW9kaWZpZXIgPz8gIiIpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKCkpLCB3aWxsUmV0dXJuOiBcKHJldHVyblR5cGVTdHJpbmcpLi4uKSAtPiBTdWJzY3JpcHRTdHViIgogICAgfQogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gInJldHVybiBHaXZlbihtZXRob2Q6IC5cKHN1YnNjcmlwdENhc2VQcmVmaXgoImdldCIpKShcKHBhcmFtZXRlcnNGb3JQcm94eUluaXQoKSkpLCBwcm9kdWN0czogd2lsbFJldHVybi5tYXAoeyBTdHViUHJvZHVjdC5yZXR1cm4oJDAgYXMgQW55KSB9KSkiCiAgICB9CgogICAgLy8gVmVyaWZ5CiAgICBmdW5jIHZlcmlmeUNvbnN0cnVjdG9yTmFtZShzZXQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBuZXN0ZWRUeXBlCiAgICAgICAgbGV0IHJldHVybmluZyA9IHNldCA/ICIiIDogcmV0dXJuaW5nUGFyYW1ldGVyKHRydWUsIHRydWUpCiAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgYHN1YnNjcmlwdGBcKGdlbmVyaWNUeXBlc01vZGlmaWVyID8/ICIiKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZSgpKVwocmV0dXJuaW5nKVwoc2V0ID8gIiwgc2V0IG5ld1ZhbHVlOiBcKHJldHVyblR5cGVTdHJpbmcpIiA6ICIiKSkgLT4gVmVyaWZ5IgogICAgfQogICAgZnVuYyB2ZXJpZnlDb25zdHJ1Y3RvcihzZXQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gInJldHVybiBWZXJpZnkobWV0aG9kOiAuXChzdWJzY3JpcHRDYXNlUHJlZml4KHNldCA/ICJzZXQiIDogImdldCIpKShcKHBhcmFtZXRlcnNGb3JQcm94eUluaXQoc2V0OiBzZXQpKSkpIgogICAgfQoKICAgIC8vIEdlbmVyaWNzCiAgICBwcml2YXRlIGZ1bmMgZ2V0R2VuZXJpY3MoKSAtPiBbU3RyaW5nXSB7CiAgICAgICAgcmV0dXJuIGdlbmVyaWNUeXBlc0xpc3QKICAgIH0KCiAgICAvLyBIZWxwZXJzCiAgICBwcml2YXRlIHZhciByZXR1cm5zU2VsZjogQm9vbCB7IHJldHVybiBUeXBlV3JhcHBlcih3cmFwcGVkLnJldHVyblR5cGVOYW1lKS5pc1NlbGZUeXBlIH0KICAgIHByaXZhdGUgdmFyIHJlcGxhY2VTZWxmOiBTdHJpbmcgeyByZXR1cm4gQ3VycmVudC5zZWxmVHlwZSB9CiAgICBwcml2YXRlIGZ1bmMgcmV0dXJuVHlwZVN0cmlwcGVkKHR5cGU6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVJhdyA9ICJcKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpIgogICAgICAgIHZhciBzdHJpcHBlZDogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSByZXR1cm5UeXBlUmF3LnJhbmdlKG9mOiAid2hlcmUiKSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSYXcgfQogICAgICAgICAgICB2YXIgc3RyaXBwZWQgPSByZXR1cm5UeXBlUmF3CiAgICAgICAgICAgIHN0cmlwcGVkLnJlbW92ZVN1YnJhbmdlKChyYW5nZS5sb3dlckJvdW5kKS4uLikKICAgICAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICAgICAgfSgpCiAgICAgICAgc3RyaXBwZWQgPSBzdHJpcHBlZC50cmltbWluZ0NoYXJhY3RlcnMoaW46IENoYXJhY3RlclNldChjaGFyYWN0ZXJzSW46ICIgIikpCiAgICAgICAgZ3VhcmQgdHlwZSBlbHNlIHsgcmV0dXJuIHN0cmlwcGVkIH0KICAgICAgICByZXR1cm4gIihcKHN0cmlwcGVkKSkuVHlwZSIKICAgIH0KICAgIHByaXZhdGUgZnVuYyByZXR1cm5UeXBlTWF0dGVycygpIC0+IEJvb2wgewogICAgICAgIGxldCBjb3VudCA9IFN1YnNjcmlwdFdyYXBwZXIubmFtZXNXaXRob3V0UmV0dXJuVHlwZVtzaG9ydE5hbWVdID8/IDAKICAgICAgICByZXR1cm4gY291bnQgPiAxCiAgICB9CgogICAgLy8gcGFyYW1zCiAgICBwcml2YXRlIGZ1bmMgcmV0dXJuaW5nUGFyYW1ldGVyKF8gbXVsdGlwbGU6IEJvb2wsIF8gZnJvbnQ6IEJvb2wpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgcmV0dXJuVHlwZU1hdHRlcnMoKSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICBsZXQgcmV0dXJuaW5nOiBTdHJpbmcgPSAicmV0dXJuaW5nOiBcKHJldHVyblR5cGVTdHJpcHBlZCh0eXBlOiB0cnVlKSkiCiAgICAgICAgZ3VhcmQgbXVsdGlwbGUgZWxzZSB7IHJldHVybiByZXR1cm5pbmcgfQogICAgICAgIHJldHVybiBmcm9udCA/ICIsIFwocmV0dXJuaW5nKSIgOiAiXChyZXR1cm5pbmcpLCAiCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0Zvck1ldGhvZFR5cGVEZWNsYXJhdGlvbihzZXQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgZ2VuZXJpY3M6IFtTdHJpbmddID0gZ2V0R2VuZXJpY3MoKQogICAgICAgIGxldCBwYXJhbXMgPSB3cmFwcGVkUGFyYW1ldGVycy5tYXAgeyBwYXJhbSBpbgogICAgICAgICAgICByZXR1cm4gcGFyYW0uaXNHZW5lcmljKGdlbmVyaWNzKSA/IHBhcmFtLmdlbmVyaWNUeXBlIDogcGFyYW0ubmVzdGVkVHlwZQogICAgICAgICAgICB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgZ3VhcmQgc2V0IGVsc2UgeyByZXR1cm4gcGFyYW1zIH0KICAgICAgICBsZXQgbmV3VmFsdWUgPSBUeXBlV3JhcHBlcih3cmFwcGVkLnJldHVyblR5cGVOYW1lKS5pc0dlbmVyaWMoZ2VuZXJpY3MpID8gIlBhcmFtZXRlcjxHZW5lcmljQXR0cmlidXRlPiIgOiBuZXN0ZWRUeXBlCiAgICAgICAgcmV0dXJuICJcKHBhcmFtcyksIFwobmV3VmFsdWUpIgogICAgfQogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JQcm94eUluaXQoc2V0OiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdlbmVyaWNzID0gZ2V0R2VuZXJpY3MoKQogICAgICAgIGxldCBuZXdWYWx1ZSA9IFR5cGVXcmFwcGVyKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpLmlzR2VuZXJpYyhnZW5lcmljcykgPyAibmV3VmFsdWUud3JhcEFzR2VuZXJpYygpIiA6ICJuZXdWYWx1ZSIKICAgICAgICByZXR1cm4gd3JhcHBlZFBhcmFtZXRlcnMubWFwIHsgIlwoJDAud3JhcHBlZEZvclByb3h5KGdlbmVyaWNzKSkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikgKyAoc2V0ID8gIiwgXChuZXdWYWx1ZSkiIDogIiIpCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKHNldDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiB3cmFwcGVkUGFyYW1ldGVycy5tYXAgeyAiXCgkMC5sYWJlbEFuZE5hbWUoKSk6IFwoJDAubmVzdGVkVHlwZSkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikgKyAoc2V0ID8gIiwgc2V0IG5ld1ZhbHVlOiBcKG5lc3RlZFR5cGUpIiA6ICIiKQogICAgfQogICAgcHJpdmF0ZSBmdW5jIHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKHNldDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzKCkKICAgICAgICBsZXQgcGFyYW1zID0gd3JhcHBlZFBhcmFtZXRlcnMubWFwIHsgJDAud3JhcHBlZEZvckNhbGxzKGdlbmVyaWNzKSB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgbGV0IHBvc3RmaXggPSBUeXBlV3JhcHBlcih3cmFwcGVkLnJldHVyblR5cGVOYW1lKS5pc0dlbmVyaWMoZ2VuZXJpY3MpID8gIi53cmFwQXNHZW5lcmljKCkiIDogIiIKICAgICAgICByZXR1cm4gIXNldCA/IHBhcmFtcyA6ICJcKHBhcmFtcyksIFwobmVzdGVkVHlwZSkudmFsdWUobmV3VmFsdWUpXChwb3N0Zml4KSIKICAgIH0KfQpjbGFzcyBWYXJpYWJsZVdyYXBwZXIgewogICAgbGV0IHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUKICAgIGxldCBzY29wZTogU3RyaW5nCiAgICB2YXIgcmVhZG9ubHk6IEJvb2wgeyByZXR1cm4gdmFyaWFibGUud3JpdGVBY2Nlc3MuaXNFbXB0eSB9CiAgICB2YXIgcHJpdmF0ZVByb3RvdHlwZU5hbWU6IFN0cmluZyB7IHJldHVybiAiX19wX1wodmFyaWFibGUubmFtZSkiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiYCIsIHdpdGg6ICIiKSB9CiAgICB2YXIgY2FzZXNDb3VudDogSW50IHsgcmV0dXJuIHJlYWRvbmx5ID8gMSA6IDIgfQoKICAgIGxldCBkZXByZWNhdGVkTWVzc2FnZSA9ICJVc2luZyBzZXR0ZXJzIG9uIHJlYWRvbmx5IHZhcmlhYmxlcyBpcyBkZXByZWNhdGVkLCBhbmQgd2lsbCBiZSByZW1vdmVkIGluIDMuMS4gVXNlIEdpdmVuIHRvIGRlZmluZSBzdHViYmVkIHByb3BlcnR5IHJldHVybiB2YWx1ZS4iCiAgICB2YXIgbm9TdHViRGVmaW5lZE1lc3NhZ2U6IFN0cmluZyB7IHJldHVybiAiXChzY29wZSkgLSBzdHViIHZhbHVlIGZvciBcKHZhcmlhYmxlLm5hbWUpIHdhcyBub3QgZGVmaW5lZCIgfQoKICAgIHZhciBnZXR0ZXI6IFN0cmluZyB7CiAgICAgICAgbGV0IHN0YXRpY01vZGlmaWVyID0gdmFyaWFibGUuaXNTdGF0aWMgPyAiXChzY29wZSkuIiA6ICIiCiAgICAgICAgbGV0IHJldHVyblZhbHVlID0gdmFyaWFibGUuaXNPcHRpb25hbCA/ICJvcHRpb25hbEdpdmVuR2V0dGVyVmFsdWUoLlwocHJvcGVydHlDYXNlR2V0TmFtZSksIFwiXChub1N0dWJEZWZpbmVkTWVzc2FnZSlcIikiIDogImdpdmVuR2V0dGVyVmFsdWUoLlwocHJvcGVydHlDYXNlR2V0TmFtZSksIFwiXChub1N0dWJEZWZpbmVkTWVzc2FnZSlcIikiCiAgICAgICAgcmV0dXJuICJcblx0XHRnZXQge1x0XChzdGF0aWNNb2RpZmllcilpbnZvY2F0aW9ucy5hcHBlbmQoLlwocHJvcGVydHlDYXNlR2V0TmFtZSkpOyByZXR1cm4gXChzdGF0aWNNb2RpZmllcilcKHByaXZhdGVQcm90b3R5cGVOYW1lKSA/PyBcKHJldHVyblZhbHVlKSB9IgogICAgfQogICAgdmFyIHNldHRlcjogU3RyaW5nIHsKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXIgPSB2YXJpYWJsZS5pc1N0YXRpYyA/ICJcKHNjb3BlKS4iIDogIiIKICAgICAgICBpZiByZWFkb25seSB7CiAgICAgICAgICAgIGxldCBhbm5vdGF0aW9uID0gcmVhZG9ubHkgPyAiXG5cdFx0QGF2YWlsYWJsZSgqLCBkZXByZWNhdGVkLCBtZXNzYWdlOiBcIlwoZGVwcmVjYXRlZE1lc3NhZ2UpXCIpIiA6ICIiCiAgICAgICAgICAgIHJldHVybiAiXChhbm5vdGF0aW9uKVxuXHRcdHNldCB7XHRcKHZhcmlhYmxlLmlzU3RhdGljID8gIlwoc2NvcGUpLiIgOiAiIilcKHByaXZhdGVQcm90b3R5cGVOYW1lKSA9IG5ld1ZhbHVlIH0iCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcblx0XHRzZXQge1x0XChzdGF0aWNNb2RpZmllcilpbnZvY2F0aW9ucy5hcHBlbmQoLlwocHJvcGVydHlDYXNlU2V0TmFtZSkoLnZhbHVlKG5ld1ZhbHVlKSkpOyBcKHZhcmlhYmxlLmlzU3RhdGljID8gIlwoc2NvcGUpLiIgOiAiIilcKHByaXZhdGVQcm90b3R5cGVOYW1lKSA9IG5ld1ZhbHVlIH0iCiAgICAgICAgfQogICAgfQogICAgdmFyIHByb3RvdHlwZTogU3RyaW5nIHsKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXIgPSB2YXJpYWJsZS5pc1N0YXRpYyA/ICJzdGF0aWMgIiA6ICIiCgogICAgICAgIHJldHVybiAicHVibGljIFwoc3RhdGljTW9kaWZpZXIpdmFyIFwodmFyaWFibGUubmFtZSk6IFwodmFyaWFibGUudHlwZU5hbWUubmFtZSkgeyIgKwogICAgICAgICAgICAiXChnZXR0ZXIpIiArCiAgICAgICAgICAgICJcKHNldHRlcikiICsKICAgICAgICAiXG5cdH0iCiAgICB9CgogICAgdmFyIHByaXZhdGVQcm90b3R5cGU6IFN0cmluZyB7CiAgICAgICAgbGV0IHN0YXRpY01vZGlmaWVyID0gdmFyaWFibGUuaXNTdGF0aWMgPyAic3RhdGljICIgOiAiIgogICAgICAgIHJldHVybiAicHJpdmF0ZSBcKHN0YXRpY01vZGlmaWVyKXZhciBcKHByaXZhdGVQcm90b3R5cGVOYW1lKTogKFwodmFyaWFibGUudHlwZU5hbWUudW53cmFwcGVkVHlwZU5hbWUpKT8iCiAgICB9CiAgICB2YXIgbmVzdGVkVHlwZTogU3RyaW5nIHsgcmV0dXJuICJcKFR5cGVXcmFwcGVyKHZhcmlhYmxlLnR5cGVOYW1lKS5uZXN0ZWRQYXJhbWV0ZXIpIiB9CgogICAgaW5pdChfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUsIHNjb3BlOiBTdHJpbmcpIHsKICAgICAgICBzZWxmLnZhcmlhYmxlID0gdmFyaWFibGUKICAgICAgICBzZWxmLnNjb3BlID0gc2NvcGUKICAgIH0KCiAgICBmdW5jIHByb3BlcnR5R2V0KCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXIgPSB2YXJpYWJsZS5pc1N0YXRpYyA/ICJTdGF0aWMiIDogIiIKICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgdmFyIFwodmFyaWFibGUubmFtZSk6IFwoc3RhdGljTW9kaWZpZXIpVmVyaWZ5IHsgcmV0dXJuIFwoc3RhdGljTW9kaWZpZXIpVmVyaWZ5KG1ldGhvZDogLlwocHJvcGVydHlDYXNlR2V0TmFtZSkpIH0iCiAgICB9CgogICAgZnVuYyBwcm9wZXJ0eVNldCgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHN0YXRpY01vZGlmaWVyID0gdmFyaWFibGUuaXNTdGF0aWMgPyAiU3RhdGljIiA6ICIiCiAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXCh2YXJpYWJsZS5uYW1lKShzZXQgbmV3VmFsdWU6IFwobmVzdGVkVHlwZSkpIC0+IFwoc3RhdGljTW9kaWZpZXIpVmVyaWZ5IHsgcmV0dXJuIFwoc3RhdGljTW9kaWZpZXIpVmVyaWZ5KG1ldGhvZDogLlwocHJvcGVydHlDYXNlU2V0TmFtZSkobmV3VmFsdWUpKSB9IgogICAgfQoKICAgIHZhciBwcm9wZXJ0eUNhc2VHZXROYW1lOiBTdHJpbmcgeyByZXR1cm4gInBfXCh2YXJpYWJsZS5uYW1lKV9nZXQiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiYCIsIHdpdGg6ICIiKSB9CiAgICBmdW5jIHByb3BlcnR5Q2FzZUdldCgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJjYXNlIFwocHJvcGVydHlDYXNlR2V0TmFtZSkiCiAgICB9CiAgICBmdW5jIHByb3BlcnR5Q2FzZUdldENvbXBhcmUoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiY2FzZSAoLlwocHJvcGVydHlDYXNlR2V0TmFtZSksLlwocHJvcGVydHlDYXNlR2V0TmFtZSkpOiByZXR1cm4gdHJ1ZSIKICAgIH0KICAgIGZ1bmMgcHJvcGVydHlDYXNlR2V0SW50VmFsdWUoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiY2FzZSAuXChwcm9wZXJ0eUNhc2VHZXROYW1lKTogcmV0dXJuIDAiCiAgICB9CgogICAgdmFyIHByb3BlcnR5Q2FzZVNldE5hbWU6IFN0cmluZyB7IHJldHVybiAicF9cKHZhcmlhYmxlLm5hbWUpX3NldCIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJgIiwgd2l0aDogIiIpIH0KICAgIGZ1bmMgcHJvcGVydHlDYXNlU2V0KCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gImNhc2UgXChwcm9wZXJ0eUNhc2VTZXROYW1lKShcKG5lc3RlZFR5cGUpKSIKICAgIH0KICAgIGZ1bmMgcHJvcGVydHlDYXNlU2V0Q29tcGFyZSgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJjYXNlICguXChwcm9wZXJ0eUNhc2VTZXROYW1lKShsZXQgbGVmdCksLlwocHJvcGVydHlDYXNlU2V0TmFtZSkobGV0IHJpZ2h0KSk6IHJldHVybiBcKG5lc3RlZFR5cGUpLmNvbXBhcmUobGhzOiBsZWZ0LCByaHM6IHJpZ2h0LCB3aXRoOiBtYXRjaGVyKSIKICAgIH0KICAgIGZ1bmMgcHJvcGVydHlDYXNlU2V0SW50VmFsdWUoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiY2FzZSAuXChwcm9wZXJ0eUNhc2VTZXROYW1lKShsZXQgbmV3VmFsdWUpOiByZXR1cm4gbmV3VmFsdWUuaW50VmFsdWUiCiAgICB9CgogICAgLy8gR2l2ZW4KICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKHZhcmlhYmxlLm5hbWUpKGdldHRlciBkZWZhdWx0VmFsdWU6IFwoVHlwZVdyYXBwZXIodmFyaWFibGUudHlwZU5hbWUpLnN0cmlwcGVkKS4uLikgLT4gXChwcmVmaXgpUHJvcGVydHlTdHViIgogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3RvcihwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KUdpdmVuKG1ldGhvZDogLlwocHJvcGVydHlDYXNlR2V0TmFtZSksIHByb2R1Y3RzOiBkZWZhdWx0VmFsdWUubWFwKHsgU3R1YlByb2R1Y3QucmV0dXJuKCQwIGFzIEFueSkgfSkpIgogICAgfQp9Cl8lPgo8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU0VUVVAgLSU+PCVfIC0lPgo8JV8gdmFyIGFsbCA9IHR5cGVzLmFsbAogICAgYWxsICs9IHR5cGVzLnByb3RvY29scy5tYXAgeyAkMCB9IC0lPgoKPCVfIGZvciB0eXBlIGluIGFsbCB7IC0lPjwlXyAtJT4KPCVfIGxldCBhdXRvTW9ja2FibGU6IEJvb2wgPSB0eXBlLmluaGVyaXRlZFR5cGVzLmNvbnRhaW5zKCJBdXRvTW9ja2FibGUiKSB8fCB0eXBlLmFubm90YXRpb25zWyJBdXRvTW9ja2FibGUiXSAhPSBuaWwKICAgIGxldCBwcm90b2NvbFRvRGVjb3JhdGUgPSB0eXBlcy5wcm90b2NvbHMuZmlyc3Qod2hlcmU6IHsgJDAubmFtZSA9PSAodHlwZS5hbm5vdGF0aW9uc1sibW9jayJdIGFzPyBTdHJpbmcpIH0pCiAgICBsZXQgaW5saW5lTW9ja2FibGUgPSBwcm90b2NvbFRvRGVjb3JhdGUgIT0gbmlsCiAgICBndWFyZCBsZXQgYVByb3RvY29sID0gYXV0b01vY2thYmxlID8gdHlwZSA6IHByb3RvY29sVG9EZWNvcmF0ZSBlbHNlIHsgY29udGludWUgfQogICAgbGV0IGFzc29jaWF0ZWRUeXBlczogW1N0cmluZ10/ID0gSGVscGVycy5leHRyYWN0QXNzb2NpYXRlZFR5cGVzKGZyb206IGFQcm90b2NvbCkKICAgIGxldCBnZW5lcmljVHlwZXNNb2RpZmllcjogU3RyaW5nID0gSGVscGVycy5leHRyYWN0R2VuZXJpY1R5cGVzTW9kaWZpZXIoYXNzb2NpYXRlZFR5cGVzKQogICAgbGV0IGdlbmVyaWNUeXBlc0NvbnN0cmFpbnRzOiBTdHJpbmcgPSBIZWxwZXJzLmV4dHJhY3RHZW5lcmljVHlwZXNDb25zdHJhaW50cyhhc3NvY2lhdGVkVHlwZXMpCiAgICBsZXQgYWxsU3Vic2NyaXB0cyA9IGFQcm90b2NvbC5hbGxTdWJzY3JpcHRzCiAgICBsZXQgYWxsVmFyaWFibGVzID0gdW5pcXVlcyh2YXJpYWJsZXM6IGFQcm90b2NvbC5hbGxWYXJpYWJsZXMuZmlsdGVyKHsgISQwLmlzU3RhdGljIH0pKQogICAgbGV0IGNvbnRhaW5zVmFyaWFibGVzID0gIWFsbFZhcmlhYmxlcy5pc0VtcHR5CiAgICBsZXQgYWxsU3RhdGljVmFyaWFibGVzID0gdW5pcXVlcyh2YXJpYWJsZXM6IGFQcm90b2NvbC5hbGxWYXJpYWJsZXMuZmlsdGVyKHsgJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgY29udGFpbnNTdGF0aWNWYXJpYWJsZXMgPSAhYWxsU3RhdGljVmFyaWFibGVzLmlzRW1wdHkKICAgIGxldCBhbGxNZXRob2RzID0gdW5pcXVlcyhtZXRob2RzOiBhUHJvdG9jb2wuYWxsTWV0aG9kcy5maWx0ZXIoeyAhJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgYWNjZXNzTW9kaWZpZXI6IFN0cmluZyA9IHsKICAgICAgICBsZXQgc2VsZkNvbnN0cmFpbmVkID0gYWxsTWV0aG9kcy5tYXAod3JhcE1ldGhvZCkuY29udGFpbnMod2hlcmU6IHsgJDAucmV0dXJuc0dlbmVyaWNDb25zdHJhaW5lZFRvU2VsZiB9KQogICAgICAgIHJldHVybiBzZWxmQ29uc3RyYWluZWQgPyAicHVibGljIGZpbmFsIiA6ICJvcGVuIgogICAgfSgpCiAgICBsZXQgYWxsTWV0aG9kc0Zvck1ldGhvZFR5cGUgPSB1bmlxdWVzV2l0aG91dEdlbmVyaWNDb25zdHJhaW50cyhtZXRob2RzOiBhUHJvdG9jb2wuYWxsTWV0aG9kcy5maWx0ZXIoeyAhJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgYWxsU3RhdGljTWV0aG9kcyA9IHVuaXF1ZXMobWV0aG9kczogYVByb3RvY29sLmFsbE1ldGhvZHMuZmlsdGVyKHsgJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgYWxsU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgPSB1bmlxdWVzV2l0aG91dEdlbmVyaWNDb25zdHJhaW50cyhtZXRob2RzOiBhUHJvdG9jb2wuYWxsTWV0aG9kcy5maWx0ZXIoeyAkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBjb25mb3Jtc1RvU3RhdGljTW9jayA9ICFhbGxTdGF0aWNNZXRob2RzLmlzRW1wdHkgfHwgIWFsbFN0YXRpY1ZhcmlhYmxlcy5pc0VtcHR5CiAgICBsZXQgY29uZm9ybXNUb01vY2sgPSAhYWxsTWV0aG9kcy5pc0VtcHR5IHx8ICFhbGxWYXJpYWJsZXMuaXNFbXB0eSAtJT48JV8gLSU+PCVfIC0lPgo8JV8gaWYgYXV0b01vY2thYmxlIHsgLSU+Ci8vIE1BUks6IC0gPCU9IHR5cGUubmFtZSAlPgo8JT0gYWNjZXNzTW9kaWZpZXIgJT4gY2xhc3MgPCU9IHR5cGUubmFtZSAlPk1vY2s8JT0gZ2VuZXJpY1R5cGVzTW9kaWZpZXIgJT46PCU9IHR5cGUuYW5ub3RhdGlvbnNbIk9iamNQcm90b2NvbCJdICE9IG5pbCA/ICIgTlNPYmplY3QsIiA6ICIiICU+IDwlPSB0eXBlLm5hbWUgJT4sIE1vY2s8JT0gY29uZm9ybXNUb1N0YXRpY01vY2sgPyAiLCBTdGF0aWNNb2NrIiA6ICIiICU+PCU9IGdlbmVyaWNUeXBlc0NvbnN0cmFpbnRzICU+IHsKICAgIGluaXQoc2VxdWVuY2luZyBzZXF1ZW5jaW5nUG9saWN5OiBTZXF1ZW5jaW5nUG9saWN5ID0gLmxhc3RXcml0dGVuUmVzb2x2ZWRGaXJzdCwgc3R1YmJpbmcgc3R1YmJpbmdQb2xpY3k6IFN0dWJiaW5nUG9saWN5ID0gLndyYXAsIGZpbGU6IFN0YXRpY1N0cmluZyA9ICNmaWxlLCBsaW5lOiBVSW50ID0gI2xpbmUpIHsKICAgICAgICBTd2lmdHlNb2NreVRlc3RPYnNlcnZlci5zZXR1cCgpCiAgICAgICAgc2VsZi5zZXF1ZW5jaW5nUG9saWN5ID0gc2VxdWVuY2luZ1BvbGljeQogICAgICAgIHNlbGYuc3R1YmJpbmdQb2xpY3kgPSBzdHViYmluZ1BvbGljeQogICAgICAgIHNlbGYuZmlsZSA9IGZpbGUKICAgICAgICBzZWxmLmxpbmUgPSBsaW5lCiAgICB9Cgo8JV8gfSBlbHNlIHsgLSU+Ci8vIHNvdXJjZXJ5OmlubGluZTphdXRvOjwlPSB0eXBlLm5hbWUgJT4uYXV0b01vY2tlZAo8JV8gfSAtJT4KPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1BSU4gQ0xBU1MgLSU+PCVfIC0lPgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBNT0NLIElOVEVSTkFMUyAtJT48JV8gLSU+CiAgICB2YXIgbWF0Y2hlcjogTWF0Y2hlciA9IE1hdGNoZXIuZGVmYXVsdAogICAgdmFyIHN0dWJiaW5nUG9saWN5OiBTdHViYmluZ1BvbGljeSA9IC53cmFwCiAgICB2YXIgc2VxdWVuY2luZ1BvbGljeTogU2VxdWVuY2luZ1BvbGljeSA9IC5sYXN0V3JpdHRlblJlc29sdmVkRmlyc3QKICAgIHByaXZhdGUgdmFyIGludm9jYXRpb25zOiBbTWV0aG9kVHlwZV0gPSBbXQogICAgcHJpdmF0ZSB2YXIgbWV0aG9kUmV0dXJuVmFsdWVzOiBbR2l2ZW5dID0gW10KICAgIHByaXZhdGUgdmFyIG1ldGhvZFBlcmZvcm1WYWx1ZXM6IFtQZXJmb3JtXSA9IFtdCiAgICBwcml2YXRlIHZhciBmaWxlOiBTdGF0aWNTdHJpbmc/CiAgICBwcml2YXRlIHZhciBsaW5lOiBVSW50PwoKICAgIHB1YmxpYyB0eXBlYWxpYXMgUHJvcGVydHlTdHViID0gR2l2ZW4KICAgIHB1YmxpYyB0eXBlYWxpYXMgTWV0aG9kU3R1YiA9IEdpdmVuCiAgICBwdWJsaWMgdHlwZWFsaWFzIFN1YnNjcmlwdFN0dWIgPSBHaXZlbgoKICAgIC8vLyBDb252ZW5pZW5jZSBtZXRob2QgLSBjYWxsIHNldHVwTW9jaygpIHRvIGV4dGVuZCBkZWJ1ZyBpbmZvcm1hdGlvbiB3aGVuIGZhaWx1cmUgb2NjdXJzCiAgICBwdWJsaWMgZnVuYyBzZXR1cE1vY2soZmlsZTogU3RhdGljU3RyaW5nID0gI2ZpbGUsIGxpbmU6IFVJbnQgPSAjbGluZSkgewogICAgICAgIHNlbGYuZmlsZSA9IGZpbGUKICAgICAgICBzZWxmLmxpbmUgPSBsaW5lCiAgICB9CiAgICA8JV8gLSU+CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNUQVRJQyBNT0NLIElOVEVSTkFMUyAtJT48JV8gLSU+CiAgICA8JV8gaWYgY29uZm9ybXNUb1N0YXRpY01vY2sgeyAtJT4KICAgIHN0YXRpYyB2YXIgbWF0Y2hlcjogTWF0Y2hlciA9IE1hdGNoZXIuZGVmYXVsdAogICAgc3RhdGljIHZhciBzdHViYmluZ1BvbGljeTogU3R1YmJpbmdQb2xpY3kgPSAud3JhcAogICAgc3RhdGljIHZhciBzZXF1ZW5jaW5nUG9saWN5OiBTZXF1ZW5jaW5nUG9saWN5ID0gLmxhc3RXcml0dGVuUmVzb2x2ZWRGaXJzdAogICAgc3RhdGljIHByaXZhdGUgdmFyIGludm9jYXRpb25zOiBbU3RhdGljTWV0aG9kVHlwZV0gPSBbXQogICAgc3RhdGljIHByaXZhdGUgdmFyIG1ldGhvZFJldHVyblZhbHVlczogW1N0YXRpY0dpdmVuXSA9IFtdCiAgICBzdGF0aWMgcHJpdmF0ZSB2YXIgbWV0aG9kUGVyZm9ybVZhbHVlczogW1N0YXRpY1BlcmZvcm1dID0gW10KICAgIHB1YmxpYyB0eXBlYWxpYXMgU3RhdGljUHJvcGVydHlTdHViID0gU3RhdGljR2l2ZW4KICAgIHB1YmxpYyB0eXBlYWxpYXMgU3RhdGljTWV0aG9kU3R1YiA9IFN0YXRpY0dpdmVuCiAgICBwdWJsaWMgc3RhdGljIGZ1bmMgY2xlYXIoKSB7CiAgICAgICAgaW52b2NhdGlvbnMgPSBbXQogICAgICAgIG1ldGhvZFJldHVyblZhbHVlcyA9IFtdCiAgICAgICAgbWV0aG9kUGVyZm9ybVZhbHVlcyA9IFtdCiAgICB9CiAgICA8JV8gIH0gLSU+CgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBWQVJJQUJMRVMgLSU+PCVfIC0lPgogICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyAtJT4KICAgIDwlXyBpZiBhdXRvTW9ja2FibGUgeyAtJT4KICAgIDwlPSBzdHViUHJvcGVydHkodmFyaWFibGUsIlwodHlwZS5uYW1lKU1vY2siKSAlPgogICAgPCVfIH0gZWxzZSB7ICU+CiAgICA8JT0gc3R1YlByb3BlcnR5KHZhcmlhYmxlLCJcKHR5cGUubmFtZSkiKSAlPgogICAgPCVfIH0gJT4KICAgIDwlXyB9ICU+IDwlXyAtJT4KCiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNUQVRJQyBWQVJJQUJMRVMgLSU+PCVfIC0lPgogICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyAtJT4KICAgIDwlXyBpZiBhdXRvTW9ja2FibGUgeyAtJT4KICAgIDwlPSBzdHViUHJvcGVydHkodmFyaWFibGUsIlwodHlwZS5uYW1lKU1vY2siKSAlPgogICAgPCVfIH0gZWxzZSB7ICU+CiAgICA8JT0gc3R1YlByb3BlcnR5KHZhcmlhYmxlLCJcKHR5cGUubmFtZSkiKSAlPgogICAgPCVfIH0gJT4KICAgIDwlXyB9ICU+IDwlXyAtJT4KCiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1FVEhPRCBSRUdJU1RSQVRJT05TIC0lPjwlXyAtJT4KICAgIDwlXyBNZXRob2RXcmFwcGVyLmNsZWFyKCkgLSU+CiAgICA8JV8gU3Vic2NyaXB0V3JhcHBlci5jbGVhcigpIC0lPgogICAgPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgogICAgPCVfIEN1cnJlbnQuc2VsZlR5cGUgPSAiXCh0eXBlLm5hbWUpTW9ja1woZ2VuZXJpY1R5cGVzTW9kaWZpZXIpIiAtJT4KICAgIDwlXyB9IGVsc2UgeyAlPgogICAgPCVfIEN1cnJlbnQuc2VsZlR5cGUgPSAiXCh0eXBlLm5hbWUpTW9ja1woZ2VuZXJpY1R5cGVzTW9kaWZpZXIpIiAtJT4KICAgIDwlXyB9ICU+CiAgICA8JV8gbGV0IHdyYXBwZWRTdWJzY3JpcHRzID0gYWxsU3Vic2NyaXB0cy5tYXAod3JhcFN1YnNjcmlwdCkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRNZXRob2RzID0gYWxsTWV0aG9kcy5tYXAod3JhcE1ldGhvZCkuZmlsdGVyKHsgJDAud3JhcHBlZEluTWV0aG9kVHlwZSgpIH0pIC0lPgogICAgPCVfIGxldCB3cmFwcGVkVmFyaWFibGVzID0gYWxsVmFyaWFibGVzLm1hcChqdXN0V3JhcCkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZSA9IGFsbE1ldGhvZHNGb3JNZXRob2RUeXBlLm1hcCh3cmFwTWV0aG9kKS5maWx0ZXIoeyAkMC53cmFwcGVkSW5NZXRob2RUeXBlKCkgfSkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRJbml0aWFsaXplcnMgPSBhbGxNZXRob2RzLm1hcCh3cmFwTWV0aG9kKS5maWx0ZXIoeyAkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZFN0YXRpY01ldGhvZHMgPSBhbGxTdGF0aWNNZXRob2RzLm1hcCh3cmFwTWV0aG9kKS5maWx0ZXIoeyAkMC53cmFwcGVkSW5NZXRob2RUeXBlKCkgfSkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRTdGF0aWNWYXJpYWJsZXMgPSBhbGxTdGF0aWNWYXJpYWJsZXMubWFwKGp1c3RXcmFwKSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlID0gYWxsU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUubWFwKHdyYXBNZXRob2QpLmZpbHRlcih7ICQwLndyYXBwZWRJbk1ldGhvZFR5cGUoKSB9KSAtJT4KICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgcHJvcGVydHlSZWdpc3Rlcih2YXJpYWJsZSkgfSAtJT4KICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgcHJvcGVydHlSZWdpc3Rlcih2YXJpYWJsZSkgfSAtJT4KICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzIHsgbWV0aG9kLnJlZ2lzdGVyKCkgfSAtJT4KICAgIDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IHdyYXBwZWQucmVnaXN0ZXIoKSB9IC0lPgogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHMgeyBtZXRob2QucmVnaXN0ZXIoKSB9IC0lPjwlXyAtJT4KICAgIDwlXyBsZXQgdmFyaWFibGVDYXNlc0NvdW50OiBJbnQgPSB3cmFwcGVkVmFyaWFibGVzLnJlZHVjZSgwKSB7IHJldHVybiAkMCArICQxLmNhc2VzQ291bnQgfSAtJT48JV8gLSU+CiAgICA8JV8gbGV0IHN1YnNjcmlwdHNDYXNlc0NvdW50OiBJbnQgPSB3cmFwcGVkU3Vic2NyaXB0cy5yZWR1Y2UoMCkgeyByZXR1cm4gJDAgKyAkMS5jYXNlc0NvdW50IH0gLSU+PCVfIC0lPgogICAgPCVfIGxldCBzdGF0aWNWYXJpYWJsZUNhc2VzQ291bnQ6IEludCA9IHdyYXBwZWRTdGF0aWNWYXJpYWJsZXMucmVkdWNlKDApIHsgcmV0dXJuICQwICsgJDEuY2FzZXNDb3VudCB9IC0lPjwlXyAtJT4KICAgIDwlXyBsZXQgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JNZXRob2RzOiBCb29sID0gZmFsc2UgLSU+PCVfIC0lPgogICAgPCVfIGxldCBnZW5lcmF0ZU9sZEFjY2Vzc29yc0ZvclN0YXRpY01ldGhvZHM6IEJvb2wgPSBmYWxzZSAtJT48JV8gLSU+CgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVEFUSUMgU1RVQlMgLSU+PCVfIC0lPgogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHMgeyAtJT4KICAgIDwlPSBtZXRob2QuZnVuY3Rpb25Qcm90b3R5cGUgXyU+IHsKICAgICAgICA8JT0gbWV0aG9kLnN0dWJCb2R5KCkgXyU+CiAgICB9CgogICAgPCVfIH0gJT48JV8gLSU+CiAgICA8JV8gLSU+CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IElOSVRJQUxJWkVSUyAtJT48JV8gLSU+CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkSW5pdGlhbGl6ZXJzIHsgLSU+CiAgICA8JT0gbWV0aG9kLmZ1bmN0aW9uUHJvdG90eXBlIF8lPiB7IH0KCiAgICA8JV8gfSAtJT48JV8gLSU+CiAgICA8JV8gLSU+PCVfIC0lPgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVFVCUyAtJT48JV8gLSU+CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kcyB7IC0lPgogICAgPCU9IG1ldGhvZC5mdW5jdGlvblByb3RvdHlwZSBfJT4gewogICAgICAgIDwlPSBtZXRob2Quc3R1YkJvZHkoKSBfJT4KICAgIH0KCiAgICA8JV8gfSAtJT4KICAgIDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IC0lPgogICAgPCU9IHdyYXBwZWQuc3Vic2NyaXB0Q2FsbCgpIF8lPgoKICAgIDwlXyB9IC0lPgogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVEFUSUMgTUVUSE9EIFRZUEUgLSU+PCVfIC0lPgogICAgPCVfIGlmIGNvbmZvcm1zVG9TdGF0aWNNb2NrIHsgLSU+CiAgICBmaWxlcHJpdmF0ZSBlbnVtIFN0YXRpY01ldGhvZFR5cGUgewogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlIHsgLSU+CiAgICAgICAgY2FzZSA8JT0gbWV0aG9kLm1ldGhvZFR5cGVEZWNsYXJhdGlvbldpdGhQYXJhbWV0ZXJzKCkgXyU+CiAgICA8JV8gIH0gJT4gPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyAtJT4KICAgICAgICA8JT0gcHJvcGVydHlNZXRob2RUeXBlcyh2YXJpYWJsZSkgJT4KICAgIDwlXyB9ICU+IDwlXyAlPgogICAgPCVfIC0lPgogICAgICAgIHN0YXRpYyBmdW5jIGNvbXBhcmVQYXJhbWV0ZXJzKGxoczogU3RhdGljTWV0aG9kVHlwZSwgcmhzOiBTdGF0aWNNZXRob2RUeXBlLCBtYXRjaGVyOiBNYXRjaGVyKSAtPiBCb29sIHsKICAgICAgICAgICAgc3dpdGNoIChsaHMsIHJocykgeyA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAlPgogICAgICAgICAgICA8JT0gbWV0aG9kLmVxdWFsQ2FzZSAtJT48JSBmb3IgcGFyYW1ldGVyIGluIG1ldGhvZC5wYXJhbWV0ZXJzIHsgJT4KICAgICAgICAgICAgICAgIDwlPSBwYXJhbWV0ZXIuY29tcGFyYXRvciAtJT4gPCUgIH0gJT4KICAgICAgICAgICAgICAgIHJldHVybiB0cnVlIDwlIH0gJT4KICAgICAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyAtJT4KICAgICAgICAgICAgPCU9IHByb3BlcnR5TWV0aG9kVHlwZXNDb21wYXJlKHZhcmlhYmxlKSAlPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4gPCVfIGlmIHdyYXBwZWRTdGF0aWNNZXRob2RzLmNvdW50ICsgc3RhdGljVmFyaWFibGVDYXNlc0NvdW50ID4gMSB7IC0lPgogICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2UKICAgICAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICA8JV8gJT4KICAgICAgICBmdW5jIGludFZhbHVlKCkgLT4gSW50IHsKICAgICAgICAgICAgc3dpdGNoIHNlbGYgeyA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAlPgogICAgICAgICAgICAgICAgPCU9IG1ldGhvZC5pbnRWYWx1ZUNhc2UgLSU+PCUgfSAlPgogICAgICAgICAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyAtJT4KICAgICAgICAgICAgICAgIDwlPSBwcm9wZXJ0eU1ldGhvZFR5cGVzSW50VmFsdWUodmFyaWFibGUpICU+CiAgICAgICAgICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgb3BlbiBjbGFzcyBTdGF0aWNHaXZlbjogU3R1YmJlZE1ldGhvZCB7CiAgICAgICAgZmlsZXByaXZhdGUgdmFyIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZQoKICAgICAgICBwcml2YXRlIGluaXQobWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlLCBwcm9kdWN0czogW1N0dWJQcm9kdWN0XSkgewogICAgICAgICAgICBzZWxmLm1ldGhvZCA9IG1ldGhvZAogICAgICAgICAgICBzdXBlci5pbml0KHByb2R1Y3RzKQogICAgICAgIH0KCiAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyAtJT4KICAgICAgICA8JT0gd3JhcFByb3BlcnR5KHZhcmlhYmxlKS5naXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiKSAtJT4gewogICAgICAgICAgICA8JT0gd3JhcFByb3BlcnR5KHZhcmlhYmxlKS5naXZlbkNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAlPiA8JV8gJT4KICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUuZmlsdGVyKHsgISQwLm1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgJiYgISQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0ZvclN0YXRpY01ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZS5maWx0ZXIoeyAhJDAubWV0aG9kLnRocm93cyAmJiAhJDAubWV0aG9kLnJldGhyb3dzICYmICEkMC5tZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkICYmICEkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZS5maWx0ZXIoeyAoJDAubWV0aG9kLnRocm93cyB8fCAkMC5tZXRob2QucmV0aHJvd3MpICYmICEkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWVUaHJvd3MocHJlZml4OiAiU3RhdGljIikgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yVGhyb3dzKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JTdGF0aWNNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lVGhyb3dzKHByZWZpeDogIlN0YXRpYyIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yVGhyb3dzKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yTmFtZVRocm93cyhwcmVmaXg6ICJTdGF0aWMiKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yVGhyb3dzKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICB9CgogICAgcHVibGljIHN0cnVjdCBTdGF0aWNWZXJpZnkgewogICAgICAgIGZpbGVwcml2YXRlIHZhciBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUKCiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiKSAtJT4geyA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+IH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JTdGF0aWNNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPiB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsU3RhdGljVmFyaWFibGVzIHsgLSU+CiAgICAgICAgPCU9IHByb3BlcnR5VHlwZXModmFyaWFibGUpICU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgfQoKICAgIHB1YmxpYyBzdHJ1Y3QgU3RhdGljUGVyZm9ybSB7CiAgICAgICAgZmlsZXByaXZhdGUgdmFyIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZQogICAgICAgIHZhciBwZXJmb3JtczogQW55CgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0ZvclN0YXRpY01ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgfQoKICAgIDwlIH0gLSU+CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1FVEhPRCBUWVBFIC0lPjwlXyAtJT4KICAgIDwlXyBpZiAhd3JhcHBlZE1ldGhvZHMuaXNFbXB0eSB8fCAhYWxsVmFyaWFibGVzLmlzRW1wdHkgfHwgIWFsbFN1YnNjcmlwdHMuaXNFbXB0eSB7IC0lPgoKICAgIGZpbGVwcml2YXRlIGVudW0gTWV0aG9kVHlwZSB7CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAtJT4KICAgICAgICBjYXNlIDwlPSBtZXRob2QubWV0aG9kVHlwZURlY2xhcmF0aW9uV2l0aFBhcmFtZXRlcnMoKSBfJT4KICAgIDwlXyAgfSAtJT4gPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyAtJT4KICAgICAgICA8JT0gcHJvcGVydHlNZXRob2RUeXBlcyh2YXJpYWJsZSkgJT4KICAgIDwlXyB9ICU+IDwlXyAlPiA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyAtJT4KICAgICAgICA8JT0gd3JhcHBlZC5zdWJzY3JpcHRDYXNlcygpIF8lPgogICAgPCVfIH0gJT4gPCVfICU+CiAgICA8JV8gLSU+CiAgICAgICAgc3RhdGljIGZ1bmMgY29tcGFyZVBhcmFtZXRlcnMobGhzOiBNZXRob2RUeXBlLCByaHM6IE1ldGhvZFR5cGUsIG1hdGNoZXI6IE1hdGNoZXIpIC0+IEJvb2wgewogICAgICAgICAgICBzd2l0Y2ggKGxocywgcmhzKSB7IDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZSB7ICU+CiAgICAgICAgICAgIDwlPSBtZXRob2QuZXF1YWxDYXNlIC0lPjwlIGZvciBwYXJhbWV0ZXIgaW4gbWV0aG9kLnBhcmFtZXRlcnMgeyAlPgogICAgICAgICAgICAgICAgPCU9IHBhcmFtZXRlci5jb21wYXJhdG9yIC0lPiA8JSAgfSAlPgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWUgPCUgfSAlPgogICAgICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IC0lPgogICAgICAgICAgICA8JT0gcHJvcGVydHlNZXRob2RUeXBlc0NvbXBhcmUodmFyaWFibGUpICU+CiAgICAgICAgICAgIDwlXyB9ICU+IDwlXyAtJT4gPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgLSU+CiAgICAgICAgICAgIDwlPSB3cmFwcGVkLmVxdWFsQ2FzZXMoKSAlPgogICAgICAgIDwlXyB9ICU+IDwlXyBpZiB3cmFwcGVkTWV0aG9kcy5jb3VudCArIHZhcmlhYmxlQ2FzZXNDb3VudCArIHN1YnNjcmlwdHNDYXNlc0NvdW50ID4gMSB7IC0lPgogICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gZmFsc2UKICAgICAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICA8JV8gJT4KICAgICAgICBmdW5jIGludFZhbHVlKCkgLT4gSW50IHsKICAgICAgICAgICAgc3dpdGNoIHNlbGYgeyA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAlPgogICAgICAgICAgICA8JT0gbWV0aG9kLmludFZhbHVlQ2FzZSAtJT48JSB9ICU+CiAgICAgICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgLSU+CiAgICAgICAgICAgIDwlPSBwcm9wZXJ0eU1ldGhvZFR5cGVzSW50VmFsdWUodmFyaWFibGUpICU+CiAgICAgICAgICAgIDwlXyB9ICU+IDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IC0lPgogICAgICAgICAgICA8JT0gd3JhcHBlZC5pbnRWYWx1ZUNhc2UoKSAlPgogICAgICAgICAgICA8JV8gfSAtJT4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIDwlXyB9IGVsc2UgeyAlPgogICAgZmlsZXByaXZhdGUgc3RydWN0IE1ldGhvZFR5cGUgewogICAgICAgIHN0YXRpYyBmdW5jIGNvbXBhcmVQYXJhbWV0ZXJzKGxoczogTWV0aG9kVHlwZSwgcmhzOiBNZXRob2RUeXBlLCBtYXRjaGVyOiBNYXRjaGVyKSAtPiBCb29sIHsgcmV0dXJuIHRydWUgfQogICAgICAgIGZ1bmMgaW50VmFsdWUoKSAtPiBJbnQgeyByZXR1cm4gMCB9CiAgICB9CiAgICA8JV8gfSAtJT48JV8gLSU+CgogICAgb3BlbiBjbGFzcyBHaXZlbjogU3R1YmJlZE1ldGhvZCB7CiAgICAgICAgZmlsZXByaXZhdGUgdmFyIG1ldGhvZDogTWV0aG9kVHlwZQoKICAgICAgICBwcml2YXRlIGluaXQobWV0aG9kOiBNZXRob2RUeXBlLCBwcm9kdWN0czogW1N0dWJQcm9kdWN0XSkgewogICAgICAgICAgICBzZWxmLm1ldGhvZCA9IG1ldGhvZAogICAgICAgICAgICBzdXBlci5pbml0KHByb2R1Y3RzKQogICAgICAgIH0KCiAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyAtJT4KICAgICAgICA8JT0gd3JhcFByb3BlcnR5KHZhcmlhYmxlKS5naXZlbkNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7CiAgICAgICAgICAgIDwlPSB3cmFwUHJvcGVydHkodmFyaWFibGUpLmdpdmVuQ29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gJT4gPCVfICU+CiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlLmZpbHRlcih7ICEkMC5tZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkICYmICEkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUoKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUuZmlsdGVyKHsgISQwLm1ldGhvZC50aHJvd3MgJiYgISQwLm1ldGhvZC5yZXRocm93cyAmJiAhJDAubWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiAhJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgLSU+CiAgICAgICAgPCU9IHdyYXBwZWQuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWUoKSAtJT4gewogICAgICAgICAgICA8JT0gd3JhcHBlZC5naXZlbkNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZS5maWx0ZXIoeyAoJDAubWV0aG9kLnRocm93cyB8fCAkMC5tZXRob2QucmV0aHJvd3MpICYmICEkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWVUaHJvd3MoKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JUaHJvd3MoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZVRocm93cyhwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvclRocm93cygpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yTmFtZVRocm93cygpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JUaHJvd3MoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgfQoKICAgIHB1YmxpYyBzdHJ1Y3QgVmVyaWZ5IHsKICAgICAgICBmaWxlcHJpdmF0ZSB2YXIgbWV0aG9kOiBNZXRob2RUeXBlCgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3Rvck5hbWUoKSAtJT4geyA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3IoKSBfJT4gfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0Zvck1ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4geyA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3IoKSBfJT4gfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IC0lPgogICAgICAgIDwlPSBwcm9wZXJ0eVR5cGVzKHZhcmlhYmxlKSAlPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgICAgICA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyAtJT4KICAgICAgICA8JT0gd3JhcHBlZC52ZXJpZnlDb25zdHJ1Y3Rvck5hbWUoKSAtJT4geyA8JT0gd3JhcHBlZC52ZXJpZnlDb25zdHJ1Y3RvcigpIF8lPiB9CiAgICAgICAgPCVfIGlmICF3cmFwcGVkLnJlYWRvbmx5IHsgLSU+CiAgICAgICAgPCU9IHdyYXBwZWQudmVyaWZ5Q29uc3RydWN0b3JOYW1lKHNldDogdHJ1ZSkgLSU+IHsgPCU9IHdyYXBwZWQudmVyaWZ5Q29uc3RydWN0b3Ioc2V0OiB0cnVlKSBfJT4gfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgIH0KCiAgICBwdWJsaWMgc3RydWN0IFBlcmZvcm0gewogICAgICAgIGZpbGVwcml2YXRlIHZhciBtZXRob2Q6IE1ldGhvZFR5cGUKICAgICAgICB2YXIgcGVyZm9ybXM6IEFueQoKICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgIH0KCiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1PQ0sgTUVUSE9EUyAtJT48JV8gLSU+CiAgICBwdWJsaWMgZnVuYyBnaXZlbihfIG1ldGhvZDogR2l2ZW4pIHsKICAgICAgICBtZXRob2RSZXR1cm5WYWx1ZXMuYXBwZW5kKG1ldGhvZCkKICAgIH0KCiAgICBwdWJsaWMgZnVuYyBwZXJmb3JtKF8gbWV0aG9kOiBQZXJmb3JtKSB7CiAgICAgICAgbWV0aG9kUGVyZm9ybVZhbHVlcy5hcHBlbmQobWV0aG9kKQogICAgICAgIG1ldGhvZFBlcmZvcm1WYWx1ZXMuc29ydCB7ICQwLm1ldGhvZC5pbnRWYWx1ZSgpIDwgJDEubWV0aG9kLmludFZhbHVlKCkgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jIHZlcmlmeShfIG1ldGhvZDogVmVyaWZ5LCBjb3VudDogQ291bnQgPSBDb3VudC5tb3JlT3JFcXVhbCh0bzogMSksIGZpbGU6IFN0YXRpY1N0cmluZyA9ICNmaWxlLCBsaW5lOiBVSW50ID0gI2xpbmUpIHsKICAgICAgICBsZXQgaW52b2NhdGlvbnMgPSBtYXRjaGluZ0NhbGxzKG1ldGhvZC5tZXRob2QpCiAgICAgICAgTW9ja3lBc3NlcnQoY291bnQubWF0Y2hlcyhpbnZvY2F0aW9ucy5jb3VudCksICJFeHBlY3RlZDogXChjb3VudCkgaW52b2NhdGlvbnMgb2YgYFwobWV0aG9kLm1ldGhvZClgLCBidXQgd2FzOiBcKGludm9jYXRpb25zLmNvdW50KSIsIGZpbGU6IGZpbGUsIGxpbmU6IGxpbmUpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIGFkZEludm9jYXRpb24oXyBjYWxsOiBNZXRob2RUeXBlKSB7CiAgICAgICAgaW52b2NhdGlvbnMuYXBwZW5kKGNhbGwpCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgbWV0aG9kUmV0dXJuVmFsdWUoXyBtZXRob2Q6IE1ldGhvZFR5cGUpIHRocm93cyAtPiBTdHViUHJvZHVjdCB7CiAgICAgICAgbGV0IGNhbmRpZGF0ZXMgPSBzZXF1ZW5jaW5nUG9saWN5LnNvcnRlZChtZXRob2RSZXR1cm5WYWx1ZXMsIGJ5OiB7ICQwLm1ldGhvZC5pbnRWYWx1ZSgpID4gJDEubWV0aG9kLmludFZhbHVlKCkgfSkKICAgICAgICBsZXQgbWF0Y2hlZCA9IGNhbmRpZGF0ZXMuZmlyc3Qod2hlcmU6IHsgJDAuaXNWYWxpZCAmJiBNZXRob2RUeXBlLmNvbXBhcmVQYXJhbWV0ZXJzKGxoczogJDAubWV0aG9kLCByaHM6IG1ldGhvZCwgbWF0Y2hlcjogbWF0Y2hlcikgfSkKICAgICAgICBndWFyZCBsZXQgcHJvZHVjdCA9IG1hdGNoZWQ/LmdldFByb2R1Y3QocG9saWN5OiBzZWxmLnN0dWJiaW5nUG9saWN5KSBlbHNlIHsgdGhyb3cgTW9ja0Vycm9yLm5vdFN0dWJlZCB9CiAgICAgICAgcmV0dXJuIHByb2R1Y3QKICAgIH0KICAgIHByaXZhdGUgZnVuYyBtZXRob2RQZXJmb3JtVmFsdWUoXyBtZXRob2Q6IE1ldGhvZFR5cGUpIC0+IEFueT8gewogICAgICAgIGxldCBtYXRjaGVkID0gbWV0aG9kUGVyZm9ybVZhbHVlcy5yZXZlcnNlZCgpLmZpcnN0IHsgTWV0aG9kVHlwZS5jb21wYXJlUGFyYW1ldGVycyhsaHM6ICQwLm1ldGhvZCwgcmhzOiBtZXRob2QsIG1hdGNoZXI6IG1hdGNoZXIpIH0KICAgICAgICByZXR1cm4gbWF0Y2hlZD8ucGVyZm9ybXMKICAgIH0KICAgIHByaXZhdGUgZnVuYyBtYXRjaGluZ0NhbGxzKF8gbWV0aG9kOiBNZXRob2RUeXBlKSAtPiBbTWV0aG9kVHlwZV0gewogICAgICAgIHJldHVybiBpbnZvY2F0aW9ucy5maWx0ZXIgeyBNZXRob2RUeXBlLmNvbXBhcmVQYXJhbWV0ZXJzKGxoczogJDAsIHJoczogbWV0aG9kLCBtYXRjaGVyOiBtYXRjaGVyKSB9CiAgICB9CiAgICBwcml2YXRlIGZ1bmMgbWF0Y2hpbmdDYWxscyhfIG1ldGhvZDogVmVyaWZ5KSAtPiBJbnQgewogICAgICAgIHJldHVybiBtYXRjaGluZ0NhbGxzKG1ldGhvZC5tZXRob2QpLmNvdW50CiAgICB9CiAgICBwcml2YXRlIGZ1bmMgZ2l2ZW5HZXR0ZXJWYWx1ZTxUPihfIG1ldGhvZDogTWV0aG9kVHlwZSwgXyBtZXNzYWdlOiBTdHJpbmcpIC0+IFQgewogICAgICAgIGRvIHsKICAgICAgICAgICAgcmV0dXJuIHRyeSBtZXRob2RSZXR1cm5WYWx1ZShtZXRob2QpLmNhc3RlZCgpCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgIG9uRmF0YWxGYWlsdXJlKG1lc3NhZ2UpCiAgICAgICAgICAgIEZhaWx1cmUobWVzc2FnZSkKICAgICAgICB9CiAgICB9CiAgICBwcml2YXRlIGZ1bmMgb3B0aW9uYWxHaXZlbkdldHRlclZhbHVlPFQ+KF8gbWV0aG9kOiBNZXRob2RUeXBlLCBfIG1lc3NhZ2U6IFN0cmluZykgLT4gVD8gewogICAgICAgIGRvIHsKICAgICAgICAgICAgcmV0dXJuIHRyeSBtZXRob2RSZXR1cm5WYWx1ZShtZXRob2QpLmNhc3RlZCgpCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgIHJldHVybiBuaWwKICAgICAgICB9CiAgICB9CiAgICBwcml2YXRlIGZ1bmMgb25GYXRhbEZhaWx1cmUoXyBtZXNzYWdlOiBTdHJpbmcpIHsKICAgICAgICAjaWYgTW9ja3kKICAgICAgICBndWFyZCBsZXQgZmlsZSA9IHNlbGYuZmlsZSwgbGV0IGxpbmUgPSBzZWxmLmxpbmUgZWxzZSB7IHJldHVybiB9IC8vIExldCBpZiBmYWlsIGlmIGNhbm5vdCBoYW5kbGUgZ3JhdGVmdWxseQogICAgICAgIFN3aWZ0eU1vY2t5VGVzdE9ic2VydmVyLmhhbmRsZU1pc3NpbmdTdHViRXJyb3IobWVzc2FnZTogbWVzc2FnZSwgZmlsZTogZmlsZSwgbGluZTogbGluZSkKICAgICAgICAjZW5kaWYKICAgIH0KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU1RBVElDIE1PQ0sgTUVUSE9EUyAtJT48JV8gLSU+CiAgICA8JV8gaWYgY29uZm9ybXNUb1N0YXRpY01vY2sgeyAtJT4KCiAgICBzdGF0aWMgcHVibGljIGZ1bmMgZ2l2ZW4oXyBtZXRob2Q6IFN0YXRpY0dpdmVuKSB7CiAgICAgICAgbWV0aG9kUmV0dXJuVmFsdWVzLmFwcGVuZChtZXRob2QpCiAgICB9CgogICAgc3RhdGljIHB1YmxpYyBmdW5jIHBlcmZvcm0oXyBtZXRob2Q6IFN0YXRpY1BlcmZvcm0pIHsKICAgICAgICBtZXRob2RQZXJmb3JtVmFsdWVzLmFwcGVuZChtZXRob2QpCiAgICAgICAgbWV0aG9kUGVyZm9ybVZhbHVlcy5zb3J0IHsgJDAubWV0aG9kLmludFZhbHVlKCkgPCAkMS5tZXRob2QuaW50VmFsdWUoKSB9CiAgICB9CgogICAgc3RhdGljIHB1YmxpYyBmdW5jIHZlcmlmeShfIG1ldGhvZDogU3RhdGljVmVyaWZ5LCBjb3VudDogQ291bnQgPSBDb3VudC5tb3JlT3JFcXVhbCh0bzogMSksIGZpbGU6IFN0YXRpY1N0cmluZyA9ICNmaWxlLCBsaW5lOiBVSW50ID0gI2xpbmUpIHsKICAgICAgICBsZXQgaW52b2NhdGlvbnMgPSBtYXRjaGluZ0NhbGxzKG1ldGhvZC5tZXRob2QpCiAgICAgICAgTW9ja3lBc3NlcnQoY291bnQubWF0Y2hlcyhpbnZvY2F0aW9ucy5jb3VudCksICJFeHBlY3RlZDogXChjb3VudCkgaW52b2NhdGlvbnMgb2YgYFwobWV0aG9kLm1ldGhvZClgLCBidXQgd2FzOiBcKGludm9jYXRpb25zLmNvdW50KSIsIGZpbGU6IGZpbGUsIGxpbmU6IGxpbmUpCiAgICB9CgogICAgc3RhdGljIHByaXZhdGUgZnVuYyBhZGRJbnZvY2F0aW9uKF8gY2FsbDogU3RhdGljTWV0aG9kVHlwZSkgewogICAgICAgIGludm9jYXRpb25zLmFwcGVuZChjYWxsKQogICAgfQogICAgc3RhdGljIHByaXZhdGUgZnVuYyBtZXRob2RSZXR1cm5WYWx1ZShfIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZSkgdGhyb3dzIC0+IFN0dWJQcm9kdWN0IHsKICAgICAgICBsZXQgY2FuZGlkYXRlcyA9IHNlcXVlbmNpbmdQb2xpY3kuc29ydGVkKG1ldGhvZFJldHVyblZhbHVlcywgYnk6IHsgJDAubWV0aG9kLmludFZhbHVlKCkgPiAkMS5tZXRob2QuaW50VmFsdWUoKSB9KQogICAgICAgIGxldCBtYXRjaGVkID0gY2FuZGlkYXRlcy5maXJzdCh3aGVyZTogeyAkMC5pc1ZhbGlkICYmIFN0YXRpY01ldGhvZFR5cGUuY29tcGFyZVBhcmFtZXRlcnMobGhzOiAkMC5tZXRob2QsIHJoczogbWV0aG9kLCBtYXRjaGVyOiBtYXRjaGVyKSB9KQogICAgICAgIGd1YXJkIGxldCBwcm9kdWN0ID0gbWF0Y2hlZD8uZ2V0UHJvZHVjdChwb2xpY3k6IHNlbGYuc3R1YmJpbmdQb2xpY3kpIGVsc2UgeyB0aHJvdyBNb2NrRXJyb3Iubm90U3R1YmVkIH0KICAgICAgICByZXR1cm4gcHJvZHVjdAogICAgfQogICAgc3RhdGljIHByaXZhdGUgZnVuYyBtZXRob2RQZXJmb3JtVmFsdWUoXyBtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUpIC0+IEFueT8gewogICAgICAgIGxldCBtYXRjaGVkID0gbWV0aG9kUGVyZm9ybVZhbHVlcy5yZXZlcnNlZCgpLmZpcnN0IHsgU3RhdGljTWV0aG9kVHlwZS5jb21wYXJlUGFyYW1ldGVycyhsaHM6ICQwLm1ldGhvZCwgcmhzOiBtZXRob2QsIG1hdGNoZXI6IG1hdGNoZXIpIH0KICAgICAgICByZXR1cm4gbWF0Y2hlZD8ucGVyZm9ybXMKICAgIH0KICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgbWF0Y2hpbmdDYWxscyhfIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZSkgLT4gW1N0YXRpY01ldGhvZFR5cGVdIHsKICAgICAgICByZXR1cm4gaW52b2NhdGlvbnMuZmlsdGVyIHsgU3RhdGljTWV0aG9kVHlwZS5jb21wYXJlUGFyYW1ldGVycyhsaHM6ICQwLCByaHM6IG1ldGhvZCwgbWF0Y2hlcjogbWF0Y2hlcikgfQogICAgfQogICAgc3RhdGljIHByaXZhdGUgZnVuYyBtYXRjaGluZ0NhbGxzKF8gbWV0aG9kOiBTdGF0aWNWZXJpZnkpIC0+IEludCB7CiAgICAgICAgcmV0dXJuIG1hdGNoaW5nQ2FsbHMobWV0aG9kLm1ldGhvZCkuY291bnQKICAgIH0KICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgZ2l2ZW5HZXR0ZXJWYWx1ZTxUPihfIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZSwgXyBtZXNzYWdlOiBTdHJpbmcpIC0+IFQgewogICAgICAgIGRvIHsKICAgICAgICAgICAgcmV0dXJuIHRyeSBtZXRob2RSZXR1cm5WYWx1ZShtZXRob2QpLmNhc3RlZCgpCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgIEZhaWx1cmUobWVzc2FnZSkKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIG9wdGlvbmFsR2l2ZW5HZXR0ZXJWYWx1ZTxUPihfIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZSwgXyBtZXNzYWdlOiBTdHJpbmcpIC0+IFQ/IHsKICAgICAgICBkbyB7CiAgICAgICAgICAgIHJldHVybiB0cnkgbWV0aG9kUmV0dXJuVmFsdWUobWV0aG9kKS5jYXN0ZWQoKQogICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICByZXR1cm4gbmlsCiAgICAgICAgfQogICAgfQogICAgPCVfIH0gLSU+CjwlXyBpZiBhdXRvTW9ja2FibGUgeyAtJT4KfQoKPCVfIH0gZWxzZSB7IC0lPgovLyBzb3VyY2VyeTplbmQKPCVfIH0gLSU+CjwlIH0gLSU+Cg=="
    )
}
