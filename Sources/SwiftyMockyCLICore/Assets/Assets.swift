import Foundation
import PathKit

public enum Assets {

    public enum AllTypes {
        public static let swifttemplate: AssetFile = Files.allTypes
    }
    
    public enum MockConfiguration {
        public static let swifttemplate: AssetFile = Files.mock
    }

    public enum swifttemplate {
        public static let allTypes: AssetFile = Files.allTypes
        public static let mock: AssetFile = Files.mock
    }
}

public protocol AssetFile {

    var name: String { get }
    var data: Data { get }

    func write(to path: Path) throws
}

private struct File: AssetFile {

    let name: String
    let contents: String
    var data: Data { return Data(base64Encoded: contents) ?? Data() }

    func write(to path: Path) throws {
        try path.write(data)
    }
}

private enum Files {
    static let allTypes = File(
        name: "AllTypes.swifttemplate",
        contents: "dHlwZXM6CjwlXyB2YXIgYWxsID0gdHlwZXMuYWxsCiAgICBhbGwgKz0gdHlwZXMucHJvdG9jb2xzLm1hcCB7ICQwIH0gLSU+CjwlXyBmb3IgdHlwZSBpbiBhbGwgeyAtJT48JV8gLSU+CiAgPCVfIGxldCBhdXRvTW9ja2FibGU6IEJvb2wgPSB0eXBlLmluaGVyaXRlZFR5cGVzLmNvbnRhaW5zKCJBdXRvTW9ja2FibGUiKSB8fCB0eXBlLmFubm90YXRpb25zWyJBdXRvTW9ja2FibGUiXSAhPSBuaWwgLSU+CiAgPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgogICAgLSA8JT0gdHlwZS5uYW1lICU+CiAgPCVfIH0gLSU+CjwlXyB9IC0lPg=="
    )
    static let mock = File(
        name: "Mock.swifttemplate",
        contents: "PCVfCmZ1bmMgc3dpZnRMaW50UnVsZXMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBzdHJpbmdBcnJheShmcm9tQXJndW1lbnRzOiBhcmd1bWVudHMsIGZvcktleTogImV4Y2x1ZGVkU3dpZnRMaW50UnVsZXMiKS5tYXAgeyBydWxlIGluCiAgICAgICAgcmV0dXJuICIvL3N3aWZ0bGludDpkaXNhYmxlIFwocnVsZSkiCiAgICB9Cn0KCmZ1bmMgcHJvamVjdEltcG9ydHMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBpbXBvcnRzKGFyZ3VtZW50cykgKyB0ZXN0YWJsZUltcG9ydHMoYXJndW1lbnRzKQp9CgpmdW5jIGltcG9ydHMoXyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0pIC0+IFtTdHJpbmddIHsKICAgIHJldHVybiBzdHJpbmdBcnJheShmcm9tQXJndW1lbnRzOiBhcmd1bWVudHMsIGZvcktleTogImltcG9ydCIpCiAgICAgICAgLm1hcCB7IHJldHVybiAiaW1wb3J0IFwoJDApIiB9Cn0KCmZ1bmMgdGVzdGFibGVJbXBvcnRzKF8gYXJndW1lbnRzOiBbU3RyaW5nOiBBbnldKSAtPiBbU3RyaW5nXSB7CiAgICByZXR1cm4gc3RyaW5nQXJyYXkoZnJvbUFyZ3VtZW50czogYXJndW1lbnRzLCBmb3JLZXk6ICJ0ZXN0YWJsZSIpCiAgICAgICAgLm1hcCB7IHJldHVybiAiQHRlc3RhYmxlIGltcG9ydCBcKCQwKSIgfQp9CgovLy8gW0ludGVybmFsXSBHZXQgdmFsdWUgZnJvbSBkaWN0aW9uYXJ5Ci8vLyAtIFBhcmFtZXRlcnM6Ci8vLyAgIC0gZnJvbUFyZ3VtZW50czogZGljdGlvbmFyeQovLy8gICAtIGZvcktleTogZGljdGlvbmFyeSBrZXkKLy8vIC0gUmV0dXJuczogYXJyYXkgb2Ygc3RyaW5ncywgaWYga2V5IG5vdCBmb3VuZCwgcmV0dXJucyBlbXB0eSBhcnJheS4KLy8vIC0gTm90ZTogSWYgc291cmNlcnkgYXJndW1lbnRzIGNvbnRhaW50cyBvbmx5IG9uZSBlbGVtZW50LCB0aGVuIHNpbmdsZSB2YWx1ZSBpcyBzdG9yZWQsIG90aGVyd2lzZSBhcnJheSBvZiBlbGVtZW50cy4gVGhpcyBtZXRob2QgYWx3YXlzIGdldHMgYXJyYXkgb2YgZWxlbWVudHMuCmZ1bmMgc3RyaW5nQXJyYXkoZnJvbUFyZ3VtZW50cyBhcmd1bWVudHM6IFtTdHJpbmc6IEFueV0sIGZvcktleSBrZXk6IFN0cmluZykgLT4gW1N0cmluZ10gewoKICAgIGlmIGxldCBhcmd1bWVudCA9IGFyZ3VtZW50c1trZXldIGFzPyBTdHJpbmcgewogICAgICAgIHJldHVybiBbYXJndW1lbnRdCiAgICB9IGVsc2UgaWYgbGV0IG1hbnlBcmd1bWVudHMgPSBhcmd1bWVudHNba2V5XSBhcz8gW1N0cmluZ10gewogICAgICAgIHJldHVybiBtYW55QXJndW1lbnRzCiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBbXQogICAgfQp9Cl8lPgo8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU3dpZnRMaW50IC0lPjwlXyAtJT4KPCVfIGZvciBydWxlIGluIHN3aWZ0TGludFJ1bGVzKGFyZ3VtZW50KSB7IC0lPgogICAgPCVfICU+PCU9IHJ1bGUgJT4KPCVfIH0gLSU+CjwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTd2lmdExpbnQgKGFnZ3JlZ2F0ZWQgYXJndW1lbnQpIC0lPjwlXyAtJT4KPCVfIGlmIGxldCBzd2lmdHlNb2NreUFyZ3MgPSBhcmd1bWVudFsic3dpZnR5TW9ja3kiXSBhcz8gW1N0cmluZzogQW55XSwgbGV0IHJ1bGVzID0gc3dpZnR5TW9ja3lBcmdzWyJleGNsdWRlZFN3aWZ0TGludFJ1bGVzIl0gYXM/IFtTdHJpbmddIHsgLSU+CiAgICA8JV8gZm9yIHJ1bGUgaW4gcnVsZXMgeyAtJT4KICAgIDwlXyAlPi8vc3dpZnRsaW50OmRpc2FibGUgPCU9IHJ1bGUgJT4KICAgIDwlXyB9IC0lPgo8JV8gfSAtJT4KCiNpZiBNb2NreUN1c3RvbQppbXBvcnQgU3dpZnR5TW9ja3kKPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IElNUE9SVFMgSW5BUFAgLSU+PCVfIC0lPgogICAgPCVfIGZvciBwcm9qZWN0SW1wb3J0IGluIHByb2plY3RJbXBvcnRzKGFyZ3VtZW50KSB7IC0lPgogICAgICAgIDwlXyAlPjwlPSBwcm9qZWN0SW1wb3J0ICU+CiAgICA8JV8gfSAtJT4KICAgIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09IElNUE9SVFMgSW5BUFAgKGFnZ3JlZ2F0ZWQgYXJndW1lbnQpIC0lPjwlXyAtJT4KICAgIDwlXyBpZiBsZXQgc3dpZnR5TW9ja3lBcmdzID0gYXJndW1lbnRbInN3aWZ0eU1vY2t5Il0gYXM/IFtTdHJpbmc6IEFueV0geyAtJT4KICAgICAgICA8JV8gZm9yIHByb2plY3RJbXBvcnQgaW4gaW1wb3J0cyhzd2lmdHlNb2NreUFyZ3MpIHsgLSU+CiAgICAgICAgICAgIDwlXyAlPjwlPSBwcm9qZWN0SW1wb3J0ICU+CiAgICAgICAgPCVfIH0gLSU+CiAgICA8JV8gfSAtJT4KCiAgICBwdWJsaWMgZmluYWwgY2xhc3MgTW9ja3lBc3NlcnRpb24gewogICAgICAgIHB1YmxpYyBzdGF0aWMgdmFyIGhhbmRsZXI6ICgoQm9vbCwgU3RyaW5nLCBTdGF0aWNTdHJpbmcsIFVJbnQpIC0+IFZvaWQpPwogICAgfQoKICAgIGZ1bmMgTW9ja3lBc3NlcnQoXyBleHByZXNzaW9uOiBAYXV0b2Nsb3N1cmUgKCkgLT4gQm9vbCwgXyBtZXNzYWdlOiBAYXV0b2Nsb3N1cmUgKCkgLT4gU3RyaW5nID0gIlZlcmlmaWNhdGlvbiBmYWlsZWQiLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgZ3VhcmQgbGV0IGhhbmRsZXIgPSBNb2NreUFzc2VydGlvbi5oYW5kbGVyIGVsc2UgewogICAgICAgICAgICBhc3NlcnQoZXhwcmVzc2lvbiwgbWVzc2FnZSwgZmlsZTogZmlsZSwgbGluZTogbGluZSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgfQoKICAgICAgICBoYW5kbGVyKGV4cHJlc3Npb24oKSwgbWVzc2FnZSgpLCBmaWxlLCBsaW5lKQogICAgfQojZWxzZQojaWYgY2FuSW1wb3J0KFhDVGVzdCkKaW1wb3J0IFhDVGVzdAojZW5kaWYKaW1wb3J0IFN3aWZ0eU1vY2t5CjwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBJTVBPUlRTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgcHJvamVjdEltcG9ydCBpbiBwcm9qZWN0SW1wb3J0cyhhcmd1bWVudCkgeyAtJT4KICAgICAgICA8JV8gJT48JT0gcHJvamVjdEltcG9ydCAlPgogICAgPCVfIH0gLSU+CiAgICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PSBJTVBPUlRTIEluQVBQIChhZ2dyZWdhdGVkIGFyZ3VtZW50KSAtJT48JV8gLSU+CiAgICA8JV8gaWYgbGV0IHN3aWZ0eU1vY2t5QXJncyA9IGFyZ3VtZW50WyJzd2lmdHlNb2NreSJdIGFzPyBbU3RyaW5nOiBBbnldIHsgLSU+CiAgICAgICAgPCVfIGZvciBwcm9qZWN0SW1wb3J0IGluIHByb2plY3RJbXBvcnRzKHN3aWZ0eU1vY2t5QXJncykgeyAtJT4KICAgICAgICAgICAgPCVfICU+PCU9IHByb2plY3RJbXBvcnQgJT4KICAgICAgICA8JV8gfSAtJT4KICAgIDwlXyB9IC0lPgoKICAgIGZ1bmMgTW9ja3lBc3NlcnQoXyBleHByZXNzaW9uOiBAYXV0b2Nsb3N1cmUgKCkgLT4gQm9vbCwgXyBtZXNzYWdlOiBAYXV0b2Nsb3N1cmUgKCkgLT4gU3RyaW5nID0gIlZlcmlmaWNhdGlvbiBmYWlsZWQiLCBmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgI2lmIGNhbkltcG9ydChYQ1Rlc3QpCiAgICAgICAgWENUQXNzZXJ0KGV4cHJlc3Npb24oKSwgbWVzc2FnZSgpLCBmaWxlOiBmaWxlLCBsaW5lOiBsaW5lKQogICAgICAgICNlbHNlIAogICAgICAgIGFzc2VydChleHByZXNzaW9uKCksICJcKG1lc3NhZ2UoKSksIGZpbGU6IFwoZmlsZSksIGxpbmU6IFwobGluZSkiKQogICAgICAgICNlbmRpZgogICAgfQojZW5kaWYKPCVfCmNsYXNzIEN1cnJlbnQgewogICAgc3RhdGljIHZhciBzZWxmVHlwZTogU3RyaW5nID0gIlNlbGYiCn0KLy8gQ29sbGlzaW9uIG1hbmFnZW1lbnQKZnVuYyBhcmVUaGVyZUNvbGxpc2lvbnMoYmV0d2VlbiBtZXRob2RzOiBbTWV0aG9kV3JhcHBlcl0pIC0+IEJvb2wgewogICAgbGV0IGdpdmVuU2V0ID0gU2V0PFN0cmluZz4obWV0aG9kcy5tYXAoeyAkMC5naXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlLCBhbm5vdGF0ZWQ6IGZhbHNlKSB9KSkKICAgIGd1YXJkIGdpdmVuU2V0LmNvdW50ID09IG1ldGhvZHMuY291bnQgZWxzZSB7IHJldHVybiB0cnVlIH0gLy8gdGhlcmUgd291bGQgYmUgY29uZmxpY3RzIGluIEdpdmVuCiAgICBsZXQgdmVyaWZ5U2V0ID0gU2V0PFN0cmluZz4obWV0aG9kcy5tYXAoeyAkMC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlLCBhbm5vdGF0ZWQ6IGZhbHNlKSB9KSkKICAgIGd1YXJkIHZlcmlmeVNldC5jb3VudCA9PSBtZXRob2RzLmNvdW50IGVsc2UgeyByZXR1cm4gdHJ1ZSB9IC8vIHRoZXJlIHdvdWxkIGJlIGNvbmZsaWN0cyBpbiBWZXJpZnkKICAgIHJldHVybiBmYWxzZQp9CgovLyBoZXJscGVycwpmdW5jIHVuaXF1ZXMobWV0aG9kczogW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdKSAtPiBbU291cmNlcnlSdW50aW1lLk1ldGhvZF0gewogICAgZnVuYyByZXR1cm5UeXBlU3RyaXBwZWQoXyBtZXRob2Q6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVSYXcgPSAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUpIgogICAgICAgIHZhciBzdHJpcHBlZDogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSByZXR1cm5UeXBlUmF3LnJhbmdlKG9mOiAid2hlcmUiKSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSYXcgfQogICAgICAgICAgICB2YXIgc3RyaXBwZWQgPSByZXR1cm5UeXBlUmF3CiAgICAgICAgICAgIHN0cmlwcGVkLnJlbW92ZVN1YnJhbmdlKChyYW5nZS5sb3dlckJvdW5kKS4uLikKICAgICAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICAgICAgfSgpCiAgICAgICAgc3RyaXBwZWQgPSBzdHJpcHBlZC50cmltbWluZ0NoYXJhY3RlcnMoaW46IENoYXJhY3RlclNldChjaGFyYWN0ZXJzSW46ICIgIikpCiAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICB9CgogICAgZnVuYyBhcmVTYW1lUGFyYW1zKF8gcDE6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIsIF8gcDI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIpIC0+IEJvb2wgewogICAgICAgIGd1YXJkIHAxLmFyZ3VtZW50TGFiZWwgPT0gcDIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5uYW1lID09IHAyLm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEuYXJndW1lbnRMYWJlbCA9PSBwMi5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIHAxLnR5cGVOYW1lLm5hbWUgPT0gcDIudHlwZU5hbWUubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5hY3R1YWxUeXBlTmFtZT8ubmFtZSA9PSBwMi5hY3R1YWxUeXBlTmFtZT8ubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGZ1bmMgYXJlU2FtZU1ldGhvZHMoXyBtMTogU291cmNlcnlSdW50aW1lLk1ldGhvZCwgXyBtMjogU291cmNlcnlSdW50aW1lLk1ldGhvZCkgLT4gQm9vbCB7CiAgICAgICAgZ3VhcmQgbTEubmFtZSAhPSBtMi5uYW1lIGVsc2UgeyByZXR1cm4gbTEucmV0dXJuVHlwZU5hbWUgPT0gbTIucmV0dXJuVHlwZU5hbWUgfQogICAgICAgIGd1YXJkIG0xLnNlbGVjdG9yTmFtZSA9PSBtMi5zZWxlY3Rvck5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgbTEucGFyYW1ldGVycy5jb3VudCA9PSBtMi5wYXJhbWV0ZXJzLmNvdW50IGVsc2UgeyByZXR1cm4gZmFsc2UgfQoKICAgICAgICBsZXQgcDEgPSBtMS5wYXJhbWV0ZXJzCiAgICAgICAgbGV0IHAyID0gbTIucGFyYW1ldGVycwoKICAgICAgICBmb3IgaSBpbiAwLi48cDEuY291bnQgewogICAgICAgICAgICBpZiAhYXJlU2FtZVBhcmFtcyhwMVtpXSxwMltpXSkgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG0xLnJldHVyblR5cGVOYW1lID09IG0yLnJldHVyblR5cGVOYW1lCiAgICB9CgogICAgcmV0dXJuIG1ldGhvZHMucmVkdWNlKFtdLCB7IChyZXN1bHQsIGVsZW1lbnQpIC0+IFtTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kXSBpbgogICAgICAgIGd1YXJkICFyZXN1bHQuY29udGFpbnMod2hlcmU6IHsgYXJlU2FtZU1ldGhvZHMoJDAsZWxlbWVudCkgfSkgZWxzZSB7IHJldHVybiByZXN1bHQgfQogICAgICAgIHJldHVybiByZXN1bHQgKyBbZWxlbWVudF0KICAgIH0pCn0KCmZ1bmMgdW5pcXVlc1dpdGhvdXRHZW5lcmljQ29uc3RyYWludHMobWV0aG9kczogW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdKSAtPiBbU291cmNlcnlSdW50aW1lLk1ldGhvZF0gewogICAgZnVuYyByZXR1cm5UeXBlU3RyaXBwZWQoXyBtZXRob2Q6IFNvdXJjZXJ5UnVudGltZS5NZXRob2QpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVSYXcgPSAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUpIgogICAgICAgIHZhciBzdHJpcHBlZDogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSByZXR1cm5UeXBlUmF3LnJhbmdlKG9mOiAid2hlcmUiKSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSYXcgfQogICAgICAgICAgICB2YXIgc3RyaXBwZWQgPSByZXR1cm5UeXBlUmF3CiAgICAgICAgICAgIHN0cmlwcGVkLnJlbW92ZVN1YnJhbmdlKChyYW5nZS5sb3dlckJvdW5kKS4uLikKICAgICAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICAgICAgfSgpCiAgICAgICAgc3RyaXBwZWQgPSBzdHJpcHBlZC50cmltbWluZ0NoYXJhY3RlcnMoaW46IENoYXJhY3RlclNldChjaGFyYWN0ZXJzSW46ICIgIikpCiAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICB9CgogICAgZnVuYyBhcmVTYW1lUGFyYW1zKF8gcDE6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIsIF8gcDI6IFNvdXJjZXJ5UnVudGltZS5NZXRob2RQYXJhbWV0ZXIpIC0+IEJvb2wgewogICAgICAgIGd1YXJkIHAxLmFyZ3VtZW50TGFiZWwgPT0gcDIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5uYW1lID09IHAyLm5hbWUgZWxzZSB7IHJldHVybiBmYWxzZSB9CiAgICAgICAgZ3VhcmQgcDEuYXJndW1lbnRMYWJlbCA9PSBwMi5hcmd1bWVudExhYmVsIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIHAxLnR5cGVOYW1lLm5hbWUgPT0gcDIudHlwZU5hbWUubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICBndWFyZCBwMS5hY3R1YWxUeXBlTmFtZT8ubmFtZSA9PSBwMi5hY3R1YWxUeXBlTmFtZT8ubmFtZSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICByZXR1cm4gdHJ1ZQogICAgfQoKICAgIGZ1bmMgYXJlU2FtZU1ldGhvZHMoXyBtMTogU291cmNlcnlSdW50aW1lLk1ldGhvZCwgXyBtMjogU291cmNlcnlSdW50aW1lLk1ldGhvZCkgLT4gQm9vbCB7CiAgICAgICAgZ3VhcmQgbTEubmFtZSAhPSBtMi5uYW1lIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVN0cmlwcGVkKG0xKSA9PSByZXR1cm5UeXBlU3RyaXBwZWQobTIpIH0KICAgICAgICBndWFyZCBtMS5zZWxlY3Rvck5hbWUgPT0gbTIuc2VsZWN0b3JOYW1lIGVsc2UgeyByZXR1cm4gZmFsc2UgfQogICAgICAgIGd1YXJkIG0xLnBhcmFtZXRlcnMuY291bnQgPT0gbTIucGFyYW1ldGVycy5jb3VudCBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KCiAgICAgICAgbGV0IHAxID0gbTEucGFyYW1ldGVycwogICAgICAgIGxldCBwMiA9IG0yLnBhcmFtZXRlcnMKCiAgICAgICAgZm9yIGkgaW4gMC4uPHAxLmNvdW50IHsKICAgICAgICAgICAgaWYgIWFyZVNhbWVQYXJhbXMocDFbaV0scDJbaV0pIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXR1cm5UeXBlU3RyaXBwZWQobTEpID09IHJldHVyblR5cGVTdHJpcHBlZChtMikKICAgIH0KCiAgICByZXR1cm4gbWV0aG9kcy5yZWR1Y2UoW10sIHsgKHJlc3VsdCwgZWxlbWVudCkgLT4gW1NvdXJjZXJ5UnVudGltZS5NZXRob2RdIGluCiAgICAgICAgZ3VhcmQgIXJlc3VsdC5jb250YWlucyh3aGVyZTogeyBhcmVTYW1lTWV0aG9kcygkMCxlbGVtZW50KSB9KSBlbHNlIHsgcmV0dXJuIHJlc3VsdCB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCArIFtlbGVtZW50XQogICAgfSkKfQoKZnVuYyB1bmlxdWVzKHZhcmlhYmxlczogW1NvdXJjZXJ5UnVudGltZS5WYXJpYWJsZV0pIC0+IFtTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGVdIHsKICAgIHJldHVybiB2YXJpYWJsZXMucmVkdWNlKFtdLCB7IChyZXN1bHQsIGVsZW1lbnQpIC0+IFtTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGVdIGluCiAgICAgICAgZ3VhcmQgIXJlc3VsdC5jb250YWlucyh3aGVyZTogeyAkMC5uYW1lID09IGVsZW1lbnQubmFtZSB9KSBlbHNlIHsgcmV0dXJuIHJlc3VsdCB9CiAgICAgICAgcmV0dXJuIHJlc3VsdCArIFtlbGVtZW50XQogICAgfSkKfQoKZnVuYyB3cmFwTWV0aG9kKF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSAtPiBNZXRob2RXcmFwcGVyIHsKICAgIHJldHVybiBNZXRob2RXcmFwcGVyKG1ldGhvZCkKfQoKZnVuYyB3cmFwU3Vic2NyaXB0KF8gd3JhcHBlZDogU291cmNlcnlSdW50aW1lLlN1YnNjcmlwdCkgLT4gU3Vic2NyaXB0V3JhcHBlciB7CiAgICByZXR1cm4gU3Vic2NyaXB0V3JhcHBlcih3cmFwcGVkKQp9CgpmdW5jIGp1c3RXcmFwKF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSkgLT4gVmFyaWFibGVXcmFwcGVyIHsgcmV0dXJuIHdyYXBQcm9wZXJ0eSh2YXJpYWJsZSkgfQpmdW5jIHdyYXBQcm9wZXJ0eShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUsIF8gc2NvcGU6IFN0cmluZyA9ICIiKSAtPiBWYXJpYWJsZVdyYXBwZXIgewogICAgcmV0dXJuIFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6IHNjb3BlKQp9CgpmdW5jIHN0dWJQcm9wZXJ0eShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUsIF8gc2NvcGU6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogc2NvcGUpCiAgICByZXR1cm4gIlwod3JhcHBlci5wcm90b3R5cGUpXG5cdFwod3JhcHBlci5wcml2YXRlUHJvdG90eXBlKSIKfQoKZnVuYyBwcm9wZXJ0eVR5cGVzKF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSkgLT4gU3RyaW5nIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogInNjb3BlIikKICAgIHJldHVybiAiXCh3cmFwcGVyLnByb3BlcnR5R2V0KCkpIiArICh3cmFwcGVyLnJlYWRvbmx5ID8gIiIgOiAiXG5cdFx0XCh3cmFwcGVyLnByb3BlcnR5U2V0KCkpIikKfQoKZnVuYyBwcm9wZXJ0eU1ldGhvZFR5cGVzKF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSkgLT4gU3RyaW5nIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogIiIpCiAgICByZXR1cm4gIlwod3JhcHBlci5wcm9wZXJ0eUNhc2VHZXQoKSkiICsgKHdyYXBwZXIucmVhZG9ubHkgPyAiIiA6ICJcblx0XHRcKHdyYXBwZXIucHJvcGVydHlDYXNlU2V0KCkpIikKfQoKZnVuYyBwcm9wZXJ0eU1ldGhvZFR5cGVzQ29tcGFyZShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICIiKQogICAgcmV0dXJuICJcKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0Q29tcGFyZSgpKSIgKyAod3JhcHBlci5yZWFkb25seSA/ICIiIDogIlxuXHRcdFx0XCh3cmFwcGVyLnByb3BlcnR5Q2FzZVNldENvbXBhcmUoKSkiKQp9CgpmdW5jIHByb3BlcnR5TWV0aG9kVHlwZXNJbnRWYWx1ZShfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIC0+IFN0cmluZyB7CiAgICBsZXQgd3JhcHBlciA9IFZhcmlhYmxlV3JhcHBlcih2YXJpYWJsZSwgc2NvcGU6ICIiKQogICAgcmV0dXJuICJcKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0SW50VmFsdWUoKSkiICsgKHdyYXBwZXIucmVhZG9ubHkgPyAiIiA6ICJcblx0XHRcdFwod3JhcHBlci5wcm9wZXJ0eUNhc2VTZXRJbnRWYWx1ZSgpKSIpCn0KCmZ1bmMgcHJvcGVydHlSZWdpc3RlcihfIHZhcmlhYmxlOiBTb3VyY2VyeVJ1bnRpbWUuVmFyaWFibGUpIHsKICAgIGxldCB3cmFwcGVyID0gVmFyaWFibGVXcmFwcGVyKHZhcmlhYmxlLCBzY29wZTogIiIpCiAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyKHdyYXBwZXIucHJvcGVydHlDYXNlR2V0TmFtZSx3cmFwcGVyLnByb3BlcnR5Q2FzZUdldE5hbWUsd3JhcHBlci5wcm9wZXJ0eUNhc2VHZXROYW1lKQogICAgZ3VhcmQgIXdyYXBwZXIucmVhZG9ubHkgZWxzZSB7IHJldHVybiB9CiAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyKHdyYXBwZXIucHJvcGVydHlDYXNlU2V0TmFtZSx3cmFwcGVyLnByb3BlcnR5Q2FzZVNldE5hbWUsd3JhcHBlci5wcm9wZXJ0eUNhc2VHZXROYW1lKQp9CmNsYXNzIEhlbHBlcnMgewogICAgc3RhdGljIGZ1bmMgc3BsaXQoXyBzdHJpbmc6IFN0cmluZywgYnlGaXJzdE9jY3VyZW5jZU9mIHdvcmQ6IFN0cmluZykgLT4gKFN0cmluZywgU3RyaW5nKSB7CiAgICAgICAgZ3VhcmQgbGV0IHdvcmRSYW5nZSA9IHN0cmluZy5yYW5nZShvZjogd29yZCkgZWxzZSB7IHJldHVybiAoc3RyaW5nLCAiIikgfQogICAgICAgIGxldCBzZWxmUmFuZ2UgPSBzdHJpbmcucmFuZ2Uob2Y6IHN0cmluZykhCiAgICAgICAgbGV0IGJlZm9yZSA9IFN0cmluZyhzdHJpbmdbc2VsZlJhbmdlLmxvd2VyQm91bmQuLjx3b3JkUmFuZ2UubG93ZXJCb3VuZF0pCiAgICAgICAgbGV0IGFmdGVyID0gU3RyaW5nKHN0cmluZ1t3b3JkUmFuZ2UudXBwZXJCb3VuZC4uPHNlbGZSYW5nZS51cHBlckJvdW5kXSkKICAgICAgICByZXR1cm4gKGJlZm9yZSwgYWZ0ZXIpCiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0QXNzb2NpYXRlZFR5cGVzKGZyb20gYW5ub3RhdGVkOiBTb3VyY2VyeVJ1bnRpbWUuQW5ub3RhdGVkKSAtPiBbU3RyaW5nXT8gewogICAgICAgIGlmIGxldCB0eXBlcyA9IGFubm90YXRlZC5hbm5vdGF0aW9uc1siYXNzb2NpYXRlZHR5cGUiXSBhcz8gW1N0cmluZ10gewogICAgICAgICAgICByZXR1cm4gdHlwZXMucmV2ZXJzZWQoKQogICAgICAgIH0gZWxzZSBpZiBsZXQgdHlwZSA9IGFubm90YXRlZC5hbm5vdGF0aW9uc1siYXNzb2NpYXRlZHR5cGUiXSBhcz8gU3RyaW5nIHsKICAgICAgICAgICAgcmV0dXJuIFt0eXBlXQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBuaWwKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0R2VuZXJpY3NMaXN0KF8gYXNzb2NpYXRlZFR5cGVzOiBbU3RyaW5nXT8pIC0+IFtTdHJpbmddIHsKICAgICAgICByZXR1cm4gYXNzb2NpYXRlZFR5cGVzPy5mbGF0TWFwIHsKICAgICAgICAgICAgc3BsaXQoJDAsIGJ5Rmlyc3RPY2N1cmVuY2VPZjogIiB3aGVyZSAiKS4wLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiICIsIHdpdGg6ICIiKS5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIjoiKS5tYXAoU3RyaW5nLmluaXQpLmZpcnN0CiAgICAgICAgICAgIH0ubWFwIHsgIlwoJDApIiB9ID8/IFtdCiAgICB9CiAgICBzdGF0aWMgZnVuYyBleHRyYWN0R2VuZXJpY1R5cGVzTW9kaWZpZXIoXyBhc3NvY2lhdGVkVHlwZXM6IFtTdHJpbmddPykgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgYWxsID0gZXh0cmFjdEdlbmVyaWNzTGlzdChhc3NvY2lhdGVkVHlwZXMpCiAgICAgICAgZ3VhcmQgIWFsbC5pc0VtcHR5IGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIHJldHVybiAiPFwoYWxsLmpvaW5lZChzZXBhcmF0b3I6ICIsIikpPiIKICAgIH0KICAgIHN0YXRpYyBmdW5jIGV4dHJhY3RHZW5lcmljVHlwZXNDb25zdHJhaW50cyhfIGFzc29jaWF0ZWRUeXBlczogW1N0cmluZ10/KSAtPiBTdHJpbmcgewogICAgICAgIGd1YXJkIGxldCBhbGwgPSBhc3NvY2lhdGVkVHlwZXMgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgbGV0IGNvbnN0cmFpbnRzID0gYWxsLmZsYXRNYXAgeyB0IC0+IFN0cmluZz8gaW4KICAgICAgICAgICAgbGV0IHNwbGl0dGVkID0gc3BsaXQodCwgYnlGaXJzdE9jY3VyZW5jZU9mOiAiIHdoZXJlICIpCiAgICAgICAgICAgIGxldCBjb25zdHJhaW50ID0gc3BsaXR0ZWQuMC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiAiLCB3aXRoOiAiIikuY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICI6IikubWFwKFN0cmluZy5pbml0KQogICAgICAgICAgICBndWFyZCBjb25zdHJhaW50LmNvdW50ID09IDIgZWxzZSB7IHJldHVybiBuaWwgfQogICAgICAgICAgICBsZXQgYWRvcHRzID0gY29uc3RyYWludFsxXS5jaGFyYWN0ZXJzLnNwbGl0KHNlcGFyYXRvcjogIiwiKS5tYXAoU3RyaW5nLmluaXQpCiAgICAgICAgICAgIHZhciBtYXBwZWQgPSBhZG9wdHMubWFwIHsgIlwoY29uc3RyYWludFswXSk6IFwoJDApIiB9CiAgICAgICAgICAgIGlmICFzcGxpdHRlZC4xLmlzRW1wdHkgewogICAgICAgICAgICAgICAgbWFwcGVkLmFwcGVuZChzcGxpdHRlZC4xKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBtYXBwZWQuam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICAgICAgfQogICAgICAgICAgICAuam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICBndWFyZCAhY29uc3RyYWludHMuaXNFbXB0eSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIiB3aGVyZSBcKGNvbnN0cmFpbnRzKSIKICAgIH0KfQpjbGFzcyBQYXJhbWV0ZXJXcmFwcGVyIHsKICAgIGxldCBwYXJhbWV0ZXI6IE1ldGhvZFBhcmFtZXRlcgoKICAgIHZhciB3cmFwcGVkRm9yQ2FsbDogU3RyaW5nIHsKICAgICAgICBsZXQgdHlwZVN0cmluZyA9ICJcKHR5cGUuYWN0dWFsVHlwZU5hbWUgPz8gdHlwZSkiCiAgICAgICAgbGV0IGlzRXNjYXBpbmcgPSB0eXBlU3RyaW5nLmNvbnRhaW5zKCJAZXNjYXBpbmciKQogICAgICAgIGxldCBpc09wdGlvbmFsID0gKHR5cGUuYWN0dWFsVHlwZU5hbWUgPz8gdHlwZSkuaXNPcHRpb25hbAogICAgICAgIGlmIHBhcmFtZXRlci5pc0Nsb3N1cmUgJiYgIWlzRXNjYXBpbmcgJiYgIWlzT3B0aW9uYWwgewogICAgICAgICAgICByZXR1cm4gIlwobmVzdGVkVHlwZSkuYW55IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXChuZXN0ZWRUeXBlKS52YWx1ZShcKGVzY2FwZWROYW1lKSkiCiAgICAgICAgfQogICAgfQogICAgdmFyIHdyYXBwZWRUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiUGFyYW1ldGVyPFwoVHlwZVdyYXBwZXIodHlwZSkuc3RyaXBwZWQpPiIKICAgIH0KICAgIHZhciBuZXN0ZWRUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChUeXBlV3JhcHBlcih0eXBlKS5uZXN0ZWRQYXJhbWV0ZXIpIgogICAgfQogICAgdmFyIGp1c3RUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChUeXBlV3JhcHBlcih0eXBlKS5yZXBsYWNpbmdTZWxmKCkpIgogICAgfQogICAgdmFyIGp1c3RQZXJmb3JtVHlwZTogU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwoVHlwZVdyYXBwZXIodHlwZSkucmVwbGFjaW5nU2VsZigpKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIhIiwgd2l0aDogIj8iKQogICAgfQogICAgdmFyIGdlbmVyaWNUeXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiUGFyYW1ldGVyPEdlbmVyaWNBdHRyaWJ1dGU+IgogICAgfQogICAgdmFyIHR5cGU6IFNvdXJjZXJ5UnVudGltZS5UeXBlTmFtZSB7CiAgICAgICAgcmV0dXJuIHBhcmFtZXRlci50eXBlTmFtZQogICAgfQogICAgdmFyIG5hbWU6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHBhcmFtZXRlci5uYW1lCiAgICB9CiAgICB2YXIgZXNjYXBlZE5hbWU6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJgXChwYXJhbWV0ZXIubmFtZSlgIgogICAgfQogICAgdmFyIGNvbXBhcmF0b3I6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJndWFyZCBQYXJhbWV0ZXIuY29tcGFyZShsaHM6IGxoc1wocGFyYW1ldGVyLm5hbWUuY2FwaXRhbGl6ZWQpLCByaHM6IHJoc1wocGFyYW1ldGVyLm5hbWUuY2FwaXRhbGl6ZWQpLCB3aXRoOiBtYXRjaGVyKSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0iCiAgICB9CgogICAgaW5pdChfIHBhcmFtZXRlcjogU291cmNlcnlSdW50aW1lLk1ldGhvZFBhcmFtZXRlcikgewogICAgICAgIHNlbGYucGFyYW1ldGVyID0gcGFyYW1ldGVyCiAgICB9CgogICAgZnVuYyBpc0dlbmVyaWMoXyB0eXBlczogW1N0cmluZ10pIC0+IEJvb2wgewogICAgICAgIHJldHVybiBUeXBlV3JhcHBlcih0eXBlKS5pc0dlbmVyaWModHlwZXMpCiAgICB9CgogICAgZnVuYyB3cmFwcGVkRm9yUHJveHkoXyBnZW5lcmljczogW1N0cmluZ10pIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIGlzR2VuZXJpYyhnZW5lcmljcykgPyAiXChlc2NhcGVkTmFtZSkud3JhcEFzR2VuZXJpYygpIiA6ICJcKGVzY2FwZWROYW1lKSIKICAgIH0KICAgIGZ1bmMgd3JhcHBlZEZvckNhbGxzKF8gZ2VuZXJpY3M6IFtTdHJpbmddKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiBpc0dlbmVyaWMoZ2VuZXJpY3MpID8gIlwod3JhcHBlZEZvckNhbGwpLndyYXBBc0dlbmVyaWMoKSIgOiAiXCh3cmFwcGVkRm9yQ2FsbCkiCiAgICB9CgogICAgZnVuYyBhc01ldGhvZEFyZ3VtZW50KCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwocGFyYW1ldGVyLmFyZ3VtZW50TGFiZWwgPz8gIl8iKSBcKHBhcmFtZXRlci5uYW1lKTogXChwYXJhbWV0ZXIudHlwZU5hbWUpIgogICAgfQogICAgZnVuYyBsYWJlbEFuZE5hbWUoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBsYWJlbCA9IHBhcmFtZXRlci5hcmd1bWVudExhYmVsID8/ICJfIgogICAgICAgIHJldHVybiBsYWJlbCAhPSAiXChwYXJhbWV0ZXIubmFtZSkiID8gIlwobGFiZWwpIFwocGFyYW1ldGVyLm5hbWUpIiA6IGxhYmVsCiAgICB9CiAgICBmdW5jIHNhbml0aXplZEZvckVudW1DYXNlTmFtZSgpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbGV0IGxhYmVsID0gcGFyYW1ldGVyLmFyZ3VtZW50TGFiZWwgewogICAgICAgICAgICByZXR1cm4gIlwobGFiZWwpX1wocGFyYW1ldGVyLm5hbWUpIi5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwocGFyYW1ldGVyLm5hbWUpIi5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikKICAgICAgICB9CiAgICB9Cn0KY2xhc3MgVHlwZVdyYXBwZXIgewogICAgbGV0IHR5cGU6IFNvdXJjZXJ5UnVudGltZS5UeXBlTmFtZQoKICAgIHZhciB1bndyYXBwZWQ6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHR5cGUudW53cmFwcGVkVHlwZU5hbWUKICAgIH0KICAgIHZhciB1bndyYXBwZWRSZXBsYWNpbmdTZWxmOiBTdHJpbmcgewogICAgICAgIHJldHVybiByZXBsYWNpbmdTZWxmKHVud3JhcDogdHJ1ZSkKICAgIH0KICAgIHZhciBzdHJpcHBlZDogU3RyaW5nIHsKICAgICAgICBpZiB0eXBlLmlzSW1wbGljaXRseVVud3JhcHBlZE9wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuIHR5cGUuaXNDbG9zdXJlID8gIihcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpKT8iIDogIlwodW53cmFwcGVkUmVwbGFjaW5nU2VsZik/IgogICAgICAgIH0gZWxzZSBpZiB0eXBlLmlzT3B0aW9uYWwgewogICAgICAgICAgICByZXR1cm4gdHlwZS5pc0Nsb3N1cmUgPyAiKFwodW53cmFwcGVkUmVwbGFjaW5nU2VsZikpPyIgOiAiXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKT8iCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVud3JhcHBlZFJlcGxhY2luZ1NlbGYKICAgICAgICB9CiAgICB9CiAgICB2YXIgbmVzdGVkUGFyYW1ldGVyOiBTdHJpbmcgewogICAgICAgIGlmIHR5cGUuaXNJbXBsaWNpdGx5VW53cmFwcGVkT3B0aW9uYWwgewogICAgICAgICAgICByZXR1cm4gIlBhcmFtZXRlcjwiICsgKHR5cGUuaXNDbG9zdXJlID8gIihcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpKT8iIDogIlwodW53cmFwcGVkUmVwbGFjaW5nU2VsZik/IikgKyAiPiIKICAgICAgICB9IGVsc2UgaWYgdHlwZS5pc09wdGlvbmFsIHsKICAgICAgICAgICAgcmV0dXJuICJQYXJhbWV0ZXI8IiArICh0eXBlLmlzQ2xvc3VyZSA/ICIoXCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKSk/IiA6ICJcKHVud3JhcHBlZFJlcGxhY2luZ1NlbGYpPyIpICsgIj4iCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJQYXJhbWV0ZXI8XCh1bndyYXBwZWRSZXBsYWNpbmdTZWxmKT4iCiAgICAgICAgfQogICAgfQogICAgdmFyIGlzU2VsZlR5cGU6IEJvb2wgewogICAgICAgIHJldHVybiB1bndyYXBwZWQgPT0gIlNlbGYiCiAgICB9CiAgICBmdW5jIGlzU2VsZlR5cGVSZWN1cnNpdmUoKSAtPiBCb29sIHsKICAgICAgICBpZiBsZXQgdHVwbGUgPSB0eXBlLnR1cGxlIHsKICAgICAgICAgICAgZm9yIGVsZW1lbnQgaW4gdHVwbGUuZWxlbWVudHMgewogICAgICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKGVsZW1lbnQudHlwZU5hbWUpLmlzU2VsZlR5cGVSZWN1cnNpdmUoKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIGxldCBhcnJheSA9IHR5cGUuYXJyYXkgewogICAgICAgICAgICByZXR1cm4gVHlwZVdyYXBwZXIoYXJyYXkuZWxlbWVudFR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkKICAgICAgICB9IGVsc2UgaWYgbGV0IGRpY3Rpb25hcnkgPSB0eXBlLmRpY3Rpb25hcnkgewogICAgICAgICAgICBndWFyZCAhVHlwZVdyYXBwZXIoZGljdGlvbmFyeS52YWx1ZVR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKGRpY3Rpb25hcnkua2V5VHlwZU5hbWUpLmlzU2VsZlR5cGVSZWN1cnNpdmUoKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIH0gZWxzZSBpZiBsZXQgY2xvc3VyZSA9IHR5cGUuY2xvc3VyZSB7CiAgICAgICAgICAgIGd1YXJkICFUeXBlV3JhcHBlcihjbG9zdXJlLmFjdHVhbFJldHVyblR5cGVOYW1lKS5pc1NlbGZUeXBlUmVjdXJzaXZlKCkgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAgICAgZm9yIHBhcmFtZXRlciBpbiBjbG9zdXJlLnBhcmFtZXRlcnMgewogICAgICAgICAgICAgICAgZ3VhcmQgIVR5cGVXcmFwcGVyKHBhcmFtZXRlci50eXBlTmFtZSkuaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpIGVsc2UgeyByZXR1cm4gdHJ1ZSB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBpc1NlbGZUeXBlCiAgICB9CgogICAgaW5pdChfIHR5cGU6IFNvdXJjZXJ5UnVudGltZS5UeXBlTmFtZSkgewogICAgICAgIHNlbGYudHlwZSA9IHR5cGUKICAgIH0KCiAgICBmdW5jIGlzR2VuZXJpYyhfIHR5cGVzOiBbU3RyaW5nXSkgLT4gQm9vbCB7CiAgICAgICAgZ3VhcmQgIXR5cGUuaXNWb2lkIGVsc2UgeyByZXR1cm4gZmFsc2UgfQoKICAgICAgICByZXR1cm4gaXNHZW5lcmljKG5hbWU6IHVud3JhcHBlZCwgZ2VuZXJpY3M6IHR5cGVzKQogICAgfQoKICAgIHByaXZhdGUgZnVuYyBpc0dlbmVyaWMobmFtZTogU3RyaW5nLCBnZW5lcmljczogW1N0cmluZ10pIC0+IEJvb2wgewogICAgICAgIGxldCBuYW1lID0gIihcKG5hbWUucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpKSkiCiAgICAgICAgbGV0IG1vZGlmaWVycyA9ICJbXFw/XFwhXSoiCiAgICAgICAgcmV0dXJuIGdlbmVyaWNzLmNvbnRhaW5zKHdoZXJlOiB7IGdlbmVyaWMgaW4KICAgICAgICAgICAgbGV0IHdyYXBwZWQgPSAiKFtcXChdXChnZW5lcmljKVwobW9kaWZpZXJzKVtcXClcXC5dKSIKICAgICAgICAgICAgbGV0IGNvbnN0cmFpbnQgPSAiKFs8LF1cKGdlbmVyaWMpXChtb2RpZmllcnMpWz4sXFwuXSkiCiAgICAgICAgICAgIGxldCBhcnJheXMgPSAiKFtcXFs6XVwoZ2VuZXJpYylcKG1vZGlmaWVycylbXFxdLFxcLjpdKSIKICAgICAgICAgICAgbGV0IHR1cGxlcyA9ICIoW1xcKCxdXChnZW5lcmljKVwobW9kaWZpZXJzKVssXFwuXFwpXSkiCiAgICAgICAgICAgIGxldCBjbG9zdXJlcyA9ICIoKFxcLVxcPilcKGdlbmVyaWMpXChtb2RpZmllcnMpWyxcXC5cXCldKSIKICAgICAgICAgICAgbGV0IHBhdHRlcm4gPSAiXCh3cmFwcGVkKXxcKGNvbnN0cmFpbnQpfFwoYXJyYXlzKXxcKHR1cGxlcyl8XChjbG9zdXJlcykiCiAgICAgICAgICAgIGd1YXJkIGxldCByZWdleCA9IHRyeT8gTlNSZWd1bGFyRXhwcmVzc2lvbihwYXR0ZXJuOiBwYXR0ZXJuKSBlbHNlIHsgcmV0dXJuIGZhbHNlIH0KICAgICAgICAgICAgcmV0dXJuIHJlZ2V4LmZpcnN0TWF0Y2goaW46IG5hbWUsIG9wdGlvbnM6IFtdLCByYW5nZTogTlNSYW5nZShsb2NhdGlvbjogMCwgbGVuZ3RoOiAobmFtZSBhcyBOU1N0cmluZykubGVuZ3RoKSkgIT0gbmlsCiAgICAgICAgfSkKICAgIH0KCiAgICBmdW5jIHJlcGxhY2luZ1NlbGYodW53cmFwOiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgaXNTZWxmVHlwZVJlY3Vyc2l2ZSgpIGVsc2UgewogICAgICAgICAgICByZXR1cm4gdW53cmFwID8gc2VsZi51bndyYXBwZWQgOiAiXCh0eXBlKSIKICAgICAgICB9CgogICAgICAgIGlmIGlzU2VsZlR5cGUgewogICAgICAgICAgICBsZXQgb3B0aW9uYWxpdHk6IFN0cmluZyA9IHsKICAgICAgICAgICAgICAgIGlmIHR5cGUuaXNJbXBsaWNpdGx5VW53cmFwcGVkT3B0aW9uYWwgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiISIKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiB0eXBlLmlzT3B0aW9uYWwgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAiPyIKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0oKQogICAgICAgICAgICByZXR1cm4gdW53cmFwID8gQ3VycmVudC5zZWxmVHlwZSA6IEN1cnJlbnQuc2VsZlR5cGUgKyBvcHRpb25hbGl0eQogICAgICAgIH0gZWxzZSBpZiBsZXQgdHVwbGUgPSB0eXBlLnR1cGxlIHsKICAgICAgICAgICAgbGV0IGlubmVyID0gdHVwbGUuZWxlbWVudHMubWFwKHsgVHlwZVdyYXBwZXIoJDAudHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKSB9KS5qb2luZWQoc2VwYXJhdG9yOiAiLCIpCiAgICAgICAgICAgIGxldCB2YWx1ZSA9ICIoXChpbm5lcikpIgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB9IGVsc2UgaWYgbGV0IGFycmF5ID0gdHlwZS5hcnJheSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9ICJbXChUeXBlV3JhcHBlcihhcnJheS5lbGVtZW50VHlwZU5hbWUpLnJlcGxhY2luZ1NlbGYoKSldIgogICAgICAgICAgICByZXR1cm4gdmFsdWUKICAgICAgICB9IGVsc2UgaWYgbGV0IGRpY3Rpb25hcnkgPSB0eXBlLmRpY3Rpb25hcnkgewogICAgICAgICAgICBsZXQgdmFsdWUgPSAiWyIgKwogICAgICAgICAgICAgICAgIlwoVHlwZVdyYXBwZXIoZGljdGlvbmFyeS52YWx1ZVR5cGVOYW1lKS5yZXBsYWNpbmdTZWxmKCkpIgogICAgICAgICAgICAgICAgKyAiOiIgKwogICAgICAgICAgICAgICAgIlwoVHlwZVdyYXBwZXIoZGljdGlvbmFyeS5rZXlUeXBlTmFtZSkucmVwbGFjaW5nU2VsZigpKSIKICAgICAgICAgICAgICAgICsgIl0iCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIH0gZWxzZSBpZiBsZXQgY2xvc3VyZSA9IHR5cGUuY2xvc3VyZSB7CiAgICAgICAgICAgIGxldCByZXR1cm5UeXBlID0gVHlwZVdyYXBwZXIoY2xvc3VyZS5hY3R1YWxSZXR1cm5UeXBlTmFtZSkucmVwbGFjaW5nU2VsZigpCiAgICAgICAgICAgIGxldCBpbm5lciA9IGNsb3N1cmUucGFyYW1ldGVycy5tYXAoeyBUeXBlV3JhcHBlcigkMC50eXBlTmFtZSkucmVwbGFjaW5nU2VsZigpIH0pLmpvaW5lZChzZXBhcmF0b3I6ICIsIikKICAgICAgICAgICAgbGV0IHRocm93aW5nID0gY2xvc3VyZS50aHJvd3MgPyAidGhyb3dzICIgOiAiIgogICAgICAgICAgICBsZXQgdmFsdWUgPSAiKFwoaW5uZXIpKSBcKHRocm93aW5nKS0+IFwocmV0dXJuVHlwZSkiCiAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHVud3JhcCA/IHNlbGYudW53cmFwcGVkIDogIlwodHlwZSkiCiAgICB9Cn0KY2xhc3MgTWV0aG9kV3JhcHBlciB7CiAgICBwcml2YXRlIGZ1bmMgZGVwcmVjYXRlZE1lc3NhZ2UoXyBwcmVmZXJyZWQ6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiQGF2YWlsYWJsZSgqLCBkZXByZWNhdGVkLCBtZXNzYWdlOiBcIlRoaXMgY29uc3RydWN0b3IgaXMgZGVwcmVjYXRlZCwgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB2My4xXChwcmVmZXJyZWQpXCIpXG5cdFx0IgogICAgfQogICAgcHJpdmF0ZSB2YXIgbm9TdHViRGVmaW5lZE1lc3NhZ2U6IFN0cmluZyB7IHJldHVybiAiU3R1YiByZXR1cm4gdmFsdWUgbm90IHNwZWNpZmllZCBmb3IgXChtZXRob2QubmFtZSkuIFVzZSBnaXZlbiIgfQoKICAgIHByaXZhdGUgc3RhdGljIHZhciByZWdpc3RlcmVkOiBbU3RyaW5nOiBJbnRdID0gWzpdCiAgICBwcml2YXRlIHN0YXRpYyB2YXIgc3VmZml4ZXM6IFtTdHJpbmc6IEludF0gPSBbOl0KICAgIHByaXZhdGUgc3RhdGljIHZhciBzdWZmaXhlc1dpdGhvdXRSZXR1cm5UeXBlOiBbU3RyaW5nOiBJbnRdID0gWzpdCgogICAgbGV0IG1ldGhvZDogU291cmNlcnlSdW50aW1lLk1ldGhvZAogICAgdmFyIGFjY2Vzc01vZGlmaWVyOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNTdGF0aWMgZWxzZSB7IHJldHVybiAicHVibGljIHN0YXRpYyIgfQogICAgICAgIGd1YXJkICFyZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmIGVsc2UgeyByZXR1cm4gInB1YmxpYyIgfQogICAgICAgIHJldHVybiAib3BlbiIKICAgIH0KCiAgICBwcml2YXRlIHZhciByZWdpc3RyYXRpb25OYW1lOiBTdHJpbmcgewogICAgICAgIHZhciByYXdOYW1lID0gKG1ldGhvZC5pc1N0YXRpYyA/ICJzbSpcKG1ldGhvZC5zZWxlY3Rvck5hbWUpIiA6ICJtKlwobWV0aG9kLnNlbGVjdG9yTmFtZSkiKQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIl8iLCB3aXRoOiAiIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIoIiwgd2l0aDogIl9fIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIpIiwgd2l0aDogIiIpCgogICAgICAgIHZhciBwYXJhbWV0ZXJzTmFtZXMgPSBtZXRob2QucGFyYW1ldGVycy5tYXAgeyAiXCgkMC5uYW1lKSIgfQoKICAgICAgICB3aGlsZSBsZXQgcmFuZ2UgPSByYXdOYW1lLnJhbmdlKG9mOiAiOiIpLCBsZXQgbmFtZSA9IHBhcmFtZXRlcnNOYW1lcy5maXJzdCB7CiAgICAgICAgICAgIHBhcmFtZXRlcnNOYW1lcy5yZW1vdmVGaXJzdCgpCiAgICAgICAgICAgIHJhd05hbWUucmVwbGFjZVN1YnJhbmdlKHJhbmdlLCB3aXRoOiAiX1wobmFtZSkiKQogICAgICAgIH0KCiAgICAgICAgbGV0IHRyaW1TZXQgPSBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiXyIpCgogICAgICAgIHJldHVybiAgcmF3TmFtZQogICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIjoiLCB3aXRoOiAiIikKICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJtKiIsIHdpdGg6ICJtXyIpCiAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiX19fIiwgd2l0aDogIl9fIikudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiB0cmltU2V0KQogICAgfQogICAgcHJpdmF0ZSB2YXIgdW5pcXVlTmFtZTogU3RyaW5nIHsKICAgICAgICB2YXIgcmF3TmFtZSA9IChtZXRob2QuaXNTdGF0aWMgPyAic21fXChtZXRob2Quc2VsZWN0b3JOYW1lKSIgOiAibV9cKG1ldGhvZC5zZWxlY3Rvck5hbWUpIikKICAgICAgICB2YXIgcGFyYW1ldGVyc05hbWVzID0gbWV0aG9kLnBhcmFtZXRlcnMubWFwIHsgIlwoJDAubmFtZSlfb2ZfXCgkMC50eXBlTmFtZS5uYW1lKSIgfQoKICAgICAgICB3aGlsZSBsZXQgcmFuZ2UgPSByYXdOYW1lLnJhbmdlKG9mOiAiOiIpLCBsZXQgbmFtZSA9IHBhcmFtZXRlcnNOYW1lcy5maXJzdCB7CiAgICAgICAgICAgIHBhcmFtZXRlcnNOYW1lcy5yZW1vdmVGaXJzdCgpCiAgICAgICAgICAgIHJhd05hbWUucmVwbGFjZVN1YnJhbmdlKHJhbmdlLCB3aXRoOiAiX1wobmFtZSkiKQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJhd05hbWUudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiXyIpKQogICAgfQogICAgcHJpdmF0ZSB2YXIgdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlOiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwobWV0aG9kLnJldHVyblR5cGVOYW1lKSIKICAgICAgICB2YXIgcmV0dXJuVHlwZVN0cmlwcGVkOiBTdHJpbmcgPSB7CiAgICAgICAgICAgIGd1YXJkIGxldCByYW5nZSA9IHJldHVyblR5cGVSYXcucmFuZ2Uob2Y6ICJ3aGVyZSIpIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVJhdyB9CiAgICAgICAgICAgIHZhciBzdHJpcHBlZCA9IHJldHVyblR5cGVSYXcKICAgICAgICAgICAgc3RyaXBwZWQucmVtb3ZlU3VicmFuZ2UoKHJhbmdlLmxvd2VyQm91bmQpLi4uKQogICAgICAgICAgICByZXR1cm4gc3RyaXBwZWQKICAgICAgICB9KCkKICAgICAgICByZXR1cm5UeXBlU3RyaXBwZWQgPSByZXR1cm5UeXBlU3RyaXBwZWQudHJpbW1pbmdDaGFyYWN0ZXJzKGluOiBDaGFyYWN0ZXJTZXQoY2hhcmFjdGVyc0luOiAiICIpKQogICAgICAgIHJldHVybiAiXCh1bmlxdWVOYW1lKS0+XChyZXR1cm5UeXBlU3RyaXBwZWQpIgogICAgfQogICAgcHJpdmF0ZSB2YXIgbmFtZVN1ZmZpeDogU3RyaW5nIHsKICAgICAgICBndWFyZCBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbcmVnaXN0cmF0aW9uTmFtZV0gZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgY291bnQgPiAxIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIGxldCBpbmRleCA9IE1ldGhvZFdyYXBwZXIuc3VmZml4ZXNbdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlXSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIl9cKGluZGV4KSIKICAgIH0KCiAgICB2YXIgcHJvdG90eXBlOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChyZWdpc3RyYXRpb25OYW1lKVwobmFtZVN1ZmZpeCkiLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiYCIsIHdpdGg6ICIiKQogICAgfQogICAgdmFyIHBhcmFtZXRlcnM6IFtQYXJhbWV0ZXJXcmFwcGVyXSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZC5wYXJhbWV0ZXJzLm1hcCB7IFBhcmFtZXRlcldyYXBwZXIoJDApIH0KICAgIH0KICAgIHZhciBmdW5jdGlvblByb3RvdHlwZTogU3RyaW5nIHsKICAgICAgICBsZXQgdGhyb3dpbmc6IFN0cmluZyA9IHsKICAgICAgICAgICAgaWYgbWV0aG9kLnRocm93cyB7CiAgICAgICAgICAgICAgICByZXR1cm4gInRocm93cyAiCiAgICAgICAgICAgIH0gZWxzZSBpZiBtZXRob2QucmV0aHJvd3MgewogICAgICAgICAgICAgICAgcmV0dXJuICJyZXRocm93cyAiCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgfQogICAgICAgIH0oKQoKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXI6IFN0cmluZyA9ICJcKGFjY2Vzc01vZGlmaWVyKSAiCiAgICAgICAgaWYgbWV0aG9kLmlzSW5pdGlhbGl6ZXIgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyByZXF1aXJlZCBcKG1ldGhvZC5uYW1lKSBcKHRocm93aW5nKSIKICAgICAgICB9IGVsc2UgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCB7CiAgICAgICAgICAgIGxldCB3aGVyZVBhcnRJZk5lZWRlZDogU3RyaW5nID0gewogICAgICAgICAgICAgICAgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUuaGFzUHJlZml4KCJWb2lkIikgewogICAgICAgICAgICAgICAgICAgIGxldCByYW5nZSA9IG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lLnJhbmdlKG9mOiAiVm9pZCIpIQogICAgICAgICAgICAgICAgICAgIHJldHVybiAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUubmFtZVtyYW5nZS51cHBlckJvdW5kLi4uXSkiCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhbWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUuaXNFbXB0eSA/ICJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lKSAiIDogIiIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSgpCiAgICAgICAgICAgIHJldHVybiAiXChzdGF0aWNNb2RpZmllcilmdW5jIFwobWV0aG9kLnNob3J0TmFtZSlcKHBhcmFtZXRlcnNGb3JTdHViU2lnbmF0dXJlKCkpIFwodGhyb3dpbmcpXCh3aGVyZVBhcnRJZk5lZWRlZCkiCiAgICAgICAgfSBlbHNlIGlmIHJldHVybnNHZW5lcmljQ29uc3RyYWluZWRUb1NlbGYgewogICAgICAgICAgICByZXR1cm4gIlwoc3RhdGljTW9kaWZpZXIpZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpXChwYXJhbWV0ZXJzRm9yU3R1YlNpZ25hdHVyZSgpKSBcKHRocm93aW5nKS0+IFwocmV0dXJuVHlwZVJlcGxhY2luZ1NlbGYpICIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlwoc3RhdGljTW9kaWZpZXIpZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpXChwYXJhbWV0ZXJzRm9yU3R1YlNpZ25hdHVyZSgpKSBcKHRocm93aW5nKS0+IFwobWV0aG9kLnJldHVyblR5cGVOYW1lLm5hbWUpICIKICAgICAgICB9CiAgICB9CiAgICB2YXIgaW52b2NhdGlvbjogU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiYWRkSW52b2NhdGlvbiguXChwcm90b3R5cGUpKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gImFkZEludm9jYXRpb24oLlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkpKSkiCiAgICAgICAgfQogICAgfQogICAgdmFyIGdpdmVuVmFsdWU6IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGd1YXJkIG1ldGhvZC50aHJvd3MgfHwgIW1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgIGxldCBtZXRob2RUeXBlID0gbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSA/ICIuXChwcm90b3R5cGUpIiA6ICIuXChwcm90b3R5cGUpKFwocGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoKSkpIgogICAgICAgIGxldCByZXR1cm5UeXBlOiBTdHJpbmcgPSByZXR1cm5zU2VsZiA/ICJfX1NlbGZfXyIgOiAiXChUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkKSIKCiAgICAgICAgaWYgbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCB7CiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgXG5cdFx0ZG8gewogICAgICAgICAgICBcdFx0ICAgIF8gPSB0cnkgbWV0aG9kUmV0dXJuVmFsdWUoXChtZXRob2RUeXBlKSkuY2FzdGVkKCkgYXMgVm9pZAogICAgICAgICAgICBcdFx0fVwoIiAiKQogICAgICAgICAgICAiIiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzT3B0aW9uYWwgPyAiID0gbmlsIiA6ICIiCiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgXG5cdFx0dmFyIF9fdmFsdWU6IFwocmV0dXJuVHlwZSlcKGRlZmF1bHRWYWx1ZSkKICAgICAgICAgICAgXHRcdGRvIHsKICAgICAgICAgICAgXHRcdCAgICBfX3ZhbHVlID0gdHJ5IG1ldGhvZFJldHVyblZhbHVlKFwobWV0aG9kVHlwZSkpLmNhc3RlZCgpCiAgICAgICAgICAgIFx0XHR9XCgiICIpCiAgICAgICAgICAgICIiIgogICAgICAgIH0KICAgIH0KICAgIHZhciB0aHJvd1ZhbHVlOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNJbml0aWFsaXplciBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICBndWFyZCBtZXRob2QudGhyb3dzIHx8ICFtZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCBzYWZlRmFpbHVyZSA9IG1ldGhvZC5pc1N0YXRpYyA/ICIiIDogIlx0XHRcdG9uRmF0YWxGYWlsdXJlKFwiXChub1N0dWJEZWZpbmVkTWVzc2FnZSlcIilcbiIKICAgICAgICAvLyBGb3IgVm9pZCBhbmQgUmV0dXJuaW5nIG9wdGlvbmFscyAtIHdlIGFsbG93IG5vdCBzdHViYmVkIGNhc2UgdG8gaGFwcGVuLCBhcyB3ZSBhcmUgc3RpbGwgYWJsZSB0byByZXR1cm4KICAgICAgICBsZXQgbm9TdHViSGFuZGxpbmcgPSBtZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkIHx8IG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc09wdGlvbmFsID8gIlx0XHRcdC8vIGRvIG5vdGhpbmciIDogIlwoc2FmZUZhaWx1cmUpXHRcdFx0RmFpbHVyZShcIlwobm9TdHViRGVmaW5lZE1lc3NhZ2UpXCIpIgogICAgICAgIGd1YXJkIG1ldGhvZC50aHJvd3MgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIiIKICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICBcKG5vU3R1YkhhbmRsaW5nKQogICAgICAgICAgICBcdFx0fQogICAgICAgICAgICAiIiIKICAgICAgICB9CgogICAgICAgIHJldHVybiAiIiIKICAgICAgICBjYXRjaCBNb2NrRXJyb3Iubm90U3R1YmVkIHsKICAgICAgICBcKG5vU3R1YkhhbmRsaW5nKQogICAgICAgIFx0XHR9IGNhdGNoIHsKICAgICAgICBcdFx0ICAgIHRocm93IGVycm9yCiAgICAgICAgXHRcdH0KICAgICAgICAiIiIKICAgIH0KICAgIHZhciByZXR1cm5WYWx1ZTogU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgZWxzZSB7IHJldHVybiAiIiB9CgogICAgICAgIHJldHVybiAiXG5cdFx0cmV0dXJuIF9fdmFsdWUiCiAgICB9CiAgICB2YXIgZXF1YWxDYXNlOiBTdHJpbmcgewogICAgICAgIGd1YXJkICFtZXRob2QuaXNJbml0aWFsaXplciBlbHNlIHsgcmV0dXJuICIiIH0KCiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAiY2FzZSAoLlwocHJvdG90eXBlKSwgLlwocHJvdG90eXBlKSk6IgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBsaHNQYXJhbXMgPSBtZXRob2QucGFyYW1ldGVycy5tYXAgeyAibGV0IGxoc1woJDAubmFtZS5jYXBpdGFsaXplZCkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICAgICAgbGV0IHJoc1BhcmFtcyA9IG1ldGhvZC5wYXJhbWV0ZXJzLm1hcCB7ICJsZXQgcmhzXCgkMC5uYW1lLmNhcGl0YWxpemVkKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgICAgICByZXR1cm4gImNhc2UgKC5cKHByb3RvdHlwZSkoXChsaHNQYXJhbXMpKSwgLlwocHJvdG90eXBlKShcKHJoc1BhcmFtcykpKToiCiAgICAgICAgfQogICAgfQogICAgdmFyIGludFZhbHVlQ2FzZTogU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJjYXNlIC5cKHByb3RvdHlwZSk6IHJldHVybiAwIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBwYXJhbXMgPSBtZXRob2QucGFyYW1ldGVycy5lbnVtZXJhdGVkKCkubWFwIHsgb2Zmc2V0LCBfIGluCiAgICAgICAgICAgICAgICByZXR1cm4gInBcKG9mZnNldCkiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGRlZmluaXRpb25zID0gcGFyYW1zLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgICAgIGxldCBwYXJhbXNTdW0gPSBwYXJhbXMubWFwKHsgIlwoJDApLmludFZhbHVlIiB9KS5qb2luZWQoc2VwYXJhdG9yOiAiICsgIikKICAgICAgICAgICAgcmV0dXJuICJjYXNlIGxldCAuXChwcm90b3R5cGUpKFwoZGVmaW5pdGlvbnMpKTogcmV0dXJuIFwocGFyYW1zU3VtKSIKICAgICAgICB9CiAgICB9CgogICAgdmFyIHJldHVybnNTZWxmOiBCb29sIHsKICAgICAgICBndWFyZCAhcmV0dXJuc0dlbmVyaWNDb25zdHJhaW5lZFRvU2VsZiBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIHJldHVybiAhbWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLmlzU2VsZlR5cGUKICAgIH0KICAgIHZhciByZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmOiBCb29sIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZSA9ICJcKG1ldGhvZC5yZXR1cm5UeXBlTmFtZS5uYW1lKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpCiAgICAgICAgLy8gR2VuZXJpY3MsICBsaWtlIE15Y2xhc3M8U2VsZiwgUT4KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiPFNlbGY+IikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiPFNlbGYsIikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiLFNlbGY+IikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICBndWFyZCAhcmV0dXJuVHlwZS5jb250YWlucygiLFNlbGYsIikgZWxzZSB7IHJldHVybiB0cnVlIH0KICAgICAgICAvLyBHZW5lcmljcyBMaXRlcmFscyBsaWtlIFtTZWxmOiBJbnRdIGV0YwogICAgICAgIGd1YXJkICFyZXR1cm5UeXBlLmNvbnRhaW5zKCJbU2VsZl0iKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIGd1YXJkICFyZXR1cm5UeXBlLmNvbnRhaW5zKCI6U2VsZl0iKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIGd1YXJkICFyZXR1cm5UeXBlLmNvbnRhaW5zKCJbU2VsZjoiKSBlbHNlIHsgcmV0dXJuIHRydWUgfQogICAgICAgIHJldHVybiBmYWxzZQogICAgfQogICAgdmFyIHJldHVyblR5cGVSZXBsYWNpbmdTZWxmOiBTdHJpbmcgewogICAgICAgIHJldHVybiAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUubmFtZSkgIgogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICI8U2VsZj4iLCB3aXRoOiAiPFwocmVwbGFjZVNlbGYpPiIpCiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIjxTZWxmICIsIHdpdGg6ICI8XChyZXBsYWNlU2VsZikgIikKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiPFNlbGYsIiwgd2l0aDogIjxcKHJlcGxhY2VTZWxmKSwiKQogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgU2VsZj4iLCB3aXRoOiAiIFwocmVwbGFjZVNlbGYpPiIpCiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIixTZWxmPiIsIHdpdGg6ICIsXChyZXBsYWNlU2VsZik+IikKICAgICAgICAgICAgLy8gbGl0ZXJhbHMKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGZdIiwgd2l0aDogIltcKHJlcGxhY2VTZWxmKV0iKQogICAgICAgICAgICAvLyByaWdodAogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJbU2VsZiAiLCB3aXRoOiAiW1wocmVwbGFjZVNlbGYpICIpCiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIltTZWxmLCIsIHdpdGg6ICJbXChyZXBsYWNlU2VsZiksIikKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiW1NlbGY6Iiwgd2l0aDogIltcKHJlcGxhY2VTZWxmKToiKQogICAgICAgICAgICAvLyBsZWZ0CiAgICAgICAgICAgIC5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogIiBTZWxmXSIsIHdpdGg6ICIgXChyZXBsYWNlU2VsZildIikKICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiLFNlbGZdIiwgd2l0aDogIixcKHJlcGxhY2VTZWxmKV0iKQogICAgICAgICAgICAucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICI6U2VsZl0iLCB3aXRoOiAiOlwocmVwbGFjZVNlbGYpXSIpCiAgICAgICAgICAgIC8vIHVua25vd24KICAgICAgICAgICAgLnJlcGxhY2luZ09jY3VycmVuY2VzKG9mOiAiIFNlbGYgIiwgd2l0aDogIiBcKHJlcGxhY2VTZWxmKSAiKQogICAgfQoKCiAgICB2YXIgcmVwbGFjZVNlbGY6IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIEN1cnJlbnQuc2VsZlR5cGUKICAgIH0KCiAgICBpbml0KF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kKSB7CiAgICAgICAgc2VsZi5tZXRob2QgPSBtZXRob2QKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGZ1bmMgY2xlYXIoKSAtPiBTdHJpbmcgewogICAgICAgIE1ldGhvZFdyYXBwZXIucmVnaXN0ZXJlZCA9IFs6XQogICAgICAgIE1ldGhvZFdyYXBwZXIuc3VmZml4ZXMgPSBbOl0KICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGUgPSBbOl0KICAgICAgICByZXR1cm4gIiIKICAgIH0KCiAgICBmdW5jIHJlZ2lzdGVyKCkgewogICAgICAgIE1ldGhvZFdyYXBwZXIucmVnaXN0ZXIocmVnaXN0cmF0aW9uTmFtZSx1bmlxdWVOYW1lLHVuaXF1ZU5hbWVXaXRoUmV0dXJuVHlwZSkKICAgIH0KCiAgICBzdGF0aWMgZnVuYyByZWdpc3RlcihfIG5hbWU6IFN0cmluZywgXyB1bmlxdWVOYW1lOiBTdHJpbmcsIF8gdW5pcXVlTmFtZVdpdGhSZXR1cm5UeXBlOiBTdHJpbmcpIHsKICAgICAgICBpZiBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gPSBjb3VudCArIDEKICAgICAgICAgICAgTWV0aG9kV3JhcHBlci5zdWZmaXhlc1t1bmlxdWVOYW1lV2l0aFJldHVyblR5cGVdID0gY291bnQgKyAxCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgTWV0aG9kV3JhcHBlci5yZWdpc3RlcmVkW25hbWVdID0gMQogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzW3VuaXF1ZU5hbWVXaXRoUmV0dXJuVHlwZV0gPSAxCiAgICAgICAgfQoKICAgICAgICBpZiBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPSBjb3VudCArIDEKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPSAxCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgcmV0dXJuVHlwZU1hdHRlcnMoKSAtPiBCb29sIHsKICAgICAgICBsZXQgY291bnQgPSBNZXRob2RXcmFwcGVyLnN1ZmZpeGVzV2l0aG91dFJldHVyblR5cGVbdW5pcXVlTmFtZV0gPz8gMAogICAgICAgIHJldHVybiBjb3VudCA+IDEKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRJbk1ldGhvZFR5cGUoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gIW1ldGhvZC5pc0luaXRpYWxpemVyCiAgICB9CgogICAgZnVuYyByZXR1cm5pbmdQYXJhbWV0ZXIoXyBtdWx0aXBsZTogQm9vbCwgXyBmcm9udDogQm9vbCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCByZXR1cm5UeXBlTWF0dGVycygpIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCByZXR1cm5pbmc6IFN0cmluZyA9ICJyZXR1cm5pbmc6IFwocmV0dXJuVHlwZVN0cmlwcGVkKG1ldGhvZCwgdHlwZTogdHJ1ZSkpIgogICAgICAgIGd1YXJkIG11bHRpcGxlIGVsc2UgeyByZXR1cm4gcmV0dXJuaW5nIH0KCiAgICAgICAgcmV0dXJuIGZyb250ID8gIiwgXChyZXR1cm5pbmcpIiA6ICJcKHJldHVybmluZyksICIKICAgIH0KCiAgICAvLyBTdHViCiAgICBmdW5jIHN0dWJCb2R5KCkgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QuaXNJbml0aWFsaXplciB8fCAhcmV0dXJuc1NlbGYgewogICAgICAgICAgICByZXR1cm4gaW52b2NhdGlvbiArIHBlcmZvcm1DYWxsKCkgKyBnaXZlblZhbHVlICsgdGhyb3dWYWx1ZSArIHJldHVyblZhbHVlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHdyYXBwZWRTdHViUHJlZml4KCkKICAgICAgICAgICAgICAgICsgIlx0XHQiICsgaW52b2NhdGlvbgogICAgICAgICAgICAgICAgKyBwZXJmb3JtQ2FsbCgpCiAgICAgICAgICAgICAgICArIGdpdmVuVmFsdWUKICAgICAgICAgICAgICAgICsgdGhyb3dWYWx1ZQogICAgICAgICAgICAgICAgKyByZXR1cm5WYWx1ZQogICAgICAgICAgICAgICAgKyB3cmFwcGVkU3R1YlBvc3RmaXgoKQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHdyYXBwZWRTdHViUHJlZml4KCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIsIHJldHVybnNTZWxmIGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICB9CgogICAgICAgIGxldCB0aHJvd2luZzogU3RyaW5nID0gewogICAgICAgICAgICBpZiBtZXRob2QudGhyb3dzIHsKICAgICAgICAgICAgICAgIHJldHVybiAidGhyb3dzICIKICAgICAgICAgICAgfSBlbHNlIGlmIG1ldGhvZC5yZXRocm93cyB7CiAgICAgICAgICAgICAgICByZXR1cm4gInJldGhyb3dzICIKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICB9CiAgICAgICAgfSgpCgogICAgICAgIHJldHVybiAiZnVuYyBfd3JhcHBlZDxfX1NlbGZfXz4oKSBcKHRocm93aW5nKS0+IF9fU2VsZl9fIHtcbiIKICAgIH0KCiAgICBmdW5jIHdyYXBwZWRTdHViUG9zdGZpeCgpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5pc0luaXRpYWxpemVyLCByZXR1cm5zU2VsZiBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgfQoKICAgICAgICBsZXQgdGhyb3dpbmc6IFN0cmluZyA9IChtZXRob2QudGhyb3dzIHx8IG1ldGhvZC5yZXRocm93cykgPyAidHJ5ICI6ICIiCgogICAgICAgIHJldHVybiAiXG5cdFx0fSIKICAgICAgICAgICAgKyAiXG5cdFx0cmV0dXJuIFwodGhyb3dpbmcpX3dyYXBwZWQoKSIKICAgIH0KCiAgICAvLyBNZXRob2QgVHlwZQogICAgZnVuYyBtZXRob2RUeXBlRGVjbGFyYXRpb25XaXRoUGFyYW1ldGVycygpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgIW1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgZWxzZSB7IHJldHVybiAiXChwcm90b3R5cGUpIiB9CiAgICAgICAgcmV0dXJuICJcKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kVHlwZURlY2xhcmF0aW9uKCkpKSIKICAgIH0KCiAgICAvLyBHaXZlbgogICAgZnVuYyBjb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSAtPiBCb29sIHsKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5jb250YWlucyh3aGVyZTogeyAkMC5wYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCA9PSBuaWwgfSkKICAgIH0KCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogU3RyaW5nID0gIiIsIGRlcHJlY2F0ZWQ6IEJvb2wgPSBmYWxzZSwgYW5ub3RhdGVkOiBCb29sID0gdHJ1ZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgYW5ub3RhdGlvbiA9IGFubm90YXRlZCAmJiBkZXByZWNhdGVkID8gZGVwcmVjYXRlZE1lc3NhZ2UoZGVwcmVjYXRlZFBhcmFtZXRlcnNNZXNzYWdlKCkpIDogIiIKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkCgogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKHdpbGxSZXR1cm46IFwocmV0dXJuVHlwZVN0cmluZykuLi4pIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcKGFubm90YXRpb24pcHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kLnNob3J0TmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoZGVwcmVjYXRlZDogZGVwcmVjYXRlZCkpLCB3aWxsUmV0dXJuOiBcKHJldHVyblR5cGVTdHJpbmcpLi4uKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3JOYW1lVGhyb3dzKHByZWZpeDogU3RyaW5nID0gIiIsIGRlcHJlY2F0ZWQ6IEJvb2wgPSBmYWxzZSwgYW5ub3RhdGVkOiBCb29sID0gdHJ1ZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgYW5ub3RhdGlvbiA9IGFubm90YXRlZCAmJiBkZXByZWNhdGVkID8gZGVwcmVjYXRlZE1lc3NhZ2UoZGVwcmVjYXRlZFBhcmFtZXRlcnNNZXNzYWdlKCkpIDogIiIKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKSh3aWxsVGhyb3c6IEVycm9yLi4uKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiXChhbm5vdGF0aW9uKXB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKGRlcHJlY2F0ZWQ6IGRlcHJlY2F0ZWQpKSwgd2lsbFRocm93OiBFcnJvci4uLikgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9CiAgICB9CgogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KUdpdmVuKG1ldGhvZDogLlwocHJvdG90eXBlKSwgcHJvZHVjdHM6IHdpbGxSZXR1cm4ubWFwKHsgU3R1YlByb2R1Y3QucmV0dXJuKCQwIGFzIEFueSkgfSkpIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KUdpdmVuKG1ldGhvZDogLlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JQcm94eUluaXQoKSkpLCBwcm9kdWN0czogd2lsbFJldHVybi5tYXAoeyBTdHViUHJvZHVjdC5yZXR1cm4oJDAgYXMgQW55KSB9KSkiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Db25zdHJ1Y3RvclRocm93cyhwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClHaXZlbihtZXRob2Q6IC5cKHByb3RvdHlwZSksIHByb2R1Y3RzOiB3aWxsVGhyb3cubWFwKHsgU3R1YlByb2R1Y3QudGhyb3coJDApIH0pKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gInJldHVybiBcKHByZWZpeClHaXZlbihtZXRob2Q6IC5cKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkpKSwgcHJvZHVjdHM6IHdpbGxUaHJvdy5tYXAoeyBTdHViUHJvZHVjdC50aHJvdygkMCkgfSkpIgogICAgICAgIH0KICAgIH0KCiAgICAvLyBHaXZlbiB3aWxsUHJvZHVjZQogICAgZnVuYyBnaXZlblByb2R1Y2VDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkCiAgICAgICAgbGV0IHByb2R1Y2VDbG9zdXJlID0gIihTdHViYmVyPFwocmV0dXJuVHlwZVN0cmluZyk+KSAtPiBWb2lkIgoKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKSh3aWxsUHJvZHVjZTogXChwcm9kdWNlQ2xvc3VyZSkpIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJwdWJsaWMgc3RhdGljIGZ1bmMgXChtZXRob2Quc2hvcnROYW1lKShcKHBhcmFtZXRlcnNGb3JQcm94eVNpZ25hdHVyZSgpKSwgd2lsbFByb2R1Y2U6IFwocHJvZHVjZUNsb3N1cmUpKSAtPiBcKHByZWZpeClNZXRob2RTdHViIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIGdpdmVuUHJvZHVjZUNvbnN0cnVjdG9yTmFtZVRocm93cyhwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gcmV0dXJuc1NlbGYgPyByZXBsYWNlU2VsZiA6IFR5cGVXcmFwcGVyKG1ldGhvZC5yZXR1cm5UeXBlTmFtZSkuc3RyaXBwZWQKICAgICAgICBsZXQgcHJvZHVjZUNsb3N1cmUgPSAiKFN0dWJiZXJUaHJvd3M8XChyZXR1cm5UeXBlU3RyaW5nKT4pIC0+IFZvaWQiCgogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKHdpbGxQcm9kdWNlOiBcKHByb2R1Y2VDbG9zdXJlKSkgLT4gXChwcmVmaXgpTWV0aG9kU3R1YiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZC5zaG9ydE5hbWUpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKCkpLCB3aWxsUHJvZHVjZTogXChwcm9kdWNlQ2xvc3VyZSkpIC0+IFwocHJlZml4KU1ldGhvZFN0dWIiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3IocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBUeXBlV3JhcHBlcihtZXRob2QucmV0dXJuVHlwZU5hbWUpLnN0cmlwcGVkCiAgICAgICAgcmV0dXJuICIiIgogICAgICAgIGxldCB3aWxsUmV0dXJuOiBbXChyZXR1cm5UeXBlU3RyaW5nKV0gPSBbXQogICAgICAgIFx0XHRcdGxldCBnaXZlbjogXChwcmVmaXgpR2l2ZW4gPSB7IFwoZ2l2ZW5Db25zdHJ1Y3RvcihwcmVmaXg6IHByZWZpeCkpIH0oKQogICAgICAgIFx0XHRcdGxldCBzdHViYmVyID0gZ2l2ZW4uc3R1Yihmb3I6IChcKHJldHVyblR5cGVTdHJpbmcpKS5zZWxmKQogICAgICAgIFx0XHRcdHdpbGxQcm9kdWNlKHN0dWJiZXIpCiAgICAgICAgXHRcdFx0cmV0dXJuIGdpdmVuCiAgICAgICAgIiIiCiAgICB9CgogICAgZnVuYyBnaXZlblByb2R1Y2VDb25zdHJ1Y3RvclRocm93cyhwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gcmV0dXJuc1NlbGYgPyByZXBsYWNlU2VsZiA6IFR5cGVXcmFwcGVyKG1ldGhvZC5yZXR1cm5UeXBlTmFtZSkuc3RyaXBwZWQKICAgICAgICByZXR1cm4gIiIiCiAgICAgICAgbGV0IHdpbGxUaHJvdzogW0Vycm9yXSA9IFtdCiAgICAgICAgXHRcdFx0bGV0IGdpdmVuOiBcKHByZWZpeClHaXZlbiA9IHsgXChnaXZlbkNvbnN0cnVjdG9yVGhyb3dzKHByZWZpeDogcHJlZml4KSkgfSgpCiAgICAgICAgXHRcdFx0bGV0IHN0dWJiZXIgPSBnaXZlbi5zdHViVGhyb3dzKGZvcjogKFwocmV0dXJuVHlwZVN0cmluZykpLnNlbGYpCiAgICAgICAgXHRcdFx0d2lsbFByb2R1Y2Uoc3R1YmJlcikKICAgICAgICBcdFx0XHRyZXR1cm4gZ2l2ZW4KICAgICAgICAiIiIKICAgIH0KCiAgICAvLyBWZXJpZnkKICAgIGZ1bmMgdmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiBTdHJpbmcgPSAiIiwgZGVwcmVjYXRlZDogQm9vbCA9IGZhbHNlLCBhbm5vdGF0ZWQ6IEJvb2wgPSB0cnVlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCAoYW5ub3RhdGlvbiwgbWV0aG9kTmFtZSwgZ2VuZXJpY0NvbnN0cmFpbnMpID0gbWV0aG9kSW5mbyhkZXByZWNhdGVkLCBhbm5vdGF0ZWQpCgogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZE5hbWUpKFwocmV0dXJuaW5nUGFyYW1ldGVyKGZhbHNlLHRydWUpKSkgLT4gXChwcmVmaXgpVmVyaWZ5XChnZW5lcmljQ29uc3RyYWlucykiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcKGFubm90YXRpb24pcHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kTmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoZGVwcmVjYXRlZDogZGVwcmVjYXRlZCkpXChyZXR1cm5pbmdQYXJhbWV0ZXIodHJ1ZSx0cnVlKSkpIC0+IFwocHJlZml4KVZlcmlmeVwoZ2VuZXJpY0NvbnN0cmFpbnMpIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3IocHJlZml4OiBTdHJpbmcgPSAiIikgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpVmVyaWZ5KG1ldGhvZDogLlwocHJvdG90eXBlKSkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpVmVyaWZ5KG1ldGhvZDogLlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JQcm94eUluaXQoKSkpKSIKICAgICAgICB9CiAgICB9CgogICAgLy8gUGVyZm9ybQogICAgZnVuYyBwZXJmb3JtUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiBTdHJpbmcgPSAiIiwgZGVwcmVjYXRlZDogQm9vbCA9IGZhbHNlLCBhbm5vdGF0ZWQ6IEJvb2wgPSB0cnVlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCAoYW5ub3RhdGlvbiwgbWV0aG9kTmFtZSwgZ2VuZXJpY0NvbnN0cmFpbnMpID0gbWV0aG9kSW5mbyhkZXByZWNhdGVkLCBhbm5vdGF0ZWQpCgogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKG1ldGhvZE5hbWUpKFwocmV0dXJuaW5nUGFyYW1ldGVyKHRydWUsZmFsc2UpKXBlcmZvcm06IEBlc2NhcGluZyBcKHBlcmZvcm1Qcm94eUNsb3N1cmVUeXBlKCkpKSAtPiBcKHByZWZpeClQZXJmb3JtXChnZW5lcmljQ29uc3RyYWlucykiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJcKGFubm90YXRpb24pcHVibGljIHN0YXRpYyBmdW5jIFwobWV0aG9kTmFtZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoZGVwcmVjYXRlZDogZGVwcmVjYXRlZCkpLCBcKHJldHVybmluZ1BhcmFtZXRlcih0cnVlLGZhbHNlKSlwZXJmb3JtOiBAZXNjYXBpbmcgXChwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpKSkgLT4gXChwcmVmaXgpUGVyZm9ybVwoZ2VuZXJpY0NvbnN0cmFpbnMpIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgaWYgbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSB7CiAgICAgICAgICAgIHJldHVybiAicmV0dXJuIFwocHJlZml4KVBlcmZvcm0obWV0aG9kOiAuXChwcm90b3R5cGUpLCBwZXJmb3JtczogcGVyZm9ybSkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpUGVyZm9ybShtZXRob2Q6IC5cKHByb3RvdHlwZSkoXChwYXJhbWV0ZXJzRm9yUHJveHlJbml0KCkpKSwgcGVyZm9ybXM6IHBlcmZvcm0pIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHBlcmZvcm1Qcm94eUNsb3N1cmVUeXBlKCkgLT4gU3RyaW5nIHsKICAgICAgICBpZiBtZXRob2QucGFyYW1ldGVycy5pc0VtcHR5IHsKICAgICAgICAgICAgcmV0dXJuICIoKSAtPiBWb2lkIgogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBwYXJhbWV0ZXJzID0gc2VsZi5wYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAubWFwIHsgIlwoJDAuanVzdFBlcmZvcm1UeXBlKSIgfQogICAgICAgICAgICAgICAgLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgICAgIHJldHVybiAiKFwocGFyYW1ldGVycykpIC0+IFZvaWQiCiAgICAgICAgfQogICAgfQoKICAgIGZ1bmMgcGVyZm9ybVByb3h5Q2xvc3VyZUNhbGwoKSAtPiBTdHJpbmcgewogICAgICAgIGlmIG1ldGhvZC5wYXJhbWV0ZXJzLmlzRW1wdHkgewogICAgICAgICAgICByZXR1cm4gInBlcmZvcm0/KCkiCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IHBhcmFtZXRlcnMgPSBtZXRob2QucGFyYW1ldGVycwogICAgICAgICAgICAgICAgLm1hcCB7IHAgaW4KICAgICAgICAgICAgICAgICAgICBsZXQgd3JhcHBlZCA9IFBhcmFtZXRlcldyYXBwZXIocCkKICAgICAgICAgICAgICAgICAgICBsZXQgaXNBdXRvbG9zdXJlID0gd3JhcHBlZC5qdXN0VHlwZS5oYXNQcmVmaXgoIkBhdXRvY2xvc3VyZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJcKHAuaW5vdXQgPyAiJiIgOiAiIilgXChwLm5hbWUpYFwoaXNBdXRvbG9zdXJlID8gIigpIiA6ICIiKSIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKQogICAgICAgICAgICByZXR1cm4gInBlcmZvcm0/KFwocGFyYW1ldGVycykpIgogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHBlcmZvcm1DYWxsKCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCAhbWV0aG9kLmlzSW5pdGlhbGl6ZXIgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgbGV0IHR5cGUgPSBwZXJmb3JtUHJveHlDbG9zdXJlVHlwZSgpCiAgICAgICAgdmFyIHByb3h5ID0gbWV0aG9kLnBhcmFtZXRlcnMuaXNFbXB0eSA/ICJcKHByb3RvdHlwZSkiIDogIlwocHJvdG90eXBlKShcKHBhcmFtZXRlcnNGb3JNZXRob2RDYWxsKCkpKSIKCiAgICAgICAgbGV0IGNhc3QgPSAibGV0IHBlcmZvcm0gPSBtZXRob2RQZXJmb3JtVmFsdWUoLlwocHJveHkpKSBhcz8gXCh0eXBlKSIKICAgICAgICBsZXQgY2FsbCA9IHBlcmZvcm1Qcm94eUNsb3N1cmVDYWxsKCkKCiAgICAgICAgcmV0dXJuICJcblx0XHRcKGNhc3QpXG5cdFx0XChjYWxsKSIKICAgIH0KCiAgICAvLyBIZWxwZXJzCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljcyA9IGdldEdlbmVyaWNzV2l0aG91dENvbnN0cmFpbnRzKCkKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5tYXAgeyAkMC53cmFwcGVkRm9yQ2FsbHMoZ2VuZXJpY3MpIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0Zvck1ldGhvZFR5cGVEZWNsYXJhdGlvbigpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdlbmVyaWNzID0gZ2V0R2VuZXJpY3NXaXRob3V0Q29uc3RyYWludHMoKQogICAgICAgIHJldHVybiBwYXJhbWV0ZXJzLm1hcCB7IHBhcmFtIGluCiAgICAgICAgICAgIHJldHVybiBwYXJhbS5pc0dlbmVyaWMoZ2VuZXJpY3MpID8gcGFyYW0uZ2VuZXJpY1R5cGUgOiBwYXJhbS5uZXN0ZWRUeXBlCiAgICAgICAgICAgIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKGRlcHJlY2F0ZWQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gcGFyYW1ldGVycy5tYXAgeyBwIGluCiAgICAgICAgICAgIGd1YXJkIGRlcHJlY2F0ZWQgZWxzZSB7IHJldHVybiAiXChwLmxhYmVsQW5kTmFtZSgpKTogXChwLm5lc3RlZFR5cGUpIiB9CiAgICAgICAgICAgIGd1YXJkIGxldCBhcmd1bWVudExhYmVsID0gcC5wYXJhbWV0ZXIuYXJndW1lbnRMYWJlbCBlbHNlIHsgcmV0dXJuICJcKHAucGFyYW1ldGVyLm5hbWUpOiBcKHAubmVzdGVkVHlwZSkiIH0KICAgICAgICAgICAgZ3VhcmQgYXJndW1lbnRMYWJlbCAhPSBwLm5hbWUgZWxzZSB7IHJldHVybiAiXChwLnBhcmFtZXRlci5uYW1lKTogXChwLm5lc3RlZFR5cGUpIiB9CiAgICAgICAgICAgIHJldHVybiAiXChhcmd1bWVudExhYmVsKSBcKHAucGFyYW1ldGVyLm5hbWUpOiBcKHAubmVzdGVkVHlwZSkiCiAgICAgICAgICAgIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgZGVwcmVjYXRlZFBhcmFtZXRlcnNNZXNzYWdlKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgbmV3UGFyYW1zID0gcGFyYW1ldGVycy5tYXAgeyBwIGluIHJldHVybiAiXChwLnBhcmFtZXRlci5hcmd1bWVudExhYmVsID8/ICJfIikiIH0KICAgICAgICBsZXQgb2xkUGFyYW1zID0gcGFyYW1ldGVycy5tYXAgeyBwIC0+IFN0cmluZyBpbgogICAgICAgICAgICBndWFyZCBsZXQgYXJndW1lbnRMYWJlbCA9IHAucGFyYW1ldGVyLmFyZ3VtZW50TGFiZWwgZWxzZSB7IHJldHVybiAiXChwLnBhcmFtZXRlci5uYW1lKSIgfQogICAgICAgICAgICBndWFyZCBhcmd1bWVudExhYmVsICE9IHAubmFtZSBlbHNlIHsgcmV0dXJuICJcKHAucGFyYW1ldGVyLm5hbWUpIiB9CiAgICAgICAgICAgIHJldHVybiAiXChhcmd1bWVudExhYmVsKSIKICAgICAgICB9CgogICAgICAgIHZhciBtZXNzYWdlczogW1N0cmluZ10gPSBbXQogICAgICAgIGZvciBpIGluIDAuLjxuZXdQYXJhbXMuY291bnQgewogICAgICAgICAgICBpZiBuZXdQYXJhbXNbaV0gIT0gb2xkUGFyYW1zW2ldIHsKICAgICAgICAgICAgICAgIG1lc3NhZ2VzLmFwcGVuZCgiIHJlbW92ZSBgXChvbGRQYXJhbXNbaV0pYCBsYWJlbCIpCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAiIFBvc3NpYmxlIGZpeDogIiArIG1lc3NhZ2VzLmpvaW5lZChzZXBhcmF0b3I6ICIsIikKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0ZvclN0dWJTaWduYXR1cmUoKSAtPiBTdHJpbmcgewogICAgICAgIGZ1bmMgcmVwbGFjaW5nKGZpcnN0OiBTdHJpbmcsIGluIGZ1bGw6IFN0cmluZywgd2l0aCBvdGhlcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSBmdWxsLnJhbmdlKG9mOiBmaXJzdCkgZWxzZSB7IHJldHVybiBmdWxsIH0KICAgICAgICAgICAgcmV0dXJuIGZ1bGwucmVwbGFjaW5nQ2hhcmFjdGVycyhpbjogcmFuZ2UsIHdpdGg6IG90aGVyKQogICAgICAgIH0KICAgICAgICBsZXQgcHJlZml4ID0gbWV0aG9kLnNob3J0TmFtZQogICAgICAgIGxldCBmdWxsID0gbWV0aG9kLm5hbWUKICAgICAgICBsZXQgcmFuZ2UgPSBmdWxsLnJhbmdlKG9mOiBwcmVmaXgpIQogICAgICAgIHZhciB1bnJlZmluZWQgPSAiXChmdWxsW3JhbmdlLnVwcGVyQm91bmQuLi5dKSIKICAgICAgICBwYXJhbWV0ZXJzLm1hcCB7IHAgLT4gKFN0cmluZyxTdHJpbmcpIGluCiAgICAgICAgICAgIHJldHVybiAoIlwocC50eXBlKSIsIlwocC5qdXN0VHlwZSkiKQogICAgICAgICAgICB9LmZvckVhY2ggewogICAgICAgICAgICAgICAgdW5yZWZpbmVkID0gcmVwbGFjaW5nKGZpcnN0OiAkMCwgaW46IHVucmVmaW5lZCwgd2l0aDogJDEpCiAgICAgICAgfQogICAgICAgIHJldHVybiB1bnJlZmluZWQKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0ZvclByb3h5SW5pdCgpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdlbmVyaWNzID0gZ2V0R2VuZXJpY3NXaXRob3V0Q29uc3RyYWludHMoKQogICAgICAgIHJldHVybiBwYXJhbWV0ZXJzLm1hcCB7ICJcKCQwLndyYXBwZWRGb3JQcm94eShnZW5lcmljcykpIiB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIGlzR2VuZXJpYygpIC0+IEJvb2wgewogICAgICAgIHJldHVybiBtZXRob2Quc2hvcnROYW1lLmNvbnRhaW5zKCI8IikgJiYgbWV0aG9kLnNob3J0TmFtZS5jb250YWlucygiPiIpCiAgICB9CgogICAgLy8vIFJldHVybnMgbGlzdCBvZiBnZW5lcmljcyB1c2VkIGluIG1ldGhvZCBzaWduYXR1cmUsIHdpdGhvdXQgdGhlaXIgY29uc3RyYWludHMgKGxpa2UgW1QsVSxWXSkKICAgIC8vLwogICAgLy8vIC0gUmV0dXJuczogQXJyYXkgb2Ygc3RyaW5ncywgd2hlcmUgZWFjaCBzdHJpbmdzIHJlcHJlc2VudCBnZW5lcmljIG5hbWUKICAgIHByaXZhdGUgZnVuYyBnZXRHZW5lcmljc1dpdGhvdXRDb25zdHJhaW50cygpIC0+IFtTdHJpbmddIHsKICAgICAgICBsZXQgbmFtZSA9IG1ldGhvZC5zaG9ydE5hbWUKICAgICAgICBndWFyZCBsZXQgc3RhcnQgPSBuYW1lLmluZGV4KG9mOiAiPCIpLCBsZXQgZW5kID0gbmFtZS5pbmRleChvZjogIj4iKSBlbHNlIHsgcmV0dXJuIFtdIH0KCiAgICAgICAgdmFyIGdlblBhcnQgPSBuYW1lW3N0YXJ0Li4uZW5kXQogICAgICAgIGdlblBhcnQucmVtb3ZlRmlyc3QoKQogICAgICAgIGdlblBhcnQucmVtb3ZlTGFzdCgpCgogICAgICAgIGxldCBwYXJ0cyA9IGdlblBhcnQucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpLmNoYXJhY3RlcnMuc3BsaXQoc2VwYXJhdG9yOiAiLCIpLm1hcChTdHJpbmcuaW5pdCkKICAgICAgICByZXR1cm4gcGFydHMubWFwIHsgc3RyaXBHZW5QYXJ0KHBhcnQ6ICQwKSB9CiAgICB9CgogICAgLy8vIFJldHVybnMgbGlzdCBvZiBnZW5lcmljIGNvbnN0cmFpbnRlcyBmcm9tIG1ldGhvZCBzaWduYXR1cmUuIERvZXMgb25seSBjb250YWluIHN0dWZmIGJldHdlZW4gJzwnIGFuZCAnPicKICAgIC8vLwogICAgLy8vIC0gUmV0dXJuczogQXJyYXkgb2Ygc3RyaW5ncywgbGlrZSBbIlQ6IENvZGFibGUiLCAiVTogV2hhdGV2ZXIiXQogICAgcHJpdmF0ZSBmdW5jIGdldEdlbmVyaWNzQ29uc3RyYWludHMoXyBnZW5lcmljczogW1N0cmluZ10pIC0+IFtTdHJpbmddIHsKICAgICAgICBsZXQgbmFtZSA9IG1ldGhvZC5zaG9ydE5hbWUKICAgICAgICBndWFyZCBsZXQgc3RhcnQgPSBuYW1lLmluZGV4KG9mOiAiPCIpLCBsZXQgZW5kID0gbmFtZS5pbmRleChvZjogIj4iKSBlbHNlIHsgcmV0dXJuIFtdIH0KCiAgICAgICAgdmFyIGdlblBhcnQgPSBuYW1lW3N0YXJ0Li4uZW5kXQogICAgICAgIGdlblBhcnQucmVtb3ZlRmlyc3QoKQogICAgICAgIGdlblBhcnQucmVtb3ZlTGFzdCgpCgogICAgICAgIGxldCBwYXJ0cyA9IGdlblBhcnQucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICIgIiwgd2l0aDogIiIpLmNoYXJhY3RlcnMuc3BsaXQoc2VwYXJhdG9yOiAiLCIpLm1hcChTdHJpbmcuaW5pdCkKICAgICAgICByZXR1cm4gcGFydHMuZmlsdGVyIHsKICAgICAgICAgICAgbGV0IGNvbXBvbmVudHMgPSAkMC5jb21wb25lbnRzKHNlcGFyYXRlZEJ5OiAiOiIpCiAgICAgICAgICAgIHJldHVybiBjb21wb25lbnRzLmNvdW50ID09IDIgJiYgZ2VuZXJpY3MuY29udGFpbnMoY29tcG9uZW50c1swXSkKICAgICAgICB9CiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIGdldEdlbmVyaWNzQW1vbmdQYXJhbWV0ZXJzKCkgLT4gW1N0cmluZ10gewogICAgICAgIHJldHVybiBnZXRHZW5lcmljc1dpdGhvdXRDb25zdHJhaW50cygpLmZpbHRlciB7CiAgICAgICAgICAgIGZvciBwYXJhbSBpbiBzZWxmLnBhcmFtZXRlcnMgewogICAgICAgICAgICAgICAgaWYgcGFyYW0uaXNHZW5lcmljKFskMF0pIHsgcmV0dXJuIHRydWUgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZQogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgd3JhcEdlbmVyaWNzKF8gZ2VuZXJpY3M6IFtTdHJpbmddKSAtPiBTdHJpbmcgewogICAgICAgIGd1YXJkICFnZW5lcmljcy5pc0VtcHR5IGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIHJldHVybiAiPFwoZ2VuZXJpY3Muam9pbmVkKHNlcGFyYXRvcjoiLCIpKT4iCiAgICB9CgogICAgcHJpdmF0ZSBmdW5jIHN0cmlwR2VuUGFydChwYXJ0OiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHBhcnQuY2hhcmFjdGVycy5zcGxpdChzZXBhcmF0b3I6ICI6IikubWFwKFN0cmluZy5pbml0KS5maXJzdCEKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgcmV0dXJuVHlwZVN0cmlwcGVkKF8gbWV0aG9kOiBTb3VyY2VyeVJ1bnRpbWUuTWV0aG9kLCB0eXBlOiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IHJldHVyblR5cGVSYXcgPSAiXChtZXRob2QucmV0dXJuVHlwZU5hbWUpIgogICAgICAgIHZhciBzdHJpcHBlZDogU3RyaW5nID0gewogICAgICAgICAgICBndWFyZCBsZXQgcmFuZ2UgPSByZXR1cm5UeXBlUmF3LnJhbmdlKG9mOiAid2hlcmUiKSBlbHNlIHsgcmV0dXJuIHJldHVyblR5cGVSYXcgfQogICAgICAgICAgICB2YXIgc3RyaXBwZWQgPSByZXR1cm5UeXBlUmF3CiAgICAgICAgICAgIHN0cmlwcGVkLnJlbW92ZVN1YnJhbmdlKChyYW5nZS5sb3dlckJvdW5kKS4uLikKICAgICAgICAgICAgcmV0dXJuIHN0cmlwcGVkCiAgICAgICAgfSgpCiAgICAgICAgc3RyaXBwZWQgPSBzdHJpcHBlZC50cmltbWluZ0NoYXJhY3RlcnMoaW46IENoYXJhY3RlclNldChjaGFyYWN0ZXJzSW46ICIgIikpCiAgICAgICAgZ3VhcmQgdHlwZSBlbHNlIHsgcmV0dXJuIHN0cmlwcGVkIH0KICAgICAgICByZXR1cm4gIihcKHN0cmlwcGVkKSkuVHlwZSIKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgbWV0aG9kSW5mbyhfIGRlcHJlY2F0ZWQ6IEJvb2wsIF8gYW5ub3RhdGVkOiBCb29sKQogICAgICAgIC0+IChhbm5vdGF0aW9uOiBTdHJpbmcsIG1ldGhvZE5hbWU6IFN0cmluZywgZ2VuZXJpY0NvbnN0cmFpbnM6IFN0cmluZykgewogICAgICAgICAgICBsZXQgZ2VuZXJpY3MgPSBnZXRHZW5lcmljc0Ftb25nUGFyYW1ldGVycygpCiAgICAgICAgICAgIGxldCBhbm5vdGF0aW9uID0gYW5ub3RhdGVkICYmIGRlcHJlY2F0ZWQgPyBkZXByZWNhdGVkTWVzc2FnZShkZXByZWNhdGVkUGFyYW1ldGVyc01lc3NhZ2UoKSkgOiAiIgogICAgICAgICAgICBsZXQgbWV0aG9kTmFtZSA9IHJldHVyblR5cGVNYXR0ZXJzKCkgPyBtZXRob2Quc2hvcnROYW1lIDogIlwobWV0aG9kLmNhbGxOYW1lKVwod3JhcEdlbmVyaWNzKGdlbmVyaWNzKSkiCiAgICAgICAgICAgIGxldCBnZW5lcmljQ29uc3RyYWluczogU3RyaW5nID0gewogICAgICAgICAgICAgICAgbGV0IGNvbnN0cmFpbnRzID0gZ2V0R2VuZXJpY3NDb25zdHJhaW50cyhnZW5lcmljcykKICAgICAgICAgICAgICAgIGd1YXJkICFjb25zdHJhaW50cy5pc0VtcHR5IGVsc2UgeyByZXR1cm4gIiIgfQoKICAgICAgICAgICAgICAgIHJldHVybiAiIHdoZXJlIFwoY29uc3RyYWludHMuam9pbmVkKHNlcGFyYXRvcjogIiwgIikpIgogICAgICAgICAgICB9KCkKICAgICAgICAgICAgcmV0dXJuIChhbm5vdGF0aW9uLCBtZXRob2ROYW1lLCBnZW5lcmljQ29uc3RyYWlucykKICAgIH0KfQpjbGFzcyBTdWJzY3JpcHRXcmFwcGVyIHsKICAgIGxldCB3cmFwcGVkOiBTb3VyY2VyeVJ1bnRpbWUuU3Vic2NyaXB0CiAgICB2YXIgcmVhZG9ubHk6IEJvb2wgeyByZXR1cm4gIXdyYXBwZWQuaXNNdXRhYmxlIH0KICAgIHZhciB3cmFwcGVkUGFyYW1ldGVyczogW1BhcmFtZXRlcldyYXBwZXJdIHsgcmV0dXJuIHdyYXBwZWQucGFyYW1ldGVycy5tYXAgeyBQYXJhbWV0ZXJXcmFwcGVyKCQwKSB9IH0KICAgIHZhciBjYXNlc0NvdW50OiBJbnQgeyByZXR1cm4gcmVhZG9ubHkgPyAxIDogMiB9CiAgICB2YXIgbmVzdGVkVHlwZTogU3RyaW5nIHsgcmV0dXJuICJcKFR5cGVXcmFwcGVyKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpLm5lc3RlZFBhcmFtZXRlcikiIH0KICAgIGxldCBhc3NvY2lhdGVkVHlwZXM6IFtTdHJpbmddPwogICAgbGV0IGdlbmVyaWNUeXBlc0xpc3Q6IFtTdHJpbmddCiAgICBsZXQgZ2VuZXJpY1R5cGVzTW9kaWZpZXI6IFN0cmluZz8KCiAgICBwcml2YXRlIGxldCBub1N0dWJEZWZpbmVkTWVzc2FnZSA9ICJTdHViIHJldHVybiB2YWx1ZSBub3Qgc3BlY2lmaWVkIGZvciBzdWJzY3JpcHQuIFVzZSBnaXZlbiBmaXJzdC4iCgogICAgcHJpdmF0ZSBzdGF0aWMgdmFyIHJlZ2lzdGVyZWQ6IFtTdHJpbmc6IEludF0gPSBbOl0KICAgIHByaXZhdGUgc3RhdGljIHZhciBuYW1lc1dpdGhvdXRSZXR1cm5UeXBlOiBbU3RyaW5nOiBJbnRdID0gWzpdCiAgICBwcml2YXRlIHN0YXRpYyB2YXIgc3VmZml4ZXM6IFtTdHJpbmc6IEludF0gPSBbOl0KICAgIHB1YmxpYyBzdGF0aWMgZnVuYyBjbGVhcigpIC0+IFN0cmluZyB7CiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcmVkID0gWzpdCiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5zdWZmaXhlcyA9IFs6XQogICAgICAgIHJldHVybiAiIgogICAgfQogICAgc3RhdGljIGZ1bmMgcmVnaXN0ZXIoXyBuYW1lOiBTdHJpbmcsIF8gdW5pcXVlTmFtZTogU3RyaW5nKSB7CiAgICAgICAgbGV0IGNvdW50ID0gU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcmVkW25hbWVdID8/IDAKICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnJlZ2lzdGVyZWRbbmFtZV0gPSBjb3VudCArIDEKICAgICAgICBTdWJzY3JpcHRXcmFwcGVyLnN1ZmZpeGVzW3VuaXF1ZU5hbWVdID0gY291bnQgKyAxCiAgICB9CiAgICBzdGF0aWMgZnVuYyByZWdpc3RlcihzaG9ydCBuYW1lOiBTdHJpbmcpIHsKICAgICAgICBsZXQgY291bnQgPSBTdWJzY3JpcHRXcmFwcGVyLm5hbWVzV2l0aG91dFJldHVyblR5cGVbbmFtZV0gPz8gMAogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIubmFtZXNXaXRob3V0UmV0dXJuVHlwZVtuYW1lXSA9IGNvdW50ICsgMQogICAgfQoKICAgIGZ1bmMgcmVnaXN0ZXIoKSB7CiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcihyZWdpc3RyYXRpb25OYW1lKCJnZXQiKSx1bmlxdWVOYW1lKQogICAgICAgIFN1YnNjcmlwdFdyYXBwZXIucmVnaXN0ZXIoc2hvcnQ6IHNob3J0TmFtZSkKICAgICAgICBndWFyZCAhcmVhZG9ubHkgZWxzZSB7IHJldHVybiB9CiAgICAgICAgU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcihyZWdpc3RyYXRpb25OYW1lKCJzZXQiKSx1bmlxdWVOYW1lKQogICAgfQoKICAgIGluaXQoXyB3cmFwcGVkOiBTb3VyY2VyeVJ1bnRpbWUuU3Vic2NyaXB0KSB7CiAgICAgICAgc2VsZi53cmFwcGVkID0gd3JhcHBlZAogICAgICAgIGFzc29jaWF0ZWRUeXBlcyA9IEhlbHBlcnMuZXh0cmFjdEFzc29jaWF0ZWRUeXBlcyhmcm9tOiB3cmFwcGVkKQogICAgICAgIGdlbmVyaWNUeXBlc0xpc3QgPSBIZWxwZXJzLmV4dHJhY3RHZW5lcmljc0xpc3QoYXNzb2NpYXRlZFR5cGVzKQogICAgICAgIGlmIGxldCB0eXBlcyA9IGFzc29jaWF0ZWRUeXBlcyB7CiAgICAgICAgICAgIGdlbmVyaWNUeXBlc01vZGlmaWVyID0gIjxcKHR5cGVzLmpvaW5lZChzZXBhcmF0b3I6ICIsIikpPiIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBnZW5lcmljVHlwZXNNb2RpZmllciA9IG5pbAogICAgICAgIH0KICAgIH0KCiAgICBmdW5jIHJlZ2lzdHJhdGlvbk5hbWUoXyBhY2Nlc3NvcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAic3Vic2NyaXB0X1woYWNjZXNzb3IpX1wod3JhcHBlZFBhcmFtZXRlcnMubWFwKHsgJDAuc2FuaXRpemVkRm9yRW51bUNhc2VOYW1lKCkgfSkuam9pbmVkKHNlcGFyYXRvcjogIl8iKSkiCiAgICB9CiAgICB2YXIgc2hvcnROYW1lOiBTdHJpbmcgeyByZXR1cm4gInB1YmxpYyBzdWJzY3JpcHRcKGdlbmVyaWNUeXBlc01vZGlmaWVyID8/ICIgIikoXCh3cmFwcGVkUGFyYW1ldGVycy5tYXAoeyAkMC5hc01ldGhvZEFyZ3VtZW50KCkgfSkuam9pbmVkKHNlcGFyYXRvcjogIiwgIikpKSIgfQogICAgdmFyIHVuaXF1ZU5hbWU6IFN0cmluZyB7IHJldHVybiAiXChzaG9ydE5hbWUpIC0+IFwod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkiIH0KCiAgICBwcml2YXRlIGZ1bmMgbmFtZVN1ZmZpeChfIGFjY2Vzc29yOiBTdHJpbmcpIC0+IFN0cmluZyB7CiAgICAgICAgZ3VhcmQgbGV0IGNvdW50ID0gU3Vic2NyaXB0V3JhcHBlci5yZWdpc3RlcmVkW3JlZ2lzdHJhdGlvbk5hbWUoYWNjZXNzb3IpXSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICBndWFyZCBjb3VudCA+IDEgZWxzZSB7IHJldHVybiAiIiB9CiAgICAgICAgZ3VhcmQgbGV0IGluZGV4ID0gU3Vic2NyaXB0V3JhcHBlci5zdWZmaXhlc1t1bmlxdWVOYW1lXSBlbHNlIHsgcmV0dXJuICIiIH0KICAgICAgICByZXR1cm4gIl9cKGluZGV4KSIKICAgIH0KCiAgICAvLyBjYWxsCiAgICBmdW5jIHN1YnNjcmlwdENhbGwoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZXQgPSAiXG5cdFx0Z2V0IHtcKGdldHRlcigpKVxuXHRcdH0iCiAgICAgICAgbGV0IHNldCA9IHJlYWRvbmx5ID8gIiIgOiAiXG5cdFx0c2V0IHtcKHNldHRlcigpKVxuXHRcdH0iCiAgICAgICAgcmV0dXJuICJcKHVuaXF1ZU5hbWUpIHtcKGdldClcKHNldClcblx0fSIKICAgIH0KICAgIHByaXZhdGUgZnVuYyBnZXR0ZXIoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBtZXRob2QgPSAiLlwoc3Vic2NyaXB0Q2FzZVByZWZpeCgiZ2V0IikpKFwocGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoKSkpIgogICAgICAgIGxldCBub1N0dWJEZWZpbmVkID0gd3JhcHBlZC5yZXR1cm5UeXBlTmFtZS5pc09wdGlvbmFsID8gInJldHVybiBuaWwiIDogIm9uRmF0YWxGYWlsdXJlKFwiXChub1N0dWJEZWZpbmVkTWVzc2FnZSlcIik7IEZhaWx1cmUoXCJub1N0dWJEZWZpbmVkTWVzc2FnZVwiKSIKICAgICAgICByZXR1cm4KICAgICAgICAgICAgIlxuXHRcdFx0YWRkSW52b2NhdGlvbihcKG1ldGhvZCkpIiArCiAgICAgICAgICAgICAgICAiXG5cdFx0XHRkbyB7IiArCiAgICAgICAgICAgICAgICAiXG5cdFx0XHRcdHJldHVybiB0cnkgbWV0aG9kUmV0dXJuVmFsdWUoXChtZXRob2QpKS5jYXN0ZWQoKSIgKwogICAgICAgICAgICAgICAgIlxuXHRcdFx0fSBjYXRjaCB7IiArCiAgICAgICAgICAgICAgICAiXG5cdFx0XHRcdFwobm9TdHViRGVmaW5lZCkiICsKICAgICAgICAiXG5cdFx0XHR9IgogICAgfQogICAgcHJpdmF0ZSBmdW5jIHNldHRlcigpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IG1ldGhvZCA9ICIuXChzdWJzY3JpcHRDYXNlUHJlZml4KCJzZXQiKSkoXChwYXJhbWV0ZXJzRm9yTWV0aG9kQ2FsbChzZXQ6IHRydWUpKSkiCiAgICAgICAgcmV0dXJuICJcblx0XHRcdGFkZEludm9jYXRpb24oXChtZXRob2QpKSIKICAgIH0KCiAgICAvLyBtZXRob2QgdHlwZQogICAgZnVuYyBzdWJzY3JpcHRDYXNlUHJlZml4KF8gYWNjZXNzb3I6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwocmVnaXN0cmF0aW9uTmFtZShhY2Nlc3NvcikpXChuYW1lU3VmZml4KGFjY2Vzc29yKSkiCiAgICB9CiAgICBmdW5jIHN1YnNjcmlwdENhc2VOYW1lKF8gYWNjZXNzb3I6IFN0cmluZykgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gIlwoc3Vic2NyaXB0Q2FzZVByZWZpeChhY2Nlc3NvcikpKFwocGFyYW1ldGVyc0Zvck1ldGhvZFR5cGVEZWNsYXJhdGlvbihzZXQ6IGFjY2Vzc29yID09ICJzZXQiKSkpIgogICAgfQogICAgZnVuYyBzdWJzY3JpcHRDYXNlcygpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHJlYWRvbmx5ID8gImNhc2UgXChzdWJzY3JpcHRDYXNlTmFtZSgiZ2V0IikpIiA6ICJjYXNlIFwoc3Vic2NyaXB0Q2FzZU5hbWUoImdldCIpKVxuXHRcdGNhc2UgXChzdWJzY3JpcHRDYXNlTmFtZSgic2V0IikpIgogICAgfQogICAgZnVuYyBlcXVhbENhc2UoXyBhY2Nlc3NvcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIHZhciBsaHNQYXJhbXMgPSB3cmFwcGVkLnBhcmFtZXRlcnMubWFwIHsgImxoc1woJDAubmFtZS5jYXBpdGFsaXplZCkiIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICB2YXIgcmhzUGFyYW1zID0gd3JhcHBlZC5wYXJhbWV0ZXJzLm1hcCB7ICJyaHNcKCQwLm5hbWUuY2FwaXRhbGl6ZWQpIiB9LmpvaW5lZChzZXBhcmF0b3I6ICIsICIpCiAgICAgICAgdmFyIGNvbXBhcmF0b3JzID0gd3JhcHBlZFBhcmFtZXRlcnMubWFwIHsgIlx0XHRcdFx0XCgkMC5jb21wYXJhdG9yKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiXG4iKQogICAgICAgIGlmIGFjY2Vzc29yID09ICJzZXQiIHsKICAgICAgICAgICAgbGhzUGFyYW1zICs9ICIsIGxoc0RpZFNldCIKICAgICAgICAgICAgcmhzUGFyYW1zICs9ICIsIHJoc0RpZFNldCIKICAgICAgICAgICAgY29tcGFyYXRvcnMgKz0gIlxuXHRcdFx0XHRyZXR1cm4gUGFyYW1ldGVyLmNvbXBhcmUobGhzOiBsaHNEaWRTZXQsIHJoczogcmhzRGlkU2V0LCB3aXRoOiBtYXRjaGVyKSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb21wYXJhdG9ycyArPSAiXG5cdFx0XHRcdHJldHVybiB0cnVlIgogICAgICAgIH0KICAgICAgICByZXR1cm4gImNhc2UgKGxldCAuXChzdWJzY3JpcHRDYXNlUHJlZml4KGFjY2Vzc29yKSkoXChsaHNQYXJhbXMpKSwgbGV0IC5cKHN1YnNjcmlwdENhc2VQcmVmaXgoYWNjZXNzb3IpKShcKHJoc1BhcmFtcykpKTpcbiIgKyBjb21wYXJhdG9ycwogICAgfQogICAgZnVuYyBlcXVhbENhc2VzKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gcmVhZG9ubHkgPyBlcXVhbENhc2UoImdldCIpIDogIlwoZXF1YWxDYXNlKCJnZXQiKSlcblx0XHRcdFwoZXF1YWxDYXNlKCJzZXQiKSkiCiAgICB9CiAgICBmdW5jIGludFZhbHVlQ2FzZSgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHJlYWRvbmx5ID8gaW50VmFsdWVDYXNlKCJnZXQiKSA6ICJcKGludFZhbHVlQ2FzZSgiZ2V0IikpXG5cdFx0XHRcKGludFZhbHVlQ2FzZSgic2V0IikpIgogICAgfQogICAgZnVuYyBpbnRWYWx1ZUNhc2UoXyBhY2Nlc3NvcjogU3RyaW5nKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBwYXJhbXMgPSB3cmFwcGVkUGFyYW1ldGVycy5lbnVtZXJhdGVkKCkubWFwIHsgb2Zmc2V0LCBfIGluCiAgICAgICAgICAgIHJldHVybiAicFwob2Zmc2V0KSIKICAgICAgICB9CiAgICAgICAgbGV0IGRlZmluaXRpb25zID0gcGFyYW1zLmpvaW5lZChzZXBhcmF0b3I6ICIsICIpICsgKGFjY2Vzc29yID09ICJzZXQiID8gIiwgXyIgOiAiIikKICAgICAgICBsZXQgcGFyYW1zU3VtID0gcGFyYW1zLm1hcCh7ICJcKCQwKS5pbnRWYWx1ZSIgfSkuam9pbmVkKHNlcGFyYXRvcjogIiArICIpCiAgICAgICAgcmV0dXJuICJjYXNlIGxldCAuXChzdWJzY3JpcHRDYXNlUHJlZml4KGFjY2Vzc29yKSkoXChkZWZpbml0aW9ucykpOiByZXR1cm4gXChwYXJhbXNTdW0pIgogICAgfQoKICAgIC8vIEdpdmVuCiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3JOYW1lKCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgcmV0dXJuVHlwZVN0cmluZyA9IHJldHVybnNTZWxmID8gcmVwbGFjZVNlbGYgOiBUeXBlV3JhcHBlcih3cmFwcGVkLnJldHVyblR5cGVOYW1lKS5zdHJpcHBlZAogICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIGBzdWJzY3JpcHRgXChnZW5lcmljVHlwZXNNb2RpZmllciA/PyAiIikoXChwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoKSksIHdpbGxSZXR1cm46IFwocmV0dXJuVHlwZVN0cmluZykuLi4pIC0+IFN1YnNjcmlwdFN0dWIiCiAgICB9CiAgICBmdW5jIGdpdmVuQ29uc3RydWN0b3IoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAicmV0dXJuIEdpdmVuKG1ldGhvZDogLlwoc3Vic2NyaXB0Q2FzZVByZWZpeCgiZ2V0IikpKFwocGFyYW1ldGVyc0ZvclByb3h5SW5pdCgpKSksIHByb2R1Y3RzOiB3aWxsUmV0dXJuLm1hcCh7IFN0dWJQcm9kdWN0LnJldHVybigkMCBhcyBBbnkpIH0pKSIKICAgIH0KCiAgICAvLyBWZXJpZnkKICAgIGZ1bmMgdmVyaWZ5Q29uc3RydWN0b3JOYW1lKHNldDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlU3RyaW5nID0gcmV0dXJuc1NlbGYgPyByZXBsYWNlU2VsZiA6IG5lc3RlZFR5cGUKICAgICAgICBsZXQgcmV0dXJuaW5nID0gc2V0ID8gIiIgOiByZXR1cm5pbmdQYXJhbWV0ZXIodHJ1ZSwgdHJ1ZSkKICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBgc3Vic2NyaXB0YFwoZ2VuZXJpY1R5cGVzTW9kaWZpZXIgPz8gIiIpKFwocGFyYW1ldGVyc0ZvclByb3h5U2lnbmF0dXJlKCkpXChyZXR1cm5pbmcpXChzZXQgPyAiLCBzZXQgbmV3VmFsdWU6IFwocmV0dXJuVHlwZVN0cmluZykiIDogIiIpKSAtPiBWZXJpZnkiCiAgICB9CiAgICBmdW5jIHZlcmlmeUNvbnN0cnVjdG9yKHNldDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAicmV0dXJuIFZlcmlmeShtZXRob2Q6IC5cKHN1YnNjcmlwdENhc2VQcmVmaXgoc2V0ID8gInNldCIgOiAiZ2V0IikpKFwocGFyYW1ldGVyc0ZvclByb3h5SW5pdChzZXQ6IHNldCkpKSkiCiAgICB9CgogICAgLy8gR2VuZXJpY3MKICAgIHByaXZhdGUgZnVuYyBnZXRHZW5lcmljcygpIC0+IFtTdHJpbmddIHsKICAgICAgICByZXR1cm4gZ2VuZXJpY1R5cGVzTGlzdAogICAgfQoKICAgIC8vIEhlbHBlcnMKICAgIHByaXZhdGUgdmFyIHJldHVybnNTZWxmOiBCb29sIHsgcmV0dXJuIFR5cGVXcmFwcGVyKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpLmlzU2VsZlR5cGUgfQogICAgcHJpdmF0ZSB2YXIgcmVwbGFjZVNlbGY6IFN0cmluZyB7IHJldHVybiBDdXJyZW50LnNlbGZUeXBlIH0KICAgIHByaXZhdGUgZnVuYyByZXR1cm5UeXBlU3RyaXBwZWQodHlwZTogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCByZXR1cm5UeXBlUmF3ID0gIlwod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkiCiAgICAgICAgdmFyIHN0cmlwcGVkOiBTdHJpbmcgPSB7CiAgICAgICAgICAgIGd1YXJkIGxldCByYW5nZSA9IHJldHVyblR5cGVSYXcucmFuZ2Uob2Y6ICJ3aGVyZSIpIGVsc2UgeyByZXR1cm4gcmV0dXJuVHlwZVJhdyB9CiAgICAgICAgICAgIHZhciBzdHJpcHBlZCA9IHJldHVyblR5cGVSYXcKICAgICAgICAgICAgc3RyaXBwZWQucmVtb3ZlU3VicmFuZ2UoKHJhbmdlLmxvd2VyQm91bmQpLi4uKQogICAgICAgICAgICByZXR1cm4gc3RyaXBwZWQKICAgICAgICB9KCkKICAgICAgICBzdHJpcHBlZCA9IHN0cmlwcGVkLnRyaW1taW5nQ2hhcmFjdGVycyhpbjogQ2hhcmFjdGVyU2V0KGNoYXJhY3RlcnNJbjogIiAiKSkKICAgICAgICBndWFyZCB0eXBlIGVsc2UgeyByZXR1cm4gc3RyaXBwZWQgfQogICAgICAgIHJldHVybiAiKFwoc3RyaXBwZWQpKS5UeXBlIgogICAgfQogICAgcHJpdmF0ZSBmdW5jIHJldHVyblR5cGVNYXR0ZXJzKCkgLT4gQm9vbCB7CiAgICAgICAgbGV0IGNvdW50ID0gU3Vic2NyaXB0V3JhcHBlci5uYW1lc1dpdGhvdXRSZXR1cm5UeXBlW3Nob3J0TmFtZV0gPz8gMAogICAgICAgIHJldHVybiBjb3VudCA+IDEKICAgIH0KCiAgICAvLyBwYXJhbXMKICAgIHByaXZhdGUgZnVuYyByZXR1cm5pbmdQYXJhbWV0ZXIoXyBtdWx0aXBsZTogQm9vbCwgXyBmcm9udDogQm9vbCkgLT4gU3RyaW5nIHsKICAgICAgICBndWFyZCByZXR1cm5UeXBlTWF0dGVycygpIGVsc2UgeyByZXR1cm4gIiIgfQogICAgICAgIGxldCByZXR1cm5pbmc6IFN0cmluZyA9ICJyZXR1cm5pbmc6IFwocmV0dXJuVHlwZVN0cmlwcGVkKHR5cGU6IHRydWUpKSIKICAgICAgICBndWFyZCBtdWx0aXBsZSBlbHNlIHsgcmV0dXJuIHJldHVybmluZyB9CiAgICAgICAgcmV0dXJuIGZyb250ID8gIiwgXChyZXR1cm5pbmcpIiA6ICJcKHJldHVybmluZyksICIKICAgIH0KICAgIHByaXZhdGUgZnVuYyBwYXJhbWV0ZXJzRm9yTWV0aG9kVHlwZURlY2xhcmF0aW9uKHNldDogQm9vbCA9IGZhbHNlKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBnZW5lcmljczogW1N0cmluZ10gPSBnZXRHZW5lcmljcygpCiAgICAgICAgbGV0IHBhcmFtcyA9IHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCB7IHBhcmFtIGluCiAgICAgICAgICAgIHJldHVybiBwYXJhbS5pc0dlbmVyaWMoZ2VuZXJpY3MpID8gcGFyYW0uZ2VuZXJpY1R5cGUgOiBwYXJhbS5uZXN0ZWRUeXBlCiAgICAgICAgICAgIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICBndWFyZCBzZXQgZWxzZSB7IHJldHVybiBwYXJhbXMgfQogICAgICAgIGxldCBuZXdWYWx1ZSA9IFR5cGVXcmFwcGVyKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpLmlzR2VuZXJpYyhnZW5lcmljcykgPyAiUGFyYW1ldGVyPEdlbmVyaWNBdHRyaWJ1dGU+IiA6IG5lc3RlZFR5cGUKICAgICAgICByZXR1cm4gIlwocGFyYW1zKSwgXChuZXdWYWx1ZSkiCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0ZvclByb3h5SW5pdChzZXQ6IEJvb2wgPSBmYWxzZSkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgZ2VuZXJpY3MgPSBnZXRHZW5lcmljcygpCiAgICAgICAgbGV0IG5ld1ZhbHVlID0gVHlwZVdyYXBwZXIod3JhcHBlZC5yZXR1cm5UeXBlTmFtZSkuaXNHZW5lcmljKGdlbmVyaWNzKSA/ICJuZXdWYWx1ZS53cmFwQXNHZW5lcmljKCkiIDogIm5ld1ZhbHVlIgogICAgICAgIHJldHVybiB3cmFwcGVkUGFyYW1ldGVycy5tYXAgeyAiXCgkMC53cmFwcGVkRm9yUHJveHkoZ2VuZXJpY3MpKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKSArIChzZXQgPyAiLCBcKG5ld1ZhbHVlKSIgOiAiIikKICAgIH0KICAgIHByaXZhdGUgZnVuYyBwYXJhbWV0ZXJzRm9yUHJveHlTaWduYXR1cmUoc2V0OiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuIHdyYXBwZWRQYXJhbWV0ZXJzLm1hcCB7ICJcKCQwLmxhYmVsQW5kTmFtZSgpKTogXCgkMC5uZXN0ZWRUeXBlKSIgfS5qb2luZWQoc2VwYXJhdG9yOiAiLCAiKSArIChzZXQgPyAiLCBzZXQgbmV3VmFsdWU6IFwobmVzdGVkVHlwZSkiIDogIiIpCiAgICB9CiAgICBwcml2YXRlIGZ1bmMgcGFyYW1ldGVyc0Zvck1ldGhvZENhbGwoc2V0OiBCb29sID0gZmFsc2UpIC0+IFN0cmluZyB7CiAgICAgICAgbGV0IGdlbmVyaWNzID0gZ2V0R2VuZXJpY3MoKQogICAgICAgIGxldCBwYXJhbXMgPSB3cmFwcGVkUGFyYW1ldGVycy5tYXAgeyAkMC53cmFwcGVkRm9yQ2FsbHMoZ2VuZXJpY3MpIH0uam9pbmVkKHNlcGFyYXRvcjogIiwgIikKICAgICAgICBsZXQgcG9zdGZpeCA9IFR5cGVXcmFwcGVyKHdyYXBwZWQucmV0dXJuVHlwZU5hbWUpLmlzR2VuZXJpYyhnZW5lcmljcykgPyAiLndyYXBBc0dlbmVyaWMoKSIgOiAiIgogICAgICAgIHJldHVybiAhc2V0ID8gcGFyYW1zIDogIlwocGFyYW1zKSwgXChuZXN0ZWRUeXBlKS52YWx1ZShuZXdWYWx1ZSlcKHBvc3RmaXgpIgogICAgfQp9CmNsYXNzIFZhcmlhYmxlV3JhcHBlciB7CiAgICBsZXQgdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZQogICAgbGV0IHNjb3BlOiBTdHJpbmcKICAgIHZhciByZWFkb25seTogQm9vbCB7IHJldHVybiB2YXJpYWJsZS53cml0ZUFjY2Vzcy5pc0VtcHR5IH0KICAgIHZhciBwcml2YXRlUHJvdG90eXBlTmFtZTogU3RyaW5nIHsgcmV0dXJuICJfX3BfXCh2YXJpYWJsZS5uYW1lKSIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJgIiwgd2l0aDogIiIpIH0KICAgIHZhciBjYXNlc0NvdW50OiBJbnQgeyByZXR1cm4gcmVhZG9ubHkgPyAxIDogMiB9CgogICAgbGV0IGRlcHJlY2F0ZWRNZXNzYWdlID0gIlVzaW5nIHNldHRlcnMgb24gcmVhZG9ubHkgdmFyaWFibGVzIGlzIGRlcHJlY2F0ZWQsIGFuZCB3aWxsIGJlIHJlbW92ZWQgaW4gMy4xLiBVc2UgR2l2ZW4gdG8gZGVmaW5lIHN0dWJiZWQgcHJvcGVydHkgcmV0dXJuIHZhbHVlLiIKICAgIHZhciBub1N0dWJEZWZpbmVkTWVzc2FnZTogU3RyaW5nIHsgcmV0dXJuICJcKHNjb3BlKSAtIHN0dWIgdmFsdWUgZm9yIFwodmFyaWFibGUubmFtZSkgd2FzIG5vdCBkZWZpbmVkIiB9CgogICAgdmFyIGdldHRlcjogU3RyaW5nIHsKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXIgPSB2YXJpYWJsZS5pc1N0YXRpYyA/ICJcKHNjb3BlKS4iIDogIiIKICAgICAgICBsZXQgcmV0dXJuVmFsdWUgPSB2YXJpYWJsZS5pc09wdGlvbmFsID8gIm9wdGlvbmFsR2l2ZW5HZXR0ZXJWYWx1ZSguXChwcm9wZXJ0eUNhc2VHZXROYW1lKSwgXCJcKG5vU3R1YkRlZmluZWRNZXNzYWdlKVwiKSIgOiAiZ2l2ZW5HZXR0ZXJWYWx1ZSguXChwcm9wZXJ0eUNhc2VHZXROYW1lKSwgXCJcKG5vU3R1YkRlZmluZWRNZXNzYWdlKVwiKSIKICAgICAgICByZXR1cm4gIlxuXHRcdGdldCB7XHRcKHN0YXRpY01vZGlmaWVyKWludm9jYXRpb25zLmFwcGVuZCguXChwcm9wZXJ0eUNhc2VHZXROYW1lKSk7IHJldHVybiBcKHN0YXRpY01vZGlmaWVyKVwocHJpdmF0ZVByb3RvdHlwZU5hbWUpID8/IFwocmV0dXJuVmFsdWUpIH0iCiAgICB9CiAgICB2YXIgc2V0dGVyOiBTdHJpbmcgewogICAgICAgIGxldCBzdGF0aWNNb2RpZmllciA9IHZhcmlhYmxlLmlzU3RhdGljID8gIlwoc2NvcGUpLiIgOiAiIgogICAgICAgIGlmIHJlYWRvbmx5IHsKICAgICAgICAgICAgbGV0IGFubm90YXRpb24gPSByZWFkb25seSA/ICJcblx0XHRAYXZhaWxhYmxlKCosIGRlcHJlY2F0ZWQsIG1lc3NhZ2U6IFwiXChkZXByZWNhdGVkTWVzc2FnZSlcIikiIDogIiIKICAgICAgICAgICAgcmV0dXJuICJcKGFubm90YXRpb24pXG5cdFx0c2V0IHtcdFwodmFyaWFibGUuaXNTdGF0aWMgPyAiXChzY29wZSkuIiA6ICIiKVwocHJpdmF0ZVByb3RvdHlwZU5hbWUpID0gbmV3VmFsdWUgfSIKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIlxuXHRcdHNldCB7XHRcKHN0YXRpY01vZGlmaWVyKWludm9jYXRpb25zLmFwcGVuZCguXChwcm9wZXJ0eUNhc2VTZXROYW1lKSgudmFsdWUobmV3VmFsdWUpKSk7IFwodmFyaWFibGUuaXNTdGF0aWMgPyAiXChzY29wZSkuIiA6ICIiKVwocHJpdmF0ZVByb3RvdHlwZU5hbWUpID0gbmV3VmFsdWUgfSIKICAgICAgICB9CiAgICB9CiAgICB2YXIgcHJvdG90eXBlOiBTdHJpbmcgewogICAgICAgIGxldCBzdGF0aWNNb2RpZmllciA9IHZhcmlhYmxlLmlzU3RhdGljID8gInN0YXRpYyAiIDogIiIKCiAgICAgICAgcmV0dXJuICJwdWJsaWMgXChzdGF0aWNNb2RpZmllcil2YXIgXCh2YXJpYWJsZS5uYW1lKTogXCh2YXJpYWJsZS50eXBlTmFtZS5uYW1lKSB7IiArCiAgICAgICAgICAgICJcKGdldHRlcikiICsKICAgICAgICAgICAgIlwoc2V0dGVyKSIgKwogICAgICAgICJcblx0fSIKICAgIH0KCiAgICB2YXIgcHJpdmF0ZVByb3RvdHlwZTogU3RyaW5nIHsKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXIgPSB2YXJpYWJsZS5pc1N0YXRpYyA/ICJzdGF0aWMgIiA6ICIiCiAgICAgICAgcmV0dXJuICJwcml2YXRlIFwoc3RhdGljTW9kaWZpZXIpdmFyIFwocHJpdmF0ZVByb3RvdHlwZU5hbWUpOiAoXCh2YXJpYWJsZS50eXBlTmFtZS51bndyYXBwZWRUeXBlTmFtZSkpPyIKICAgIH0KICAgIHZhciBuZXN0ZWRUeXBlOiBTdHJpbmcgeyByZXR1cm4gIlwoVHlwZVdyYXBwZXIodmFyaWFibGUudHlwZU5hbWUpLm5lc3RlZFBhcmFtZXRlcikiIH0KCiAgICBpbml0KF8gdmFyaWFibGU6IFNvdXJjZXJ5UnVudGltZS5WYXJpYWJsZSwgc2NvcGU6IFN0cmluZykgewogICAgICAgIHNlbGYudmFyaWFibGUgPSB2YXJpYWJsZQogICAgICAgIHNlbGYuc2NvcGUgPSBzY29wZQogICAgfQoKICAgIGZ1bmMgcHJvcGVydHlHZXQoKSAtPiBTdHJpbmcgewogICAgICAgIGxldCBzdGF0aWNNb2RpZmllciA9IHZhcmlhYmxlLmlzU3RhdGljID8gIlN0YXRpYyIgOiAiIgogICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyB2YXIgXCh2YXJpYWJsZS5uYW1lKTogXChzdGF0aWNNb2RpZmllcilWZXJpZnkgeyByZXR1cm4gXChzdGF0aWNNb2RpZmllcilWZXJpZnkobWV0aG9kOiAuXChwcm9wZXJ0eUNhc2VHZXROYW1lKSkgfSIKICAgIH0KCiAgICBmdW5jIHByb3BlcnR5U2V0KCkgLT4gU3RyaW5nIHsKICAgICAgICBsZXQgc3RhdGljTW9kaWZpZXIgPSB2YXJpYWJsZS5pc1N0YXRpYyA/ICJTdGF0aWMiIDogIiIKICAgICAgICByZXR1cm4gInB1YmxpYyBzdGF0aWMgZnVuYyBcKHZhcmlhYmxlLm5hbWUpKHNldCBuZXdWYWx1ZTogXChuZXN0ZWRUeXBlKSkgLT4gXChzdGF0aWNNb2RpZmllcilWZXJpZnkgeyByZXR1cm4gXChzdGF0aWNNb2RpZmllcilWZXJpZnkobWV0aG9kOiAuXChwcm9wZXJ0eUNhc2VTZXROYW1lKShuZXdWYWx1ZSkpIH0iCiAgICB9CgogICAgdmFyIHByb3BlcnR5Q2FzZUdldE5hbWU6IFN0cmluZyB7IHJldHVybiAicF9cKHZhcmlhYmxlLm5hbWUpX2dldCIucmVwbGFjaW5nT2NjdXJyZW5jZXMob2Y6ICJgIiwgd2l0aDogIiIpIH0KICAgIGZ1bmMgcHJvcGVydHlDYXNlR2V0KCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gImNhc2UgXChwcm9wZXJ0eUNhc2VHZXROYW1lKSIKICAgIH0KICAgIGZ1bmMgcHJvcGVydHlDYXNlR2V0Q29tcGFyZSgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJjYXNlICguXChwcm9wZXJ0eUNhc2VHZXROYW1lKSwuXChwcm9wZXJ0eUNhc2VHZXROYW1lKSk6IHJldHVybiB0cnVlIgogICAgfQogICAgZnVuYyBwcm9wZXJ0eUNhc2VHZXRJbnRWYWx1ZSgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJjYXNlIC5cKHByb3BlcnR5Q2FzZUdldE5hbWUpOiByZXR1cm4gMCIKICAgIH0KCiAgICB2YXIgcHJvcGVydHlDYXNlU2V0TmFtZTogU3RyaW5nIHsgcmV0dXJuICJwX1wodmFyaWFibGUubmFtZSlfc2V0Ii5yZXBsYWNpbmdPY2N1cnJlbmNlcyhvZjogImAiLCB3aXRoOiAiIikgfQogICAgZnVuYyBwcm9wZXJ0eUNhc2VTZXQoKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAiY2FzZSBcKHByb3BlcnR5Q2FzZVNldE5hbWUpKFwobmVzdGVkVHlwZSkpIgogICAgfQogICAgZnVuYyBwcm9wZXJ0eUNhc2VTZXRDb21wYXJlKCkgLT4gU3RyaW5nIHsKICAgICAgICByZXR1cm4gImNhc2UgKC5cKHByb3BlcnR5Q2FzZVNldE5hbWUpKGxldCBsZWZ0KSwuXChwcm9wZXJ0eUNhc2VTZXROYW1lKShsZXQgcmlnaHQpKTogcmV0dXJuIFwobmVzdGVkVHlwZSkuY29tcGFyZShsaHM6IGxlZnQsIHJoczogcmlnaHQsIHdpdGg6IG1hdGNoZXIpIgogICAgfQogICAgZnVuYyBwcm9wZXJ0eUNhc2VTZXRJbnRWYWx1ZSgpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJjYXNlIC5cKHByb3BlcnR5Q2FzZVNldE5hbWUpKGxldCBuZXdWYWx1ZSk6IHJldHVybiBuZXdWYWx1ZS5pbnRWYWx1ZSIKICAgIH0KCiAgICAvLyBHaXZlbgogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6IFN0cmluZyA9ICIiKSAtPiBTdHJpbmcgewogICAgICAgIHJldHVybiAicHVibGljIHN0YXRpYyBmdW5jIFwodmFyaWFibGUubmFtZSkoZ2V0dGVyIGRlZmF1bHRWYWx1ZTogXChUeXBlV3JhcHBlcih2YXJpYWJsZS50eXBlTmFtZSkuc3RyaXBwZWQpLi4uKSAtPiBcKHByZWZpeClQcm9wZXJ0eVN0dWIiCiAgICB9CgogICAgZnVuYyBnaXZlbkNvbnN0cnVjdG9yKHByZWZpeDogU3RyaW5nID0gIiIpIC0+IFN0cmluZyB7CiAgICAgICAgcmV0dXJuICJyZXR1cm4gXChwcmVmaXgpR2l2ZW4obWV0aG9kOiAuXChwcm9wZXJ0eUNhc2VHZXROYW1lKSwgcHJvZHVjdHM6IGRlZmF1bHRWYWx1ZS5tYXAoeyBTdHViUHJvZHVjdC5yZXR1cm4oJDAgYXMgQW55KSB9KSkiCiAgICB9Cn0KXyU+CjwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTRVRVUCAtJT48JV8gLSU+CjwlXyB2YXIgYWxsID0gdHlwZXMuYWxsCiAgICBhbGwgKz0gdHlwZXMucHJvdG9jb2xzLm1hcCB7ICQwIH0gLSU+Cgo8JV8gZm9yIHR5cGUgaW4gYWxsIHsgLSU+PCVfIC0lPgo8JV8gbGV0IGF1dG9Nb2NrYWJsZTogQm9vbCA9IHR5cGUuaW5oZXJpdGVkVHlwZXMuY29udGFpbnMoIkF1dG9Nb2NrYWJsZSIpIHx8IHR5cGUuYW5ub3RhdGlvbnNbIkF1dG9Nb2NrYWJsZSJdICE9IG5pbAogICAgbGV0IHByb3RvY29sVG9EZWNvcmF0ZSA9IHR5cGVzLnByb3RvY29scy5maXJzdCh3aGVyZTogeyAkMC5uYW1lID09ICh0eXBlLmFubm90YXRpb25zWyJtb2NrIl0gYXM/IFN0cmluZykgfSkKICAgIGxldCBpbmxpbmVNb2NrYWJsZSA9IHByb3RvY29sVG9EZWNvcmF0ZSAhPSBuaWwKICAgIGd1YXJkIGxldCBhUHJvdG9jb2wgPSBhdXRvTW9ja2FibGUgPyB0eXBlIDogcHJvdG9jb2xUb0RlY29yYXRlIGVsc2UgeyBjb250aW51ZSB9CiAgICBsZXQgYXNzb2NpYXRlZFR5cGVzOiBbU3RyaW5nXT8gPSBIZWxwZXJzLmV4dHJhY3RBc3NvY2lhdGVkVHlwZXMoZnJvbTogYVByb3RvY29sKQogICAgbGV0IGdlbmVyaWNUeXBlc01vZGlmaWVyOiBTdHJpbmcgPSBIZWxwZXJzLmV4dHJhY3RHZW5lcmljVHlwZXNNb2RpZmllcihhc3NvY2lhdGVkVHlwZXMpCiAgICBsZXQgZ2VuZXJpY1R5cGVzQ29uc3RyYWludHM6IFN0cmluZyA9IEhlbHBlcnMuZXh0cmFjdEdlbmVyaWNUeXBlc0NvbnN0cmFpbnRzKGFzc29jaWF0ZWRUeXBlcykKICAgIGxldCBhbGxTdWJzY3JpcHRzID0gYVByb3RvY29sLmFsbFN1YnNjcmlwdHMKICAgIGxldCBhbGxWYXJpYWJsZXMgPSB1bmlxdWVzKHZhcmlhYmxlczogYVByb3RvY29sLmFsbFZhcmlhYmxlcy5maWx0ZXIoeyAhJDAuaXNTdGF0aWMgfSkpCiAgICBsZXQgY29udGFpbnNWYXJpYWJsZXMgPSAhYWxsVmFyaWFibGVzLmlzRW1wdHkKICAgIGxldCBhbGxTdGF0aWNWYXJpYWJsZXMgPSB1bmlxdWVzKHZhcmlhYmxlczogYVByb3RvY29sLmFsbFZhcmlhYmxlcy5maWx0ZXIoeyAkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBjb250YWluc1N0YXRpY1ZhcmlhYmxlcyA9ICFhbGxTdGF0aWNWYXJpYWJsZXMuaXNFbXB0eQogICAgbGV0IGFsbE1ldGhvZHMgPSB1bmlxdWVzKG1ldGhvZHM6IGFQcm90b2NvbC5hbGxNZXRob2RzLmZpbHRlcih7ICEkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBhY2Nlc3NNb2RpZmllcjogU3RyaW5nID0gewogICAgICAgIGxldCBzZWxmQ29uc3RyYWluZWQgPSBhbGxNZXRob2RzLm1hcCh3cmFwTWV0aG9kKS5jb250YWlucyh3aGVyZTogeyAkMC5yZXR1cm5zR2VuZXJpY0NvbnN0cmFpbmVkVG9TZWxmIH0pCiAgICAgICAgcmV0dXJuIHNlbGZDb25zdHJhaW5lZCA/ICJwdWJsaWMgZmluYWwiIDogIm9wZW4iCiAgICB9KCkKICAgIGxldCBhbGxNZXRob2RzRm9yTWV0aG9kVHlwZSA9IHVuaXF1ZXNXaXRob3V0R2VuZXJpY0NvbnN0cmFpbnRzKG1ldGhvZHM6IGFQcm90b2NvbC5hbGxNZXRob2RzLmZpbHRlcih7ICEkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBhbGxTdGF0aWNNZXRob2RzID0gdW5pcXVlcyhtZXRob2RzOiBhUHJvdG9jb2wuYWxsTWV0aG9kcy5maWx0ZXIoeyAkMC5pc1N0YXRpYyB9KSkKICAgIGxldCBhbGxTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSA9IHVuaXF1ZXNXaXRob3V0R2VuZXJpY0NvbnN0cmFpbnRzKG1ldGhvZHM6IGFQcm90b2NvbC5hbGxNZXRob2RzLmZpbHRlcih7ICQwLmlzU3RhdGljIH0pKQogICAgbGV0IGNvbmZvcm1zVG9TdGF0aWNNb2NrID0gIWFsbFN0YXRpY01ldGhvZHMuaXNFbXB0eSB8fCAhYWxsU3RhdGljVmFyaWFibGVzLmlzRW1wdHkKICAgIGxldCBjb25mb3Jtc1RvTW9jayA9ICFhbGxNZXRob2RzLmlzRW1wdHkgfHwgIWFsbFZhcmlhYmxlcy5pc0VtcHR5IC0lPjwlXyAtJT48JV8gLSU+CjwlXyBpZiBhdXRvTW9ja2FibGUgeyAtJT4KLy8gTUFSSzogLSA8JT0gdHlwZS5uYW1lICU+CjwlPSBhY2Nlc3NNb2RpZmllciAlPiBjbGFzcyA8JT0gdHlwZS5uYW1lICU+TW9jazwlPSBnZW5lcmljVHlwZXNNb2RpZmllciAlPjo8JT0gdHlwZS5hbm5vdGF0aW9uc1siT2JqY1Byb3RvY29sIl0gIT0gbmlsID8gIiBOU09iamVjdCwiIDogIiIgJT4gPCU9IHR5cGUubmFtZSAlPiwgTW9jazwlPSBjb25mb3Jtc1RvU3RhdGljTW9jayA/ICIsIFN0YXRpY01vY2siIDogIiIgJT48JT0gZ2VuZXJpY1R5cGVzQ29uc3RyYWludHMgJT4gewogICAgaW5pdChzZXF1ZW5jaW5nIHNlcXVlbmNpbmdQb2xpY3k6IFNlcXVlbmNpbmdQb2xpY3kgPSAubGFzdFdyaXR0ZW5SZXNvbHZlZEZpcnN0LCBzdHViYmluZyBzdHViYmluZ1BvbGljeTogU3R1YmJpbmdQb2xpY3kgPSAud3JhcCwgZmlsZTogU3RhdGljU3RyaW5nID0gI2ZpbGUsIGxpbmU6IFVJbnQgPSAjbGluZSkgewogICAgICAgIFN3aWZ0eU1vY2t5VGVzdE9ic2VydmVyLnNldHVwKCkKICAgICAgICBzZWxmLnNlcXVlbmNpbmdQb2xpY3kgPSBzZXF1ZW5jaW5nUG9saWN5CiAgICAgICAgc2VsZi5zdHViYmluZ1BvbGljeSA9IHN0dWJiaW5nUG9saWN5CiAgICAgICAgc2VsZi5maWxlID0gZmlsZQogICAgICAgIHNlbGYubGluZSA9IGxpbmUKICAgIH0KCjwlXyB9IGVsc2UgeyAtJT4KLy8gc291cmNlcnk6aW5saW5lOmF1dG86PCU9IHR5cGUubmFtZSAlPi5hdXRvTW9ja2VkCjwlXyB9IC0lPgo8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gTUFJTiBDTEFTUyAtJT48JV8gLSU+CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1PQ0sgSU5URVJOQUxTIC0lPjwlXyAtJT4KICAgIHZhciBtYXRjaGVyOiBNYXRjaGVyID0gTWF0Y2hlci5kZWZhdWx0CiAgICB2YXIgc3R1YmJpbmdQb2xpY3k6IFN0dWJiaW5nUG9saWN5ID0gLndyYXAKICAgIHZhciBzZXF1ZW5jaW5nUG9saWN5OiBTZXF1ZW5jaW5nUG9saWN5ID0gLmxhc3RXcml0dGVuUmVzb2x2ZWRGaXJzdAogICAgcHJpdmF0ZSB2YXIgaW52b2NhdGlvbnM6IFtNZXRob2RUeXBlXSA9IFtdCiAgICBwcml2YXRlIHZhciBtZXRob2RSZXR1cm5WYWx1ZXM6IFtHaXZlbl0gPSBbXQogICAgcHJpdmF0ZSB2YXIgbWV0aG9kUGVyZm9ybVZhbHVlczogW1BlcmZvcm1dID0gW10KICAgIHByaXZhdGUgdmFyIGZpbGU6IFN0YXRpY1N0cmluZz8KICAgIHByaXZhdGUgdmFyIGxpbmU6IFVJbnQ/CgogICAgcHVibGljIHR5cGVhbGlhcyBQcm9wZXJ0eVN0dWIgPSBHaXZlbgogICAgcHVibGljIHR5cGVhbGlhcyBNZXRob2RTdHViID0gR2l2ZW4KICAgIHB1YmxpYyB0eXBlYWxpYXMgU3Vic2NyaXB0U3R1YiA9IEdpdmVuCgogICAgLy8vIENvbnZlbmllbmNlIG1ldGhvZCAtIGNhbGwgc2V0dXBNb2NrKCkgdG8gZXh0ZW5kIGRlYnVnIGluZm9ybWF0aW9uIHdoZW4gZmFpbHVyZSBvY2N1cnMKICAgIHB1YmxpYyBmdW5jIHNldHVwTW9jayhmaWxlOiBTdGF0aWNTdHJpbmcgPSAjZmlsZSwgbGluZTogVUludCA9ICNsaW5lKSB7CiAgICAgICAgc2VsZi5maWxlID0gZmlsZQogICAgICAgIHNlbGYubGluZSA9IGxpbmUKICAgIH0KICAgIDwlXyAtJT4KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU1RBVElDIE1PQ0sgSU5URVJOQUxTIC0lPjwlXyAtJT4KICAgIDwlXyBpZiBjb25mb3Jtc1RvU3RhdGljTW9jayB7IC0lPgogICAgc3RhdGljIHZhciBtYXRjaGVyOiBNYXRjaGVyID0gTWF0Y2hlci5kZWZhdWx0CiAgICBzdGF0aWMgdmFyIHN0dWJiaW5nUG9saWN5OiBTdHViYmluZ1BvbGljeSA9IC53cmFwCiAgICBzdGF0aWMgdmFyIHNlcXVlbmNpbmdQb2xpY3k6IFNlcXVlbmNpbmdQb2xpY3kgPSAubGFzdFdyaXR0ZW5SZXNvbHZlZEZpcnN0CiAgICBzdGF0aWMgcHJpdmF0ZSB2YXIgaW52b2NhdGlvbnM6IFtTdGF0aWNNZXRob2RUeXBlXSA9IFtdCiAgICBzdGF0aWMgcHJpdmF0ZSB2YXIgbWV0aG9kUmV0dXJuVmFsdWVzOiBbU3RhdGljR2l2ZW5dID0gW10KICAgIHN0YXRpYyBwcml2YXRlIHZhciBtZXRob2RQZXJmb3JtVmFsdWVzOiBbU3RhdGljUGVyZm9ybV0gPSBbXQogICAgcHVibGljIHR5cGVhbGlhcyBTdGF0aWNQcm9wZXJ0eVN0dWIgPSBTdGF0aWNHaXZlbgogICAgcHVibGljIHR5cGVhbGlhcyBTdGF0aWNNZXRob2RTdHViID0gU3RhdGljR2l2ZW4KICAgIHB1YmxpYyBzdGF0aWMgZnVuYyBjbGVhcigpIHsKICAgICAgICBpbnZvY2F0aW9ucyA9IFtdCiAgICAgICAgbWV0aG9kUmV0dXJuVmFsdWVzID0gW10KICAgICAgICBtZXRob2RQZXJmb3JtVmFsdWVzID0gW10KICAgIH0KICAgIDwlXyAgfSAtJT4KCiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFZBUklBQkxFUyAtJT48JV8gLSU+CiAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IC0lPgogICAgPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgogICAgPCU9IHN0dWJQcm9wZXJ0eSh2YXJpYWJsZSwiXCh0eXBlLm5hbWUpTW9jayIpICU+CiAgICA8JV8gfSBlbHNlIHsgJT4KICAgIDwlPSBzdHViUHJvcGVydHkodmFyaWFibGUsIlwodHlwZS5uYW1lKSIpICU+CiAgICA8JV8gfSAlPgogICAgPCVfIH0gJT4gPCVfIC0lPgoKICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gU1RBVElDIFZBUklBQkxFUyAtJT48JV8gLSU+CiAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IC0lPgogICAgPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgogICAgPCU9IHN0dWJQcm9wZXJ0eSh2YXJpYWJsZSwiXCh0eXBlLm5hbWUpTW9jayIpICU+CiAgICA8JV8gfSBlbHNlIHsgJT4KICAgIDwlPSBzdHViUHJvcGVydHkodmFyaWFibGUsIlwodHlwZS5uYW1lKSIpICU+CiAgICA8JV8gfSAlPgogICAgPCVfIH0gJT4gPCVfIC0lPgoKICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gTUVUSE9EIFJFR0lTVFJBVElPTlMgLSU+PCVfIC0lPgogICAgPCVfIE1ldGhvZFdyYXBwZXIuY2xlYXIoKSAtJT4KICAgIDwlXyBTdWJzY3JpcHRXcmFwcGVyLmNsZWFyKCkgLSU+CiAgICA8JV8gaWYgYXV0b01vY2thYmxlIHsgLSU+CiAgICA8JV8gQ3VycmVudC5zZWxmVHlwZSA9ICJcKHR5cGUubmFtZSlNb2NrXChnZW5lcmljVHlwZXNNb2RpZmllcikiIC0lPgogICAgPCVfIH0gZWxzZSB7ICU+CiAgICA8JV8gQ3VycmVudC5zZWxmVHlwZSA9ICJcKHR5cGUubmFtZSlNb2NrXChnZW5lcmljVHlwZXNNb2RpZmllcikiIC0lPgogICAgPCVfIH0gJT4KICAgIDwlXyBsZXQgd3JhcHBlZFN1YnNjcmlwdHMgPSBhbGxTdWJzY3JpcHRzLm1hcCh3cmFwU3Vic2NyaXB0KSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZE1ldGhvZHMgPSBhbGxNZXRob2RzLm1hcCh3cmFwTWV0aG9kKS5maWx0ZXIoeyAkMC53cmFwcGVkSW5NZXRob2RUeXBlKCkgfSkgLSU+CiAgICA8JV8gbGV0IHdyYXBwZWRWYXJpYWJsZXMgPSBhbGxWYXJpYWJsZXMubWFwKGp1c3RXcmFwKSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlID0gYWxsTWV0aG9kc0Zvck1ldGhvZFR5cGUubWFwKHdyYXBNZXRob2QpLmZpbHRlcih7ICQwLndyYXBwZWRJbk1ldGhvZFR5cGUoKSB9KSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZEluaXRpYWxpemVycyA9IGFsbE1ldGhvZHMubWFwKHdyYXBNZXRob2QpLmZpbHRlcih7ICQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIC0lPgogICAgPCVfIGxldCB3cmFwcGVkU3RhdGljTWV0aG9kcyA9IGFsbFN0YXRpY01ldGhvZHMubWFwKHdyYXBNZXRob2QpLmZpbHRlcih7ICQwLndyYXBwZWRJbk1ldGhvZFR5cGUoKSB9KSAtJT4KICAgIDwlXyBsZXQgd3JhcHBlZFN0YXRpY1ZhcmlhYmxlcyA9IGFsbFN0YXRpY1ZhcmlhYmxlcy5tYXAoanVzdFdyYXApIC0lPgogICAgPCVfIGxldCB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgPSBhbGxTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZS5tYXAod3JhcE1ldGhvZCkuZmlsdGVyKHsgJDAud3JhcHBlZEluTWV0aG9kVHlwZSgpIH0pIC0lPgogICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyBwcm9wZXJ0eVJlZ2lzdGVyKHZhcmlhYmxlKSB9IC0lPgogICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyBwcm9wZXJ0eVJlZ2lzdGVyKHZhcmlhYmxlKSB9IC0lPgogICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHMgeyBtZXRob2QucmVnaXN0ZXIoKSB9IC0lPgogICAgPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgd3JhcHBlZC5yZWdpc3RlcigpIH0gLSU+CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kcyB7IG1ldGhvZC5yZWdpc3RlcigpIH0gLSU+PCVfIC0lPgogICAgPCVfIGxldCB2YXJpYWJsZUNhc2VzQ291bnQ6IEludCA9IHdyYXBwZWRWYXJpYWJsZXMucmVkdWNlKDApIHsgcmV0dXJuICQwICsgJDEuY2FzZXNDb3VudCB9IC0lPjwlXyAtJT4KICAgIDwlXyBsZXQgc3Vic2NyaXB0c0Nhc2VzQ291bnQ6IEludCA9IHdyYXBwZWRTdWJzY3JpcHRzLnJlZHVjZSgwKSB7IHJldHVybiAkMCArICQxLmNhc2VzQ291bnQgfSAtJT48JV8gLSU+CiAgICA8JV8gbGV0IHN0YXRpY1ZhcmlhYmxlQ2FzZXNDb3VudDogSW50ID0gd3JhcHBlZFN0YXRpY1ZhcmlhYmxlcy5yZWR1Y2UoMCkgeyByZXR1cm4gJDAgKyAkMS5jYXNlc0NvdW50IH0gLSU+PCVfIC0lPgogICAgPCVfIGxldCBnZW5lcmF0ZU9sZEFjY2Vzc29yc0Zvck1ldGhvZHM6IEJvb2wgPSBmYWxzZSAtJT48JV8gLSU+CiAgICA8JV8gbGV0IGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yU3RhdGljTWV0aG9kczogQm9vbCA9IGZhbHNlIC0lPjwlXyAtJT4KCiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNUQVRJQyBTVFVCUyAtJT48JV8gLSU+CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kcyB7IC0lPgogICAgPCU9IG1ldGhvZC5mdW5jdGlvblByb3RvdHlwZSBfJT4gewogICAgICAgIDwlPSBtZXRob2Quc3R1YkJvZHkoKSBfJT4KICAgIH0KCiAgICA8JV8gfSAlPjwlXyAtJT4KICAgIDwlXyAtJT4KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gSU5JVElBTElaRVJTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRJbml0aWFsaXplcnMgeyAtJT4KICAgIDwlPSBtZXRob2QuZnVuY3Rpb25Qcm90b3R5cGUgXyU+IHsgfQoKICAgIDwlXyB9IC0lPjwlXyAtJT4KICAgIDwlXyAtJT48JV8gLSU+CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNUVUJTIC0lPjwlXyAtJT4KICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzIHsgLSU+CiAgICA8JT0gbWV0aG9kLmZ1bmN0aW9uUHJvdG90eXBlIF8lPiB7CiAgICAgICAgPCU9IG1ldGhvZC5zdHViQm9keSgpIF8lPgogICAgfQoKICAgIDwlXyB9IC0lPgogICAgPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgLSU+CiAgICA8JT0gd3JhcHBlZC5zdWJzY3JpcHRDYWxsKCkgXyU+CgogICAgPCVfIH0gLSU+CiAgPCUjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IFNUQVRJQyBNRVRIT0QgVFlQRSAtJT48JV8gLSU+CiAgICA8JV8gaWYgY29uZm9ybXNUb1N0YXRpY01vY2sgeyAtJT4KICAgIGZpbGVwcml2YXRlIGVudW0gU3RhdGljTWV0aG9kVHlwZSB7CiAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAtJT4KICAgICAgICBjYXNlIDwlPSBtZXRob2QubWV0aG9kVHlwZURlY2xhcmF0aW9uV2l0aFBhcmFtZXRlcnMoKSBfJT4KICAgIDwlXyAgfSAlPiA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IC0lPgogICAgICAgIDwlPSBwcm9wZXJ0eU1ldGhvZFR5cGVzKHZhcmlhYmxlKSAlPgogICAgPCVfIH0gJT4gPCVfICU+CiAgICA8JV8gLSU+CiAgICAgICAgc3RhdGljIGZ1bmMgY29tcGFyZVBhcmFtZXRlcnMobGhzOiBTdGF0aWNNZXRob2RUeXBlLCByaHM6IFN0YXRpY01ldGhvZFR5cGUsIG1hdGNoZXI6IE1hdGNoZXIpIC0+IEJvb2wgewogICAgICAgICAgICBzd2l0Y2ggKGxocywgcmhzKSB7IDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSB7ICU+CiAgICAgICAgICAgIDwlPSBtZXRob2QuZXF1YWxDYXNlIC0lPjwlIGZvciBwYXJhbWV0ZXIgaW4gbWV0aG9kLnBhcmFtZXRlcnMgeyAlPgogICAgICAgICAgICAgICAgPCU9IHBhcmFtZXRlci5jb21wYXJhdG9yIC0lPiA8JSAgfSAlPgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWUgPCUgfSAlPgogICAgICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IC0lPgogICAgICAgICAgICA8JT0gcHJvcGVydHlNZXRob2RUeXBlc0NvbXBhcmUodmFyaWFibGUpICU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPiA8JV8gaWYgd3JhcHBlZFN0YXRpY01ldGhvZHMuY291bnQgKyBzdGF0aWNWYXJpYWJsZUNhc2VzQ291bnQgPiAxIHsgLSU+CiAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZQogICAgICAgICAgICA8JV8gfSAtJT4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIDwlXyAlPgogICAgICAgIGZ1bmMgaW50VmFsdWUoKSAtPiBJbnQgewogICAgICAgICAgICBzd2l0Y2ggc2VsZiB7IDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZSB7ICU+CiAgICAgICAgICAgICAgICA8JT0gbWV0aG9kLmludFZhbHVlQ2FzZSAtJT48JSB9ICU+CiAgICAgICAgICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IC0lPgogICAgICAgICAgICAgICAgPCU9IHByb3BlcnR5TWV0aG9kVHlwZXNJbnRWYWx1ZSh2YXJpYWJsZSkgJT4KICAgICAgICAgICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBvcGVuIGNsYXNzIFN0YXRpY0dpdmVuOiBTdHViYmVkTWV0aG9kIHsKICAgICAgICBmaWxlcHJpdmF0ZSB2YXIgbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlCgogICAgICAgIHByaXZhdGUgaW5pdChtZXRob2Q6IFN0YXRpY01ldGhvZFR5cGUsIHByb2R1Y3RzOiBbU3R1YlByb2R1Y3RdKSB7CiAgICAgICAgICAgIHNlbGYubWV0aG9kID0gbWV0aG9kCiAgICAgICAgICAgIHN1cGVyLmluaXQocHJvZHVjdHMpCiAgICAgICAgfQoKICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFN0YXRpY1ZhcmlhYmxlcyB7IC0lPgogICAgICAgIDwlPSB3cmFwUHJvcGVydHkodmFyaWFibGUpLmdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7CiAgICAgICAgICAgIDwlPSB3cmFwUHJvcGVydHkodmFyaWFibGUpLmdpdmVuQ29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9ICU+IDwlXyAlPgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRTdGF0aWNNZXRob2RzRm9yTWV0aG9kVHlwZS5maWx0ZXIoeyAhJDAubWV0aG9kLnJldHVyblR5cGVOYW1lLmlzVm9pZCAmJiAhJDAubWV0aG9kLmlzSW5pdGlhbGl6ZXIgfSkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yU3RhdGljTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICJTdGF0aWMiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlLmZpbHRlcih7ICEkMC5tZXRob2QudGhyb3dzICYmICEkMC5tZXRob2QucmV0aHJvd3MgJiYgISQwLm1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgJiYgISQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIikgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlLmZpbHRlcih7ICgkMC5tZXRob2QudGhyb3dzIHx8ICQwLm1ldGhvZC5yZXRocm93cykgJiYgISQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZVRocm93cyhwcmVmaXg6ICJTdGF0aWMiKSAtJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JUaHJvd3MocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0ZvclN0YXRpY01ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3Rvck5hbWVUaHJvd3MocHJlZml4OiAiU3RhdGljIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JUaHJvd3MocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JOYW1lVGhyb3dzKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JUaHJvd3MocHJlZml4OiAiU3RhdGljIikgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9ICU+IDwlXyAtJT4KICAgIH0KCiAgICBwdWJsaWMgc3RydWN0IFN0YXRpY1ZlcmlmeSB7CiAgICAgICAgZmlsZXByaXZhdGUgdmFyIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZQoKICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkU3RhdGljTWV0aG9kc0Zvck1ldGhvZFR5cGUgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3JOYW1lKHByZWZpeDogIlN0YXRpYyIpIC0lPiB7IDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4gfQogICAgICAgIDwlXyBpZiBnZW5lcmF0ZU9sZEFjY2Vzc29yc0ZvclN0YXRpY01ldGhvZHMsIG1ldGhvZC5jb250YWluc0VtcHR5QXJndW1lbnRMYWJlbHMoKSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4geyA8JT0gbWV0aG9kLnZlcmlmaWNhdGlvblByb3h5Q29uc3RydWN0b3IocHJlZml4OiAiU3RhdGljIikgXyU+IH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxTdGF0aWNWYXJpYWJsZXMgeyAtJT4KICAgICAgICA8JT0gcHJvcGVydHlUeXBlcyh2YXJpYWJsZSkgJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICB9CgogICAgcHVibGljIHN0cnVjdCBTdGF0aWNQZXJmb3JtIHsKICAgICAgICBmaWxlcHJpdmF0ZSB2YXIgbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlCiAgICAgICAgdmFyIHBlcmZvcm1zOiBBbnkKCiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZFN0YXRpY01ldGhvZHNGb3JNZXRob2RUeXBlIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIikgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3RvcihwcmVmaXg6ICJTdGF0aWMiKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yU3RhdGljTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3Rvck5hbWUocHJlZml4OiAiU3RhdGljIiwgZGVwcmVjYXRlZDogdHJ1ZSkgJT4gewogICAgICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yKHByZWZpeDogIlN0YXRpYyIpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICB9CgogICAgPCUgfSAtJT4KICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gTUVUSE9EIFRZUEUgLSU+PCVfIC0lPgogICAgPCVfIGlmICF3cmFwcGVkTWV0aG9kcy5pc0VtcHR5IHx8ICFhbGxWYXJpYWJsZXMuaXNFbXB0eSB8fCAhYWxsU3Vic2NyaXB0cy5pc0VtcHR5IHsgLSU+CgogICAgZmlsZXByaXZhdGUgZW51bSBNZXRob2RUeXBlIHsKICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZSB7IC0lPgogICAgICAgIGNhc2UgPCU9IG1ldGhvZC5tZXRob2RUeXBlRGVjbGFyYXRpb25XaXRoUGFyYW1ldGVycygpIF8lPgogICAgPCVfICB9IC0lPiA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IC0lPgogICAgICAgIDwlPSBwcm9wZXJ0eU1ldGhvZFR5cGVzKHZhcmlhYmxlKSAlPgogICAgPCVfIH0gJT4gPCVfICU+IDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IC0lPgogICAgICAgIDwlPSB3cmFwcGVkLnN1YnNjcmlwdENhc2VzKCkgXyU+CiAgICA8JV8gfSAlPiA8JV8gJT4KICAgIDwlXyAtJT4KICAgICAgICBzdGF0aWMgZnVuYyBjb21wYXJlUGFyYW1ldGVycyhsaHM6IE1ldGhvZFR5cGUsIHJoczogTWV0aG9kVHlwZSwgbWF0Y2hlcjogTWF0Y2hlcikgLT4gQm9vbCB7CiAgICAgICAgICAgIHN3aXRjaCAobGhzLCByaHMpIHsgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlIHsgJT4KICAgICAgICAgICAgPCU9IG1ldGhvZC5lcXVhbENhc2UgLSU+PCUgZm9yIHBhcmFtZXRlciBpbiBtZXRob2QucGFyYW1ldGVycyB7ICU+CiAgICAgICAgICAgICAgICA8JT0gcGFyYW1ldGVyLmNvbXBhcmF0b3IgLSU+IDwlICB9ICU+CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZSA8JSB9ICU+CiAgICAgICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgLSU+CiAgICAgICAgICAgIDwlPSBwcm9wZXJ0eU1ldGhvZFR5cGVzQ29tcGFyZSh2YXJpYWJsZSkgJT4KICAgICAgICAgICAgPCVfIH0gJT4gPCVfIC0lPiA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyAtJT4KICAgICAgICAgICAgPCU9IHdyYXBwZWQuZXF1YWxDYXNlcygpICU+CiAgICAgICAgPCVfIH0gJT4gPCVfIGlmIHdyYXBwZWRNZXRob2RzLmNvdW50ICsgdmFyaWFibGVDYXNlc0NvdW50ICsgc3Vic2NyaXB0c0Nhc2VzQ291bnQgPiAxIHsgLSU+CiAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBmYWxzZQogICAgICAgICAgICA8JV8gfSAtJT4KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIDwlXyAlPgogICAgICAgIGZ1bmMgaW50VmFsdWUoKSAtPiBJbnQgewogICAgICAgICAgICBzd2l0Y2ggc2VsZiB7IDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZSB7ICU+CiAgICAgICAgICAgIDwlPSBtZXRob2QuaW50VmFsdWVDYXNlIC0lPjwlIH0gJT4KICAgICAgICAgICAgPCVfIGZvciB2YXJpYWJsZSBpbiBhbGxWYXJpYWJsZXMgeyAtJT4KICAgICAgICAgICAgPCU9IHByb3BlcnR5TWV0aG9kVHlwZXNJbnRWYWx1ZSh2YXJpYWJsZSkgJT4KICAgICAgICAgICAgPCVfIH0gJT4gPCVfIGZvciB3cmFwcGVkIGluIHdyYXBwZWRTdWJzY3JpcHRzIHsgLSU+CiAgICAgICAgICAgIDwlPSB3cmFwcGVkLmludFZhbHVlQ2FzZSgpICU+CiAgICAgICAgICAgIDwlXyB9IC0lPgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgPCVfIH0gZWxzZSB7ICU+CiAgICBmaWxlcHJpdmF0ZSBzdHJ1Y3QgTWV0aG9kVHlwZSB7CiAgICAgICAgc3RhdGljIGZ1bmMgY29tcGFyZVBhcmFtZXRlcnMobGhzOiBNZXRob2RUeXBlLCByaHM6IE1ldGhvZFR5cGUsIG1hdGNoZXI6IE1hdGNoZXIpIC0+IEJvb2wgeyByZXR1cm4gdHJ1ZSB9CiAgICAgICAgZnVuYyBpbnRWYWx1ZSgpIC0+IEludCB7IHJldHVybiAwIH0KICAgIH0KICAgIDwlXyB9IC0lPjwlXyAtJT4KCiAgICBvcGVuIGNsYXNzIEdpdmVuOiBTdHViYmVkTWV0aG9kIHsKICAgICAgICBmaWxlcHJpdmF0ZSB2YXIgbWV0aG9kOiBNZXRob2RUeXBlCgogICAgICAgIHByaXZhdGUgaW5pdChtZXRob2Q6IE1ldGhvZFR5cGUsIHByb2R1Y3RzOiBbU3R1YlByb2R1Y3RdKSB7CiAgICAgICAgICAgIHNlbGYubWV0aG9kID0gbWV0aG9kCiAgICAgICAgICAgIHN1cGVyLmluaXQocHJvZHVjdHMpCiAgICAgICAgfQoKICAgICAgICA8JV8gZm9yIHZhcmlhYmxlIGluIGFsbFZhcmlhYmxlcyB7IC0lPgogICAgICAgIDwlPSB3cmFwUHJvcGVydHkodmFyaWFibGUpLmdpdmVuQ29uc3RydWN0b3JOYW1lKCkgLSU+IHsKICAgICAgICAgICAgPCU9IHdyYXBQcm9wZXJ0eSh2YXJpYWJsZSkuZ2l2ZW5Db25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAlPiA8JV8gJT4KICAgICAgICA8JV8gZm9yIG1ldGhvZCBpbiB3cmFwcGVkTWV0aG9kc0Zvck1ldGhvZFR5cGUuZmlsdGVyKHsgISQwLm1ldGhvZC5yZXR1cm5UeXBlTmFtZS5pc1ZvaWQgJiYgISQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lKHByZWZpeDogIiIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZS5maWx0ZXIoeyAhJDAubWV0aG9kLnRocm93cyAmJiAhJDAubWV0aG9kLnJldGhyb3dzICYmICEkMC5tZXRob2QucmV0dXJuVHlwZU5hbWUuaXNWb2lkICYmICEkMC5tZXRob2QuaXNJbml0aWFsaXplciB9KSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JOYW1lKCkgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAtJT4KICAgICAgICA8JV8gZm9yIHdyYXBwZWQgaW4gd3JhcHBlZFN1YnNjcmlwdHMgeyAtJT4KICAgICAgICA8JT0gd3JhcHBlZC5naXZlbkNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7CiAgICAgICAgICAgIDwlPSB3cmFwcGVkLmdpdmVuQ29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlLmZpbHRlcih7ICgkMC5tZXRob2QudGhyb3dzIHx8ICQwLm1ldGhvZC5yZXRocm93cykgJiYgISQwLm1ldGhvZC5pc0luaXRpYWxpemVyIH0pIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yTmFtZVRocm93cygpIC0lPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Db25zdHJ1Y3RvclRocm93cygpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLmdpdmVuQ29uc3RydWN0b3JOYW1lVGhyb3dzKHByZWZpeDogIiIsIGRlcHJlY2F0ZWQ6IHRydWUpICU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlbkNvbnN0cnVjdG9yVGhyb3dzKCkgXyU+CiAgICAgICAgfQogICAgICAgIDwlXyB9IC0lPgogICAgICAgIDwlPSBtZXRob2QuZ2l2ZW5Qcm9kdWNlQ29uc3RydWN0b3JOYW1lVGhyb3dzKCkgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5naXZlblByb2R1Y2VDb25zdHJ1Y3RvclRocm93cygpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gfSAlPiA8JV8gLSU+CiAgICB9CgogICAgcHVibGljIHN0cnVjdCBWZXJpZnkgewogICAgICAgIGZpbGVwcml2YXRlIHZhciBtZXRob2Q6IE1ldGhvZFR5cGUKCiAgICAgICAgPCVfIGZvciBtZXRob2QgaW4gd3JhcHBlZE1ldGhvZHNGb3JNZXRob2RUeXBlIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7IDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3RvcigpIF8lPiB9CiAgICAgICAgPCVfIGlmIGdlbmVyYXRlT2xkQWNjZXNzb3JzRm9yTWV0aG9kcywgbWV0aG9kLmNvbnRhaW5zRW1wdHlBcmd1bWVudExhYmVscygpIHsgLSU+CiAgICAgICAgPCU9IG1ldGhvZC52ZXJpZmljYXRpb25Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7IDwlPSBtZXRob2QudmVyaWZpY2F0aW9uUHJveHlDb25zdHJ1Y3RvcigpIF8lPiB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgICAgIDwlXyBmb3IgdmFyaWFibGUgaW4gYWxsVmFyaWFibGVzIHsgLSU+CiAgICAgICAgPCU9IHByb3BlcnR5VHlwZXModmFyaWFibGUpICU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgICAgIDwlXyBmb3Igd3JhcHBlZCBpbiB3cmFwcGVkU3Vic2NyaXB0cyB7IC0lPgogICAgICAgIDwlPSB3cmFwcGVkLnZlcmlmeUNvbnN0cnVjdG9yTmFtZSgpIC0lPiB7IDwlPSB3cmFwcGVkLnZlcmlmeUNvbnN0cnVjdG9yKCkgXyU+IH0KICAgICAgICA8JV8gaWYgIXdyYXBwZWQucmVhZG9ubHkgeyAtJT4KICAgICAgICA8JT0gd3JhcHBlZC52ZXJpZnlDb25zdHJ1Y3Rvck5hbWUoc2V0OiB0cnVlKSAtJT4geyA8JT0gd3JhcHBlZC52ZXJpZnlDb25zdHJ1Y3RvcihzZXQ6IHRydWUpIF8lPiB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgfQoKICAgIHB1YmxpYyBzdHJ1Y3QgUGVyZm9ybSB7CiAgICAgICAgZmlsZXByaXZhdGUgdmFyIG1ldGhvZDogTWV0aG9kVHlwZQogICAgICAgIHZhciBwZXJmb3JtczogQW55CgogICAgICAgIDwlXyBmb3IgbWV0aG9kIGluIHdyYXBwZWRNZXRob2RzRm9yTWV0aG9kVHlwZSB7IC0lPgogICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3JOYW1lKCkgLSU+IHsKICAgICAgICAgICAgPCU9IG1ldGhvZC5wZXJmb3JtUHJveHlDb25zdHJ1Y3RvcigpIF8lPgogICAgICAgIH0KICAgICAgICA8JV8gaWYgZ2VuZXJhdGVPbGRBY2Nlc3NvcnNGb3JNZXRob2RzLCBtZXRob2QuY29udGFpbnNFbXB0eUFyZ3VtZW50TGFiZWxzKCkgeyAtJT4KICAgICAgICA8JT0gbWV0aG9kLnBlcmZvcm1Qcm94eUNvbnN0cnVjdG9yTmFtZShwcmVmaXg6ICIiLCBkZXByZWNhdGVkOiB0cnVlKSAlPiB7CiAgICAgICAgICAgIDwlPSBtZXRob2QucGVyZm9ybVByb3h5Q29uc3RydWN0b3IoKSBfJT4KICAgICAgICB9CiAgICAgICAgPCVfIH0gLSU+CiAgICAgICAgPCVfIH0gJT4gPCVfIC0lPgogICAgfQoKICA8JSMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gTU9DSyBNRVRIT0RTIC0lPjwlXyAtJT4KICAgIHB1YmxpYyBmdW5jIGdpdmVuKF8gbWV0aG9kOiBHaXZlbikgewogICAgICAgIG1ldGhvZFJldHVyblZhbHVlcy5hcHBlbmQobWV0aG9kKQogICAgfQoKICAgIHB1YmxpYyBmdW5jIHBlcmZvcm0oXyBtZXRob2Q6IFBlcmZvcm0pIHsKICAgICAgICBtZXRob2RQZXJmb3JtVmFsdWVzLmFwcGVuZChtZXRob2QpCiAgICAgICAgbWV0aG9kUGVyZm9ybVZhbHVlcy5zb3J0IHsgJDAubWV0aG9kLmludFZhbHVlKCkgPCAkMS5tZXRob2QuaW50VmFsdWUoKSB9CiAgICB9CgogICAgcHVibGljIGZ1bmMgdmVyaWZ5KF8gbWV0aG9kOiBWZXJpZnksIGNvdW50OiBDb3VudCA9IENvdW50Lm1vcmVPckVxdWFsKHRvOiAxKSwgZmlsZTogU3RhdGljU3RyaW5nID0gI2ZpbGUsIGxpbmU6IFVJbnQgPSAjbGluZSkgewogICAgICAgIGxldCBpbnZvY2F0aW9ucyA9IG1hdGNoaW5nQ2FsbHMobWV0aG9kLm1ldGhvZCkKICAgICAgICBNb2NreUFzc2VydChjb3VudC5tYXRjaGVzKGludm9jYXRpb25zLmNvdW50KSwgIkV4cGVjdGVkOiBcKGNvdW50KSBpbnZvY2F0aW9ucyBvZiBgXChtZXRob2QubWV0aG9kKWAsIGJ1dCB3YXM6IFwoaW52b2NhdGlvbnMuY291bnQpIiwgZmlsZTogZmlsZSwgbGluZTogbGluZSkKICAgIH0KCiAgICBwcml2YXRlIGZ1bmMgYWRkSW52b2NhdGlvbihfIGNhbGw6IE1ldGhvZFR5cGUpIHsKICAgICAgICBpbnZvY2F0aW9ucy5hcHBlbmQoY2FsbCkKICAgIH0KICAgIHByaXZhdGUgZnVuYyBtZXRob2RSZXR1cm5WYWx1ZShfIG1ldGhvZDogTWV0aG9kVHlwZSkgdGhyb3dzIC0+IFN0dWJQcm9kdWN0IHsKICAgICAgICBsZXQgY2FuZGlkYXRlcyA9IHNlcXVlbmNpbmdQb2xpY3kuc29ydGVkKG1ldGhvZFJldHVyblZhbHVlcywgYnk6IHsgJDAubWV0aG9kLmludFZhbHVlKCkgPiAkMS5tZXRob2QuaW50VmFsdWUoKSB9KQogICAgICAgIGxldCBtYXRjaGVkID0gY2FuZGlkYXRlcy5maXJzdCh3aGVyZTogeyAkMC5pc1ZhbGlkICYmIE1ldGhvZFR5cGUuY29tcGFyZVBhcmFtZXRlcnMobGhzOiAkMC5tZXRob2QsIHJoczogbWV0aG9kLCBtYXRjaGVyOiBtYXRjaGVyKSB9KQogICAgICAgIGd1YXJkIGxldCBwcm9kdWN0ID0gbWF0Y2hlZD8uZ2V0UHJvZHVjdChwb2xpY3k6IHNlbGYuc3R1YmJpbmdQb2xpY3kpIGVsc2UgeyB0aHJvdyBNb2NrRXJyb3Iubm90U3R1YmVkIH0KICAgICAgICByZXR1cm4gcHJvZHVjdAogICAgfQogICAgcHJpdmF0ZSBmdW5jIG1ldGhvZFBlcmZvcm1WYWx1ZShfIG1ldGhvZDogTWV0aG9kVHlwZSkgLT4gQW55PyB7CiAgICAgICAgbGV0IG1hdGNoZWQgPSBtZXRob2RQZXJmb3JtVmFsdWVzLnJldmVyc2VkKCkuZmlyc3QgeyBNZXRob2RUeXBlLmNvbXBhcmVQYXJhbWV0ZXJzKGxoczogJDAubWV0aG9kLCByaHM6IG1ldGhvZCwgbWF0Y2hlcjogbWF0Y2hlcikgfQogICAgICAgIHJldHVybiBtYXRjaGVkPy5wZXJmb3JtcwogICAgfQogICAgcHJpdmF0ZSBmdW5jIG1hdGNoaW5nQ2FsbHMoXyBtZXRob2Q6IE1ldGhvZFR5cGUpIC0+IFtNZXRob2RUeXBlXSB7CiAgICAgICAgcmV0dXJuIGludm9jYXRpb25zLmZpbHRlciB7IE1ldGhvZFR5cGUuY29tcGFyZVBhcmFtZXRlcnMobGhzOiAkMCwgcmhzOiBtZXRob2QsIG1hdGNoZXI6IG1hdGNoZXIpIH0KICAgIH0KICAgIHByaXZhdGUgZnVuYyBtYXRjaGluZ0NhbGxzKF8gbWV0aG9kOiBWZXJpZnkpIC0+IEludCB7CiAgICAgICAgcmV0dXJuIG1hdGNoaW5nQ2FsbHMobWV0aG9kLm1ldGhvZCkuY291bnQKICAgIH0KICAgIHByaXZhdGUgZnVuYyBnaXZlbkdldHRlclZhbHVlPFQ+KF8gbWV0aG9kOiBNZXRob2RUeXBlLCBfIG1lc3NhZ2U6IFN0cmluZykgLT4gVCB7CiAgICAgICAgZG8gewogICAgICAgICAgICByZXR1cm4gdHJ5IG1ldGhvZFJldHVyblZhbHVlKG1ldGhvZCkuY2FzdGVkKCkKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgb25GYXRhbEZhaWx1cmUobWVzc2FnZSkKICAgICAgICAgICAgRmFpbHVyZShtZXNzYWdlKQogICAgICAgIH0KICAgIH0KICAgIHByaXZhdGUgZnVuYyBvcHRpb25hbEdpdmVuR2V0dGVyVmFsdWU8VD4oXyBtZXRob2Q6IE1ldGhvZFR5cGUsIF8gbWVzc2FnZTogU3RyaW5nKSAtPiBUPyB7CiAgICAgICAgZG8gewogICAgICAgICAgICByZXR1cm4gdHJ5IG1ldGhvZFJldHVyblZhbHVlKG1ldGhvZCkuY2FzdGVkKCkKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgcmV0dXJuIG5pbAogICAgICAgIH0KICAgIH0KICAgIHByaXZhdGUgZnVuYyBvbkZhdGFsRmFpbHVyZShfIG1lc3NhZ2U6IFN0cmluZykgewogICAgICAgICNpZiBNb2NreQogICAgICAgIGd1YXJkIGxldCBmaWxlID0gc2VsZi5maWxlLCBsZXQgbGluZSA9IHNlbGYubGluZSBlbHNlIHsgcmV0dXJuIH0gLy8gTGV0IGlmIGZhaWwgaWYgY2Fubm90IGhhbmRsZSBncmF0ZWZ1bGx5CiAgICAgICAgU3dpZnR5TW9ja3lUZXN0T2JzZXJ2ZXIuaGFuZGxlTWlzc2luZ1N0dWJFcnJvcihtZXNzYWdlOiBtZXNzYWdlLCBmaWxlOiBmaWxlLCBsaW5lOiBsaW5lKQogICAgICAgICNlbmRpZgogICAgfQogIDwlIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVEFUSUMgTU9DSyBNRVRIT0RTIC0lPjwlXyAtJT4KICAgIDwlXyBpZiBjb25mb3Jtc1RvU3RhdGljTW9jayB7IC0lPgoKICAgIHN0YXRpYyBwdWJsaWMgZnVuYyBnaXZlbihfIG1ldGhvZDogU3RhdGljR2l2ZW4pIHsKICAgICAgICBtZXRob2RSZXR1cm5WYWx1ZXMuYXBwZW5kKG1ldGhvZCkKICAgIH0KCiAgICBzdGF0aWMgcHVibGljIGZ1bmMgcGVyZm9ybShfIG1ldGhvZDogU3RhdGljUGVyZm9ybSkgewogICAgICAgIG1ldGhvZFBlcmZvcm1WYWx1ZXMuYXBwZW5kKG1ldGhvZCkKICAgICAgICBtZXRob2RQZXJmb3JtVmFsdWVzLnNvcnQgeyAkMC5tZXRob2QuaW50VmFsdWUoKSA8ICQxLm1ldGhvZC5pbnRWYWx1ZSgpIH0KICAgIH0KCiAgICBzdGF0aWMgcHVibGljIGZ1bmMgdmVyaWZ5KF8gbWV0aG9kOiBTdGF0aWNWZXJpZnksIGNvdW50OiBDb3VudCA9IENvdW50Lm1vcmVPckVxdWFsKHRvOiAxKSwgZmlsZTogU3RhdGljU3RyaW5nID0gI2ZpbGUsIGxpbmU6IFVJbnQgPSAjbGluZSkgewogICAgICAgIGxldCBpbnZvY2F0aW9ucyA9IG1hdGNoaW5nQ2FsbHMobWV0aG9kLm1ldGhvZCkKICAgICAgICBNb2NreUFzc2VydChjb3VudC5tYXRjaGVzKGludm9jYXRpb25zLmNvdW50KSwgIkV4cGVjdGVkOiBcKGNvdW50KSBpbnZvY2F0aW9ucyBvZiBgXChtZXRob2QubWV0aG9kKWAsIGJ1dCB3YXM6IFwoaW52b2NhdGlvbnMuY291bnQpIiwgZmlsZTogZmlsZSwgbGluZTogbGluZSkKICAgIH0KCiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIGFkZEludm9jYXRpb24oXyBjYWxsOiBTdGF0aWNNZXRob2RUeXBlKSB7CiAgICAgICAgaW52b2NhdGlvbnMuYXBwZW5kKGNhbGwpCiAgICB9CiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIG1ldGhvZFJldHVyblZhbHVlKF8gbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlKSB0aHJvd3MgLT4gU3R1YlByb2R1Y3QgewogICAgICAgIGxldCBjYW5kaWRhdGVzID0gc2VxdWVuY2luZ1BvbGljeS5zb3J0ZWQobWV0aG9kUmV0dXJuVmFsdWVzLCBieTogeyAkMC5tZXRob2QuaW50VmFsdWUoKSA+ICQxLm1ldGhvZC5pbnRWYWx1ZSgpIH0pCiAgICAgICAgbGV0IG1hdGNoZWQgPSBjYW5kaWRhdGVzLmZpcnN0KHdoZXJlOiB7ICQwLmlzVmFsaWQgJiYgU3RhdGljTWV0aG9kVHlwZS5jb21wYXJlUGFyYW1ldGVycyhsaHM6ICQwLm1ldGhvZCwgcmhzOiBtZXRob2QsIG1hdGNoZXI6IG1hdGNoZXIpIH0pCiAgICAgICAgZ3VhcmQgbGV0IHByb2R1Y3QgPSBtYXRjaGVkPy5nZXRQcm9kdWN0KHBvbGljeTogc2VsZi5zdHViYmluZ1BvbGljeSkgZWxzZSB7IHRocm93IE1vY2tFcnJvci5ub3RTdHViZWQgfQogICAgICAgIHJldHVybiBwcm9kdWN0CiAgICB9CiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIG1ldGhvZFBlcmZvcm1WYWx1ZShfIG1ldGhvZDogU3RhdGljTWV0aG9kVHlwZSkgLT4gQW55PyB7CiAgICAgICAgbGV0IG1hdGNoZWQgPSBtZXRob2RQZXJmb3JtVmFsdWVzLnJldmVyc2VkKCkuZmlyc3QgeyBTdGF0aWNNZXRob2RUeXBlLmNvbXBhcmVQYXJhbWV0ZXJzKGxoczogJDAubWV0aG9kLCByaHM6IG1ldGhvZCwgbWF0Y2hlcjogbWF0Y2hlcikgfQogICAgICAgIHJldHVybiBtYXRjaGVkPy5wZXJmb3JtcwogICAgfQogICAgc3RhdGljIHByaXZhdGUgZnVuYyBtYXRjaGluZ0NhbGxzKF8gbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlKSAtPiBbU3RhdGljTWV0aG9kVHlwZV0gewogICAgICAgIHJldHVybiBpbnZvY2F0aW9ucy5maWx0ZXIgeyBTdGF0aWNNZXRob2RUeXBlLmNvbXBhcmVQYXJhbWV0ZXJzKGxoczogJDAsIHJoczogbWV0aG9kLCBtYXRjaGVyOiBtYXRjaGVyKSB9CiAgICB9CiAgICBzdGF0aWMgcHJpdmF0ZSBmdW5jIG1hdGNoaW5nQ2FsbHMoXyBtZXRob2Q6IFN0YXRpY1ZlcmlmeSkgLT4gSW50IHsKICAgICAgICByZXR1cm4gbWF0Y2hpbmdDYWxscyhtZXRob2QubWV0aG9kKS5jb3VudAogICAgfQogICAgc3RhdGljIHByaXZhdGUgZnVuYyBnaXZlbkdldHRlclZhbHVlPFQ+KF8gbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlLCBfIG1lc3NhZ2U6IFN0cmluZykgLT4gVCB7CiAgICAgICAgZG8gewogICAgICAgICAgICByZXR1cm4gdHJ5IG1ldGhvZFJldHVyblZhbHVlKG1ldGhvZCkuY2FzdGVkKCkKICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgRmFpbHVyZShtZXNzYWdlKQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBwcml2YXRlIGZ1bmMgb3B0aW9uYWxHaXZlbkdldHRlclZhbHVlPFQ+KF8gbWV0aG9kOiBTdGF0aWNNZXRob2RUeXBlLCBfIG1lc3NhZ2U6IFN0cmluZykgLT4gVD8gewogICAgICAgIGRvIHsKICAgICAgICAgICAgcmV0dXJuIHRyeSBtZXRob2RSZXR1cm5WYWx1ZShtZXRob2QpLmNhc3RlZCgpCiAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgIHJldHVybiBuaWwKICAgICAgICB9CiAgICB9CiAgICA8JV8gfSAtJT4KPCVfIGlmIGF1dG9Nb2NrYWJsZSB7IC0lPgp9Cgo8JV8gfSBlbHNlIHsgLSU+Ci8vIHNvdXJjZXJ5OmVuZAo8JV8gfSAtJT4KPCUgfSAtJT4K"
    )
}
